# 🔍 PQ-Tor 完整环境检测使用指南

**脚本**: `check_full_environment.sh`
**创建时间**: 2025-11-06
**版本**: 2.0（含Web前端检测）

---

## 📋 检测内容概览

### 20项全面检查

#### 第一部分：基础系统环境（5项）
1. ✅ CPU架构（x86_64/ARM64）
2. ✅ 操作系统（Ubuntu/Debian）
3. ✅ GCC编译器（>= 7.x）
4. ✅ Make工具
5. ✅ CMake工具

#### 第二部分：PQ-Tor核心依赖（4项）
6. ✅ OpenSSL库和开发包
7. ✅ liboqs库（Kyber KEM）
8. ✅ pthread库
9. ✅ PQ-Tor可执行文件

#### 第三部分：SAGIN实验环境（3项）
10. ✅ tc工具（流量控制）
11. ⚠️ sudo权限
12. ✅ SAGIN实验脚本

#### 第四部分：Web前端环境（8项）🆕
13. ✅ Python3（>= 3.7）
14. ✅ pip3包管理器
15. ✅ Flask框架
16. ✅ pandas数据处理库
17. ✅ flask-cors跨域支持
18. ✅ Web Dashboard文件
19. ⚠️ 浏览器（chromium/firefox）
20. ⚠️ 端口8080可用性

---

## 🚀 使用方法

### 快速检测

```bash
# 运行完整检测
/home/ccc/pq-ntor-experiment/check_full_environment.sh
```

### 保存检测报告

```bash
# 生成检测报告文件
./check_full_environment.sh > environment_report.txt 2>&1

# 查看报告
cat environment_report.txt
```

### 只查看失败项

```bash
# 过滤出失败和警告项
./check_full_environment.sh 2>&1 | grep -E "❌|⚠️"
```

---

## 📊 检测结果说明

### 状态标识

- ✅ **通过** (绿色) - 该项检查完全通过
- ❌ **失败** (红色) - 该项检查失败，需要安装或修复
- ⚠️ **警告** (黄色) - 该项有问题但不致命，建议修复

### 实际检测示例

```
[15/20] 检查Flask...
      Flask版本: 3.1.2
      ✅ Flask已安装

[19/20] 检查浏览器...
      ⚠️  未找到浏览器
      → 建议: 安装: sudo apt-get install chromium-browser
```

---

## 🔧 常见问题修复

### 问题1: Flask未安装

**症状**:
```
[15/20] 检查Flask...
      ❌ Flask未安装
      → 安装方法: pip3 install flask
```

**解决**:
```bash
pip3 install flask flask-cors pandas
```

### 问题2: liboqs未找到

**症状**:
```
[7/20] 检查liboqs...
      ⚠️  liboqs未找到
      → 需要编译安装
```

**解决**:
```bash
# 克隆liboqs
git clone https://github.com/open-quantum-safe/liboqs.git
cd liboqs

# 编译安装
mkdir build && cd build
cmake -DCMAKE_INSTALL_PREFIX=$HOME/_oqs ..
make -j$(nproc)
make install
```

### 问题3: PQ-Tor未编译

**症状**:
```
[9/20] 检查PQ-Tor可执行文件...
      ⚠️  PQ-Tor未编译
```

**解决**:
```bash
cd /home/ccc/pq-ntor-experiment/c
make all
```

### 问题4: 端口8080被占用

**症状**:
```
[20/20] 检查端口8080可用性...
      ⚠️  端口8080已被占用
```

**解决**:
```bash
# 查看占用进程
sudo lsof -i :8080

# 停止占用进程
pkill -f server.py

# 或者使用其他端口
# 编辑 web-dashboard/api/server.py
# 修改端口号为 8081
```

### 问题5: sudo权限问题（WSL环境）

**症状**:
```
[11/20] 检查sudo权限...
      ❌ sudo权限不可用
```

**说明**: WSL环境中这是正常的，运行SAGIN实验时手动输入密码即可

---

## 📈 检测结果统计

### 完美环境示例

```
╔════════════════════════════════════════════════════════════╗
║                    检查完成！                              ║
╚════════════════════════════════════════════════════════════╝

检查统计：
  总检查项数: 20
  ✅ 通过: 20
  ❌ 失败: 0
  ⚠️  警告: 0

  通过率: 100.0%

🎉 恭喜！所有检查项都通过！

✅ PQ-Tor核心系统可用
✅ SAGIN实验环境就绪
✅ Web前端系统可用
```

### 典型WSL环境

```
检查统计：
  总检查项数: 20
  ✅ 通过: 17
  ❌ 失败: 1
  ⚠️  警告: 2

  通过率: 85.0%

主要问题：
- sudo权限（WSL正常现象）
- 浏览器未安装（可选）
- 端口被占用（可解决）
```

---

## 🎯 不同场景的检测重点

### 场景1: PQ-Tor开发环境

**关键检查项**:
- [1-5] 基础系统环境 ✅
- [6-9] PQ-Tor核心依赖 ✅

**最小要求**: 前9项全部通过

### 场景2: SAGIN实验环境

**关键检查项**:
- [1-9] 基础+PQ-Tor ✅
- [10-12] SAGIN实验工具 ✅

**最小要求**: 前12项全部通过

### 场景3: Web演示系统

**关键检查项**:
- [1-9] 基础+PQ-Tor ✅
- [13-20] Web前端环境 ✅

**最小要求**: 1-9项 + 13-18项通过

### 场景4: 完整系统（推荐）

**关键检查项**: 全部20项

**最小要求**: 至少18项通过（90%）

---

## 🔄 检测流程集成

### 1. 新环境初次部署

```bash
# Step 1: 运行检测
./check_full_environment.sh > check_result.txt 2>&1

# Step 2: 查看失败项
grep "❌" check_result.txt

# Step 3: 安装缺失依赖
# 根据提示安装

# Step 4: 再次检测验证
./check_full_environment.sh
```

### 2. 定期环境验证

```bash
# 每周运行一次检测，确保环境一致
cd /home/ccc/pq-ntor-experiment
./check_full_environment.sh | tee env_check_$(date +%Y%m%d).log
```

### 3. 持续集成（CI）

```bash
# 在CI脚本中集成检测
#!/bin/bash
./check_full_environment.sh
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "Environment check failed!"
    exit 1
fi

# 继续构建和测试...
```

---

## 📝 检测报告模板

### 用于文档/报告

```markdown
## 实验环境配置

| 检查项 | 状态 | 版本/说明 |
|--------|------|----------|
| 操作系统 | ✅ | Ubuntu 22.04 LTS |
| GCC | ✅ | 11.4.0 |
| Python3 | ✅ | 3.10.12 |
| Flask | ✅ | 3.1.2 |
| liboqs | ✅ | 已安装 |
| PQ-Tor | ✅ | 已编译 |
| Web Dashboard | ✅ | 就绪 |

**环境检测通过率**: 85.0% (17/20)
**最后检测时间**: 2025-11-06
```

---

## 🆚 与旧版本对比

### v1.0（deployment/check_env.sh）

- **检查项**: 8项
- **范围**: 仅基础系统环境
- **目标**: 飞腾派部署前检测

### v2.0（check_full_environment.sh）🆕

- **检查项**: 20项
- **范围**: 基础系统 + PQ-Tor + SAGIN + Web前端
- **目标**: 完整系统环境验证
- **新增**:
  - [7] liboqs库检测
  - [9] PQ-Tor可执行文件检测
  - [10-12] SAGIN实验环境（3项）
  - [13-20] Web前端环境（8项）

---

## ✅ 检查清单

### 部署前检查

- [ ] 运行环境检测脚本
- [ ] 通过率 >= 80%
- [ ] 所有❌失败项已修复
- [ ] Web前端依赖已安装
- [ ] 浏览器已安装（可选）
- [ ] 端口8080可用

### 使用前验证

- [ ] PQ-Tor编译成功
- [ ] SAGIN脚本可执行
- [ ] Web服务可启动
- [ ] 浏览器可访问界面

---

## 📞 帮助信息

### 查看脚本源码

```bash
cat /home/ccc/pq-ntor-experiment/check_full_environment.sh
```

### 调试模式

```bash
# 显示详细执行过程
bash -x ./check_full_environment.sh
```

### 自定义检测

如需添加新的检测项，编辑脚本并参考现有检测项格式：

```bash
# 检测模板
((TOTAL_CHECKS++))
echo "[X/20] 检查XXXX..."
if command -v xxx &> /dev/null; then
    check_pass "XXX已安装"
else
    check_fail "XXX未安装" "安装方法"
fi
echo ""
```

---

## 🎉 总结

### 主要优势

1. ✅ **全面检测** - 覆盖4大模块，20项检查
2. ✅ **清晰输出** - 颜色标识，易于识别
3. ✅ **自动建议** - 失败项提供安装方法
4. ✅ **统计报告** - 通过率、检查统计
5. ✅ **不中断** - 完成所有检查再报告

### 使用场景

- 🏗️ 新环境初始化
- 🔄 定期环境验证
- 📦 部署前检查
- 🐛 问题排查
- 📝 环境记录

### 下一步

**立即运行**:
```bash
cd /home/ccc/pq-ntor-experiment
./check_full_environment.sh
```

**保存结果**:
```bash
./check_full_environment.sh > env_check_$(date +%Y%m%d).txt 2>&1
```

---

**创建时间**: 2025-11-06
**状态**: ✅ 可用
**支持**: 完整的PQ-Tor系统环境检测

祝使用愉快！🚀
