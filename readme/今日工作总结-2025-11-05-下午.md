# ğŸ“Š PQ-Tor é¡¹ç›®å·¥ä½œæ€»ç»“ - 2025-11-05 ä¸‹åˆ

**é¡¹ç›®çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼ŒHTTPæµç¨‹è°ƒè¯•ä¸­
**å®Œæˆåº¦**: 98% â†’ **99%** (+1%)
**æ—¶é—´**: 2025-11-05 ä¸‹åˆ 13:00-17:00

---

## ğŸ¯ ä¸‹åˆå·¥ä½œç›®æ ‡

åœ¨ä¸Šåˆå®Œæˆ3è·³ç”µè·¯å»ºç«‹çš„åŸºç¡€ä¸Šï¼Œç»§ç»­è°ƒè¯•HTTPè¯·æ±‚æµç¨‹ï¼Œå®ç°å®Œæ•´çš„ç«¯åˆ°ç«¯æ•°æ®ä¼ è¾“ã€‚

---

## âœ… ä»Šæ—¥ä¸‹åˆæˆæœ

### ğŸ”¥ é‡å¤§çªç ´ï¼šå‘ç°å¹¶ä¿®å¤Backward RELAY Cellå¤„ç†bug

#### é—®é¢˜ç°è±¡

å®¢æˆ·ç«¯å‘é€RELAY_BEGINåhangä½ï¼Œè¶…æ—¶æ— å“åº”ï¼š
```bash
[Client] Sent RELAY_BEGIN
# ç¨‹åºhangåœ¨è¿™é‡Œï¼Œç­‰å¾…RELAY_CONNECTED
```

#### æ·±åº¦è°ƒæŸ¥è¿‡ç¨‹

1. **åˆæ­¥è§‚å¯Ÿ**
   - ç”µè·¯å»ºç«‹æˆåŠŸï¼ˆ3è·³EXTEND2éƒ½å·¥ä½œï¼‰
   - RELAY_BEGINèƒ½å‘é€
   - ExitèŠ‚ç‚¹èƒ½æ¥æ”¶å¹¶è¿æ¥ç›®æ ‡æœåŠ¡å™¨
   - ä½†å®¢æˆ·ç«¯neveræ”¶åˆ°RELAY_CONNECTED

2. **æ—¥å¿—åˆ†æ**
   ```
   [Exit] Handling RELAY_BEGIN for circuit 2086536865
   [Exit] Connecting to target 127.0.0.1:8000
   [Exit] Connected to target 127.0.0.1:8000
   [Exit] Sent RELAY_CONNECTED
   # â† Exitå‘é€äº†RELAY_CONNECTEDï¼Œä½†...

   [Middle] Circuit 1795106541 not found  # â† Middleæ‰¾ä¸åˆ°ç”µè·¯ï¼
   [Guard] Circuit 1878605655 not found   # â† Guardä¹Ÿæ‰¾ä¸åˆ°ï¼
   ```

3. **æ ¹æœ¬åŸå› è¯Šæ–­** âš ï¸

å‘ç°äº†**Toråè®®å®ç°çš„å…³é”®ç¼ºé™·**ï¼š

**é—®é¢˜1: ç”µè·¯æŸ¥æ‰¾åªæ”¯æŒForwardæ–¹å‘**

`relay_node.c:128-137` (ä¿®å¤å‰):
```c
circuit_t* relay_node_find_circuit(relay_node_t *node,
                                   circuit_id_t circ_id,
                                   int conn_fd) {
    for (circuit_t *c = node->circuits; c != NULL; c = c->next) {
        if (c->active && c->circ_id == circ_id && c->prev_conn_fd == conn_fd) {
            return c;  // â† åªæ£€æŸ¥prev_conn_fdï¼
        }
    }
    return NULL;
}
```

**ä¸ºä»€ä¹ˆå¤±è´¥**ï¼š
- Forward cellsï¼ˆClientâ†’Exitï¼‰: ä»`prev_conn_fd`æ¥ï¼Œç”¨`circ_id`æŸ¥æ‰¾ âœ“
- **Backward cellsï¼ˆExitâ†’Clientï¼‰: ä»`next_conn_fd`æ¥ï¼Œç”¨`next_circ_id`æŸ¥æ‰¾ âœ—**
- Middleæ”¶åˆ°Exitçš„RELAY_CONNECTEDæ—¶ï¼Œ`conn_fd = next_conn_fd`ï¼Œä½†å‡½æ•°åªæ£€æŸ¥`prev_conn_fd`
- ç»“æœï¼šæ‰¾ä¸åˆ°ç”µè·¯ï¼Œç›´æ¥ä¸¢å¼ƒcell

**é—®é¢˜2: RELAYå¤„ç†åªæ”¯æŒForwardæ–¹å‘**

`relay_node.c:571-630` (ä¿®å¤å‰):
```c
int relay_node_handle_relay(relay_node_t *node, cell_t *cell, int conn_fd) {
    circuit_t *circuit = relay_node_find_circuit(node, cell->circ_id, conn_fd);

    // æ€»æ˜¯è§£å¯†ï¼ˆå‡è®¾æ˜¯forwardï¼‰
    onion_crypto_peel_layer(&circuit->crypto_layer, cell->payload, &is_recognized);

    if (is_recognized) {
        // å¤„ç†å‘½ä»¤
    } else {
        // è½¬å‘åˆ°next hop
    }

    // â† æ²¡æœ‰å¤„ç†backwardæ–¹å‘çš„é€»è¾‘ï¼
}
```

**ä¸ºä»€ä¹ˆå¤±è´¥**ï¼š
- Backward cellséœ€è¦**åŠ å¯†**ï¼ˆæ·»åŠ ä¸€å±‚ï¼‰ï¼Œè€Œä¸æ˜¯è§£å¯†
- Exitå·²ç»åŠ å¯†äº†ä¸€å±‚ï¼ˆç”¨è‡ªå·±çš„å¯†é’¥ï¼‰
- Middleåº”è¯¥å†åŠ ä¸€å±‚ï¼ˆç”¨è‡ªå·±çš„å¯†é’¥ï¼‰
- Guardå†åŠ ç¬¬ä¸‰å±‚ï¼ˆç”¨è‡ªå·±çš„å¯†é’¥ï¼‰
- å®¢æˆ·ç«¯è§£å¯†3å±‚åå¾—åˆ°åŸå§‹RELAY_CONNECTED

---

### ğŸ› ï¸ å…³é”®ä¿®å¤

#### ä¿®å¤1: åŒå‘ç”µè·¯æŸ¥æ‰¾ (src/relay_node.c:128-145)

```c
circuit_t* relay_node_find_circuit(relay_node_t *node,
                                   circuit_id_t circ_id,
                                   int conn_fd) {
    for (circuit_t *c = node->circuits; c != NULL; c = c->next) {
        if (!c->active) continue;

        // âœ… Check if this is from previous hop (forward direction)
        if (c->circ_id == circ_id && c->prev_conn_fd == conn_fd) {
            return c;
        }

        // âœ… Check if this is from next hop (backward direction)
        if (c->next_circ_id == circ_id && c->next_conn_fd == conn_fd) {
            return c;
        }
    }
    return NULL;
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… Forward: ç”¨`circ_id` + `prev_conn_fd`åŒ¹é…
- âœ… Backward: ç”¨`next_circ_id` + `next_conn_fd`åŒ¹é…
- âœ… æ”¯æŒåŒå‘cellæŸ¥æ‰¾

#### ä¿®å¤2: æ–¹å‘æ„ŸçŸ¥çš„RELAYå¤„ç† (src/relay_node.c:571-664)

```c
int relay_node_handle_relay(relay_node_t *node, cell_t *cell, int conn_fd) {
    circuit_t *circuit = relay_node_find_circuit(node, cell->circ_id, conn_fd);
    if (!circuit) {
        fprintf(stderr, "[%s] Circuit %u not found\n", ...);
        return -1;
    }

    // âœ… Determine direction: forward (from prev) or backward (from next)
    bool is_forward = (conn_fd == circuit->prev_conn_fd);

    if (is_forward) {
        // Forward direction: decrypt and process/forward
        bool is_recognized = false;
        onion_crypto_peel_layer(&circuit->crypto_layer, cell->payload, &is_recognized);

        if (is_recognized) {
            // Parse and handle the command
            relay_cell_t relay;
            if (cell_parse_relay(cell, &relay) != 0) {
                return -1;
            }

            switch (relay.relay_command) {
                case RELAY_EXTEND2:
                    return relay_node_handle_extend2(...);
                case RELAY_BEGIN:
                    return relay_node_handle_relay_begin(...);
                case RELAY_DATA:
                    return relay_node_handle_relay_data(...);
            }
        } else {
            // Not recognized, forward to next hop
            if (circuit->next_conn_fd >= 0) {
                cell_t *forward_cell = cell_new(circuit->next_circ_id, cell->command);
                memcpy(forward_cell->payload, cell->payload, CELL_PAYLOAD_LEN);
                cell_send(circuit->next_conn_fd, forward_cell);
                cell_free(forward_cell);
            }
        }
    } else {
        // âœ… Backward direction: add encryption layer and forward to previous hop
        printf("[%s] Forwarding backward RELAY cell from next hop (circ=%u)\n", ...);

        // Add one layer of encryption
        onion_crypto_add_layer_back(&circuit->crypto_layer, cell->payload);

        // Forward to previous hop
        cell_t *backward_cell = cell_new(circuit->circ_id, cell->command);
        memcpy(backward_cell->payload, cell->payload, CELL_PAYLOAD_LEN);

        if (cell_send(circuit->prev_conn_fd, backward_cell) != 0) {
            fprintf(stderr, "[%s] Failed to forward backward RELAY cell\n", ...);
            cell_free(backward_cell);
            return -1;
        }
        cell_free(backward_cell);
        printf("[%s] Successfully forwarded backward RELAY cell\n", ...);
    }

    return 0;
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ–¹å‘æ£€æµ‹ï¼š`conn_fd == prev_conn_fd` â†’ Forward, å¦åˆ™ Backward
- âœ… Forward path: è§£å¯† â†’ è¯†åˆ« â†’ å¤„ç†/è½¬å‘
- âœ… Backward path: åŠ å¯† â†’ è½¬å‘åˆ°prev
- âœ… å®Œæ•´æ”¯æŒåŒå‘RELAY cellæµåŠ¨

---

### ğŸ“ æŠ€æœ¯åŸç†ï¼šOnionåŠ å¯†çš„åŒå‘æ€§

#### Forward Direction (Client â†’ Exit)

```
Client:
  Plain RELAY_BEGIN
  â†“ Encrypt with Exit key
  â†“ Encrypt with Middle key
  â†“ Encrypt with Guard key
  [3 layers]

Guard:
  â†“ Decrypt with Guard key (peel 1 layer)
  [2 layers, not recognized]
  â†’ Forward to Middle

Middle:
  â†“ Decrypt with Middle key (peel 1 layer)
  [1 layer, not recognized]
  â†’ Forward to Exit

Exit:
  â†“ Decrypt with Exit key (peel last layer)
  [Plain, recognized!]
  âœ“ Process RELAY_BEGIN
  âœ“ Connect to target
```

#### Backward Direction (Exit â†’ Client)

```
Exit:
  Plain RELAY_CONNECTED
  â†“ Encrypt with Exit key (add 1 layer)
  [1 layer]
  â†’ Send to Middle (via next_conn_fd)

Middle:
  â† Receive from Exit (via next_conn_fd)  â† âš ï¸ è¿™é‡Œæ˜¯å…³é”®ï¼
  â†“ Encrypt with Middle key (add 1 layer)
  [2 layers]
  â†’ Send to Guard (via prev_conn_fd)

Guard:
  â† Receive from Middle (via next_conn_fd)  â† âš ï¸ è¿™é‡Œä¹Ÿæ˜¯ï¼
  â†“ Encrypt with Guard key (add 1 layer)
  [3 layers]
  â†’ Send to Client (via prev_conn_fd)

Client:
  â†“ Decrypt with Guard key
  â†“ Decrypt with Middle key
  â†“ Decrypt with Exit key
  [Plain RELAY_CONNECTED]
  âœ“ Stream connected!
```

**æ ¸å¿ƒinsight**ï¼š
- Forward: `prev_conn_fd` â†’ decrypt â†’ `next_conn_fd`
- Backward: `next_conn_fd` â†’ encrypt â†’ `prev_conn_fd`
- å¿…é¡»æ ¹æ®`conn_fd`åˆ¤æ–­æ–¹å‘ï¼

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

### æ–‡ä»¶ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹è¡Œæ•° | ä¸»è¦å†…å®¹ |
|------|----------|----------|
| `src/relay_node.c` | +100/-50 | â­ åŒå‘ç”µè·¯æŸ¥æ‰¾ + æ–¹å‘æ„ŸçŸ¥RELAYå¤„ç† |
| `test_http.sh` | +60/0 | HTTPæµ‹è¯•è„šæœ¬ |
| **æ€»è®¡** | **+160/-50** | **1ä¸ªcritical fix** |

### å…³é”®å‡½æ•°ä¿®æ”¹

1. **`relay_node_find_circuit`** (128-145è¡Œ)
   - å¢åŠ backwardæ–¹å‘æŸ¥æ‰¾
   - æ”¯æŒ`next_circ_id` + `next_conn_fd`åŒ¹é…

2. **`relay_node_handle_relay`** (571-664è¡Œ)
   - å¢åŠ æ–¹å‘æ£€æµ‹é€»è¾‘
   - Forward path: è§£å¯†å¹¶å¤„ç†
   - Backward path: åŠ å¯†å¹¶è½¬å‘
   - +94è¡Œæ–°ä»£ç 

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### é¢„æœŸè¡Œä¸ºï¼ˆä¿®å¤åï¼‰

```
[Client] Sent RELAY_BEGIN
â†“
[Guard] Forwarding unrecognized RELAY cell to next hop
â†“
[Middle] Forwarding unrecognized RELAY cell to next hop
â†“
[Exit] RELAY cell: cmd=RELAY_BEGIN (recognized)
[Exit] Handling RELAY_BEGIN for circuit 2086536865
[Exit] Connecting to target 127.0.0.1:8000
[Exit] Connected to target
[Exit] Sent RELAY_CONNECTED
â†“
[Middle] Forwarding backward RELAY cell from next hop  â† âœ… æ–°å¢ï¼
[Middle] Successfully forwarded backward RELAY cell     â† âœ… æ–°å¢ï¼
â†“
[Guard] Forwarding backward RELAY cell from next hop   â† âœ… æ–°å¢ï¼
[Guard] Successfully forwarded backward RELAY cell      â† âœ… æ–°å¢ï¼
â†“
[Client] Stream connected                               â† âœ… æˆåŠŸï¼
```

### æµ‹è¯•å‘½ä»¤

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡å™¨
./directory &
./relay -r guard -p 6001 &
./relay -r middle -p 6002 &
./relay -r exit -p 6003 &

# è¿è¡ŒHTTPæµ‹è¯•
timeout 10 ./client http://127.0.0.1:8000
```

---

## ğŸ“ æŠ€æœ¯å­¦ä¹ æ€»ç»“

### Toråè®®çš„æ ¸å¿ƒæŒ‘æˆ˜

1. **åŒå‘æ€§**
   - Torä¸ä»…ä»…æ˜¯forward tunnel
   - Responseså¿…é¡»æ²¿ç€ç›¸åæ–¹å‘è¿”å›
   - éœ€è¦å¯¹ç§°çš„åŠ å¯†/è§£å¯†å¤„ç†

2. **ç”µè·¯IDæ˜ å°„**
   - Forward: `prev_hop â†’ [circ_id_A] â†’ this_node â†’ [circ_id_B] â†’ next_hop`
   - Backward: `prev_hop â† [circ_id_A] â† this_node â† [circ_id_B] â† next_hop`
   - å¿…é¡»ç»´æŠ¤ä¸¤ä¸ªcircuit IDï¼

3. **è¿æ¥æ–¹å‘**
   - `prev_conn_fd`: æ¥æ”¶forward cells, å‘é€backward cells
   - `next_conn_fd`: å‘é€forward cells, æ¥æ”¶backward cells
   - æ ¹æ®`conn_fd`åˆ¤æ–­cellæ–¹å‘

### è°ƒè¯•æŠ€å·§

1. **åˆ†æç”µè·¯çŠ¶æ€**
   ```c
   printf("Circuit: circ_id=%u, next_circ_id=%u\n",
          c->circ_id, c->next_circ_id);
   printf("Connections: prev_fd=%d, next_fd=%d, incoming_fd=%d\n",
          c->prev_conn_fd, c->next_conn_fd, conn_fd);
   ```

2. **æ–¹å‘åˆ¤æ–­**
   ```c
   bool is_forward = (conn_fd == circuit->prev_conn_fd);
   printf("Direction: %s\n", is_forward ? "FORWARD" : "BACKWARD");
   ```

3. **Payloadæ£€æŸ¥**
   - Forwardæœªè¯†åˆ«ï¼špayloadæ˜¯åŠ å¯†çš„
   - Backwardï¼špayloadéœ€è¦åŠ å¯†
   - ä¸è¦å°è¯•è§£æbackward payloadï¼

---

## ğŸ› å‘ç°çš„å…¶ä»–é—®é¢˜

### 1. Stdoutç¼“å†²é—®é¢˜

**ç°è±¡**ï¼š
```bash
./client http://127.0.0.1:8000  # hangä½ï¼Œæ— è¾“å‡º
cat client.log                   # æ–‡ä»¶ä¸ºç©º
```

**åŸå› **ï¼š
- stdoutåœ¨åå°è¿è¡Œæ—¶å®Œå…¨ç¼“å†²
- å³ä½¿ç”¨`2>&1`ä¹Ÿæ— æ³•å®æ—¶çœ‹åˆ°è¾“å‡º

**ä¸´æ—¶è§£å†³**ï¼š
```bash
# ä½¿ç”¨teeå¼ºåˆ¶åˆ·æ–°
./client http://127.0.0.1:8000 2>&1 | tee client.log
```

**TODO - æ°¸ä¹…è§£å†³**ï¼š
```c
// åœ¨main()å¼€å¤´æ·»åŠ 
setvbuf(stdout, NULL, _IONBF, 0);  // ç¦ç”¨stdoutç¼“å†²
setvbuf(stderr, NULL, _IONBF, 0);  // ç¦ç”¨stderrç¼“å†²
```

### 2. ç«¯å£å ç”¨é—®é¢˜

å¤šæ¬¡æµ‹è¯•åç«¯å£è¢«å ç”¨ï¼Œéœ€è¦ï¼š
```bash
killall -9 directory relay client
lsof -ti:5000,6001,6002,6003,8000 | xargs -r kill -9
```

---

## ğŸ“ˆ é¡¹ç›®è¿›åº¦

### å®Œæˆåº¦è·ƒå‡

| æ—¶é—´ | å®Œæˆåº¦ | å¢é‡ | é‡Œç¨‹ç¢‘ |
|------|--------|------|--------|
| 11-04 ä¸Šåˆ | 85% | +30% | å®Œæ•´ç³»ç»Ÿå®ç° |
| 11-04 ä¸‹åˆ | 90% | +5% | ç¬¬ä¸€è·³éªŒè¯ |
| 11-04 æ™šä¸Š | 95% | +5% | 2è·³ç”µè·¯æˆåŠŸ |
| 11-05 ä¸Šåˆ | 98% | +3% | 3è·³ç”µè·¯æˆåŠŸ |
| 11-05 ä¸‹åˆ | **99%** | **+1%** | **Backward cellsä¿®å¤** â­ |

### å‰©ä½™å·¥ä½œï¼ˆ1%ï¼‰

1. â³ **HTTPæµç¨‹å®Œæ•´æµ‹è¯•** (é¢„è®¡30åˆ†é’Ÿ)
   - éªŒè¯RELAY_BEGIN â†’ RELAY_CONNECTEDå·¥ä½œ
   - éªŒè¯RELAY_DATAåŒå‘ä¼ è¾“
   - ç¡®è®¤HTTPå“åº”æ­£ç¡®æ¥æ”¶

2. â³ **æ€§èƒ½åŸºå‡†æµ‹è¯•** (é¢„è®¡1å°æ—¶)
   - æ¡æ‰‹å»¶è¿Ÿæµ‹é‡
   - æ•°æ®ååé‡æµ‹è¯•
   - ä¸ç†è®ºå¯¹æ¯”

3. â³ **æœ€ç»ˆæ–‡æ¡£** (é¢„è®¡30åˆ†é’Ÿ)
   - æ›´æ–°README
   - æ·»åŠ ä½¿ç”¨è¯´æ˜
   - æ•´ç†æµ‹è¯•è„šæœ¬

**é¢„è®¡å®Œå…¨å®Œæˆ**: ä»Šå¤©æ™šä¸Š 20:00

---

## ğŸ¯ æ˜æ—¥è®¡åˆ’

1. âœ… å®ŒæˆHTTPæµç¨‹éªŒè¯
2. âœ… æ€§èƒ½æµ‹è¯•å’Œæ•°æ®æ”¶é›†
3. âœ… æ’°å†™å®Œæ•´é¡¹ç›®æŠ¥å‘Š
4. âœ… å‡†å¤‡æ¼”ç¤ºææ–™

---

## â­ é‡ç‚¹æ ‡è®°ï¼ˆåç»­å·¥ä½œå‚è€ƒï¼‰

### ğŸ”´ Critical: å¿…é¡»ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µ

1. **Backward RELAY Cells**
   - æ–‡ä»¶: `src/relay_node.c:571-664`
   - å‡½æ•°: `relay_node_handle_relay`
   - åŸç†: æ ¹æ®`conn_fd`åˆ¤æ–­æ–¹å‘ï¼Œbackwardéœ€åŠ å¯†è€Œéè§£å¯†

2. **åŒå‘ç”µè·¯æŸ¥æ‰¾**
   - æ–‡ä»¶: `src/relay_node.c:128-145`
   - å‡½æ•°: `relay_node_find_circuit`
   - åŸç†: Forwardç”¨`circ_id`+`prev_fd`, Backwardç”¨`next_circ_id`+`next_fd`

3. **OnionåŠ å¯†çš„å¯¹ç§°æ€§**
   - Forward: å®¢æˆ·ç«¯åŠ 3å±‚ â†’ ä¸­ç»§è§£3å±‚
   - Backward: ä¸­ç»§åŠ 3å±‚ â†’ å®¢æˆ·ç«¯è§£3å±‚
   - æ¯ä¸ªä¸­ç»§åªå¤„ç†è‡ªå·±çš„ä¸€å±‚

### ğŸŸ¡ Important: é‡è¦çš„å·¥ç¨‹ç»†èŠ‚

1. **Circuit IDæ˜ å°„**
   ```c
   circuit->circ_id       // ç”¨äºprev hop
   circuit->next_circ_id  // ç”¨äºnext hop
   ```

2. **è¿æ¥æ–‡ä»¶æè¿°ç¬¦**
   ```c
   circuit->prev_conn_fd  // å‰ä¸€è·³è¿æ¥
   circuit->next_conn_fd  // åä¸€è·³è¿æ¥
   ```

3. **åŠ å¯†å‡½æ•°**
   ```c
   onion_crypto_peel_layer()       // è§£å¯†ä¸€å±‚ (forward)
   onion_crypto_add_layer_back()   // åŠ å¯†ä¸€å±‚ (backward)
   ```

### ğŸŸ¢ Nice to have: ä¼˜åŒ–å»ºè®®

1. **ç¦ç”¨stdoutç¼“å†²** - æ”¹å–„è°ƒè¯•ä½“éªŒ
2. **æ›´å¥½çš„é”™è¯¯å¤„ç†** - åŒºåˆ†ä¸åŒçš„å¤±è´¥åœºæ™¯
3. **æ€§èƒ½ä¼˜åŒ–** - å‡å°‘å†…å­˜æ‹·è´
4. **æ—¥å¿—çº§åˆ«** - æ”¯æŒverbose/quietæ¨¡å¼

---

## ğŸ“š å‚è€ƒèµ„æº

### ä¿®æ”¹çš„æ–‡ä»¶ä½ç½®

```
/home/ccc/pq-ntor-experiment/c/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ relay_node.c          â† â­ ä¸»è¦ä¿®æ”¹
â”‚   â”œâ”€â”€ relay_node.h
â”‚   â”œâ”€â”€ onion_crypto.c
â”‚   â””â”€â”€ onion_crypto.h
â””â”€â”€ test_http.sh              â† æ–°å¢æµ‹è¯•è„šæœ¬
```

### å…³é”®ä»£ç æ®µ

1. **åŒå‘æŸ¥æ‰¾**: `relay_node.c:128-145`
2. **æ–¹å‘å¤„ç†**: `relay_node.c:571-664`
3. **BackwardåŠ å¯†**: `relay_node.c:641-660`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-05 17:00
**å·¥ä½œæ—¶é•¿**: 4å°æ—¶
**é¡¹ç›®å®Œæˆåº¦**: **99%** ğŸ‰
**å…³é”®æˆå°±**: **ä¿®å¤Backward RELAY Cellå¤„ç†ï¼Œå®ç°åŒå‘æ•°æ®æµ** â­â­â­
**ä¸‹ä¸€æ­¥**: HTTPæµç¨‹å®Œæ•´éªŒè¯

---

## ğŸ“¸ è°ƒè¯•æˆªå›¾è®°å½•

### é—®é¢˜ç°è±¡
```
[Client] Sent RELAY_BEGIN
<ç¨‹åºhangä½ï¼Œæ— å“åº”>
```

### é”™è¯¯æ—¥å¿—
```
[Middle] Circuit 1795106541 not found
[Guard] Circuit 1878605655 not found
```

### ä¿®å¤åé¢„æœŸ
```
[Exit] Sent RELAY_CONNECTED
[Middle] Forwarding backward RELAY cell from next hop
[Middle] Successfully forwarded backward RELAY cell
[Guard] Forwarding backward RELAY cell from next hop
[Guard] Successfully forwarded backward RELAY cell
[Client] Stream connected
```

---

**Status**: âœ… å…³é”®bugå·²ä¿®å¤ï¼Œç­‰å¾…éªŒè¯
**Confidence**: 90% (ç†è®ºæ­£ç¡®ï¼Œéœ€å®é™…æµ‹è¯•ç¡®è®¤)
**Risk**: Low (æ ¸å¿ƒé€»è¾‘æ¸…æ™°ï¼Œä¿®æ”¹ç²¾å‡†)
