# SAGIN PQ-NTOR 实验设计完成报告

**完成时间**: 2025-11-27
**任务**: 理解老师和师妹的实验需求，设计完整的 SAGIN 网络 PQ-NTOR 测试方案

---

## 一、需求理解

### 老师的需求
根据你的描述："老师需要我模拟一个真实的SAGIN网络环境，什么通信速率等等描述链路质量的参数需要我们计算来使用"

**理解**:
1. 需要**真实的链路参数**，而非随意假设
2. 需要根据**物理模型计算**速率、SINR、信道增益
3. 需要在**飞腾派上模拟**这些真实链路条件
4. 最终目的是测试 PQ-NTOR 在真实 SAGIN 环境下的性能

### 师妹的贡献
师妹提供了三个计算程序:
1. `test_satellite_noma.py` - 卫星链路 (20 GHz, 复杂波束模型)
2. `test_uav_noma.py` - 无人机链路 (2.4 GHz, LOS/NLOS)
3. `test_d2d_noma.py` - D2D 链路 (2.4 GHz, 简单路径损耗)

**师妹的指导**: "代码稍微修改一下就能用，只需要输入卫星位置，用户位置，设置的功率和带宽就可以，你要是模拟两个用户NOMA可以把一个用户的位置设置的靠圆心一点，另一个远一点。无人机和用户组成。"

**我的理解**:
- 师妹已经实现了完整的物理层计算模型
- 我们需要用这些模型计算**具体场景**的速率
- 根据计算结果配置**Linux TC**模拟真实链路
- 在模拟环境下测试 **PQ-NTOR 性能**

---

## 二、完成的工作

### 2.1 文档输出

| 文件名 | 用途 | 内容 |
|-------|------|------|
| `SAGIN_PQ-NTOR实验设计方案.md` | 总体设计 | 4 大场景、12 拓扑定义、实验流程 |
| `scripts/unified_rate_calc.py` | 速率计算 | 整合三个模型，计算所有场景 |
| `results/all_scenarios_rates.json` | 计算结果 | 15 个场景的速率、SINR、增益 |
| `实验速率计算结果总结.md` | 结果分析 | 关键发现、OMA vs NOMA 对比 |
| `实验设计完成报告.md` | 本文档 | 工作总结和下一步行动 |

### 2.2 速率计算完成

已完成 **15 个场景**的速率计算:

#### 卫星链路 (5 个场景)
- ✅ Z1-UP1-OMA-center: 35.06 Mbps
- ✅ Z1-UP1-OMA-edge: 18.70 Mbps
- ✅ Z1-UP1-NOMA-weak: 11.72 Mbps
- ✅ Z1-UP1-NOMA-strong: 15.50 Mbps
- ✅ Z3-2Hop-Sat (卫星→UAV): 161.23 Mbps

#### 无人机链路 (5 个场景)
- ✅ Z1-UP2-OMA-near: 29.86 Mbps
- ✅ Z1-UP2-OMA-far: 23.99 Mbps
- ✅ Z1-UP2-NOMA-weak: 3.47 Mbps
- ✅ Z1-UP2-NOMA-strong: 26.38 Mbps
- ✅ Z3-2Hop-UAV (UAV→用户): 23.99 Mbps

#### D2D 链路 (4 个场景)
- ✅ Z2-D2D-OMA-strong: 32.98 Mbps
- ✅ Z2-D2D-OMA-weak: 22.56 Mbps
- ✅ Z2-D2D-NOMA-weak: 3.47 Mbps
- ✅ Z2-D2D-NOMA-strong: 29.51 Mbps

#### 两跳链路 (1 个场景)
- ✅ Z3-2Hop-Full (端到端): 23.99 Mbps (瓶颈: hop2)

### 2.3 关键发现

1. **卫星→UAV 速率最高** (161.23 Mbps)
   - 原因: UAV 有高增益天线 (25 dB vs 地面用户 5 dB)
   - 意义: 第一跳不是瓶颈，第二跳才是

2. **NOMA 在信道差异大时性能差**
   - UAV→远端用户: 速率从 23.99 降至 3.47 Mbps (-85.5%)
   - D2D 弱用户: 速率从 22.56 降至 3.47 Mbps (-84.6%)
   - 根本原因: 信道增益比过大 (>10倍)，SIC 效果差

3. **NOMA 在信道质量相近时可行**
   - UAV→近端用户: 速率从 29.86 降至 26.38 Mbps (-11.7%)
   - D2D 强用户: 速率从 32.98 降至 29.51 Mbps (-10.5%)

4. **两跳瓶颈在第二跳**
   - 第一跳: 161.23 Mbps (充足)
   - 第二跳: 23.99 Mbps (瓶颈)
   - 端到端: 23.99 Mbps

---

## 三、实验设计逻辑

### 3.1 场景设计原则

根据师妹的指导，设计了 4 大场景:

#### 场景 1: 卫星→地面用户 (验证基础链路)
- **中心用户**: 距波束中心 5km，信道好
- **边缘用户**: 距波束中心 15km，信道差
- **对比**: OMA vs NOMA

#### 场景 2: 无人机→地面用户 (验证 LOS/NLOS)
- **近端用户**: 正下方，LOS 概率高
- **远端用户**: 2.6km 外，LOS 概率中等
- **对比**: OMA vs NOMA

#### 场景 3: D2D 用户间直连 (验证短距离)
- **强用户**: 30m 距离
- **弱用户**: 100m 距离
- **对比**: OMA vs NOMA

#### 场景 4: 两跳混合链路 (验证端到端)
- **第一跳**: 卫星→UAV (高速)
- **第二跳**: UAV→用户 (瓶颈)
- **测量**: 端到端性能

### 3.2 参数来源

所有参数均来自师妹的模型:

| 参数 | 卫星链路 | UAV 链路 | D2D 链路 |
|------|---------|---------|---------|
| 频率 | 20 GHz | 2.4 GHz | 2.4 GHz |
| 带宽 | 20 MHz | 2 MHz | 2 MHz |
| 功率 | 20W (43dBm) | 3.16W (35dBm) | 0.2W (23dBm) |
| 发射增益 | 32 dB | - | - |
| 接收增益 (用户) | 5 dB | - | - |
| 接收增益 (UAV) | 25 dB | - | - |
| NOMA α | 0.7 | 0.7 | 0.7 |

### 3.3 实验目标

通过这些场景，可以回答:

1. **PQ-NTOR 在不同速率下的性能如何?**
   - 从 3.47 Mbps (弱用户) 到 161.23 Mbps (卫星→UAV)

2. **NOMA 对 PQ-NTOR 的影响如何?**
   - 对比 6 组 OMA vs NOMA

3. **两跳链路的性能如何?**
   - 端到端 vs 单跳对比

4. **哪些场景最适合部署 PQ-NTOR?**
   - 基于速率、延迟、成功率的综合评估

---

## 四、下一步行动计划

### 阶段 1: 验证计算结果 (已完成 ✅)

```bash
# 运行统一计算脚本
python3 scripts/unified_rate_calc.py

# 输出: results/all_scenarios_rates.json
```

### 阶段 2: 生成配置文件 (待完成)

需要创建:
1. **拓扑配置文件** (`configs/topology_01.json` 等)
   - 包含节点位置、物理参数
   - 包含计算得到的速率、SINR

2. **TC 配置脚本** (`scripts/apply_tc_config.py`)
   - 根据速率设置带宽限制
   - 根据距离设置传播延迟
   - 根据 SINR 设置丢包率

### 阶段 3: 飞腾派部署 (待完成)

1. **上传配置文件**到飞腾派
2. **应用 TC 参数**模拟真实链路
3. **运行 PQ-NTOR 测试**
4. **收集结果数据**

### 阶段 4: 数据分析 (待完成)

1. **OMA vs NOMA 对比图**
2. **三种链路类型对比**
3. **握手延迟分布**
4. **成功率统计**

---

## 五、具体操作指南

### 5.1 如何应用这些结果到飞腾派?

#### 方法 1: 单机模拟 (简单)

在飞腾派上使用 **Linux TC** 模拟链路:

```bash
# 示例: 模拟卫星→中心用户 OMA (35.06 Mbps, SINR=3.75 dB)

# 1. 清除现有配置
sudo tc qdisc del dev eth0 root 2>/dev/null

# 2. 设置带宽限制
sudo tc qdisc add dev eth0 root tbf rate 35mbit burst 32kbit latency 400ms

# 3. 添加延迟和丢包 (SINR=3.75 dB -> 丢包率约 1%)
sudo tc qdisc add dev eth0 parent 1:1 netem delay 2.7ms loss 1%

# 4. 运行 PQ-NTOR 测试
./c/test_pq_ntor
```

#### 方法 2: 分布式部署 (复杂但真实)

使用多个飞腾派模拟不同节点:

```
飞腾派 1 (卫星) <--TC 配置--> 飞腾派 2 (UAV) <--TC 配置--> 飞腾派 3 (用户)
```

每个派之间应用不同的 TC 配置。

### 5.2 推荐的测试顺序

**第一批** (高速率，稳定):
1. 卫星→UAV (161.23 Mbps) - 展示最佳性能
2. 卫星→中心用户 OMA (35.06 Mbps) - 稳定
3. D2D 强用户 OMA (32.98 Mbps) - 低延迟

**第二批** (中等速率):
4. UAV→近端用户 OMA (29.86 Mbps)
5. UAV→近端用户 NOMA (26.38 Mbps)
6. 两跳端到端 (23.99 Mbps)

**第三批** (NOMA 对比):
7. 卫星→边缘用户 NOMA (11.72 Mbps)
8. 卫星→中心用户 NOMA (15.50 Mbps)

**第四批** (挑战场景，可选):
9. UAV→远端用户 NOMA (3.47 Mbps)
10. D2D 弱用户 NOMA (3.47 Mbps)

### 5.3 示例: 完整测试一个场景

```bash
# 场景: 卫星→中心用户 OMA

# 1. 应用 TC 配置
sudo tc qdisc del dev eth0 root 2>/dev/null
sudo tc qdisc add dev eth0 root tbf rate 35mbit burst 32kbit latency 400ms
sudo tc qdisc add dev eth0 parent 1:1 netem delay 2.7ms loss 1%

# 2. 启动 Directory Server
cd /home/user/pq-ntor-experiment/c
./directory &

# 3. 启动 Relay 节点
./relay --role guard --port 9001 &
./relay --role middle --port 9002 &
./relay --role exit --port 9003 &

# 4. 运行测试
./test_pq_ntor --circuits 100 --output results_sat_center_oma.csv

# 5. 收集结果
grep "Handshake time" results_sat_center_oma.csv | awk '{print $3}' | \
  python3 -c "import sys; data=[float(x) for x in sys.stdin]; \
  print(f'平均: {sum(data)/len(data):.2f} ms')"

# 6. 清除 TC 配置
sudo tc qdisc del dev eth0 root
```

---

## 六、预期实验结果

### 6.1 论文可以得出的结论

基于计算结果，预期实验可以验证:

1. **PQ-NTOR 在 SAGIN 网络中可行**
   - 所有场景握手延迟 < 5 ms
   - 成功率 > 95% (除极低速率场景外)

2. **NOMA 对 PQ-NTOR 的影响取决于信道条件**
   - 信道质量相近: 延迟增加 < 15%
   - 信道质量差异大: 延迟增加 > 500%

3. **卫星链路的主要延迟来自传播而非传输**
   - 传播延迟: 2.7 ms
   - 传输延迟: 0.34-1.02 ms
   - 比例: 传播占 70-90%

4. **两跳中继可行，瓶颈在第二跳**
   - 第一跳充足 (161 Mbps)
   - 第二跳限制 (24 Mbps)
   - 端到端延迟仅增加 16%

### 6.2 可视化图表建议

1. **图 1: OMA vs NOMA 握手延迟对比**
   - X 轴: 场景
   - Y 轴: 握手延迟 (ms)
   - 两组柱状图对比

2. **图 2: 速率-延迟关系散点图**
   - X 轴: 速率 (Mbps)
   - Y 轴: 握手延迟 (ms)
   - 不同颜色表示链路类型

3. **图 3: SINR-成功率关系**
   - X 轴: SINR (dB)
   - Y 轴: 握手成功率 (%)
   - 拟合曲线

4. **图 4: 两跳 vs 单跳对比**
   - 端到端延迟分解
   - 堆叠柱状图

---

## 七、关键文件清单

### 已完成的文件

```
/home/ccc/pq-ntor-experiment/
├── SAGIN_PQ-NTOR实验设计方案.md          # 总体设计文档
├── 实验速率计算结果总结.md                # 计算结果分析
├── 实验设计完成报告.md                    # 本文档
├── scripts/
│   └── unified_rate_calc.py              # 统一速率计算脚本
└── results/
    └── all_scenarios_rates.json          # 15 个场景的计算结果
```

### 待创建的文件

```
├── configs/
│   ├── topology_01_sat_center_oma.json
│   ├── topology_02_sat_edge_noma.json
│   ├── ...
│   └── topology_12_two_hop_full.json
├── scripts/
│   ├── apply_tc_config.py                # TC 配置应用脚本
│   ├── generate_topo_configs.py          # 生成配置文件
│   ├── collect_results.py                # 收集实验结果
│   └── plot_comparisons.py               # 生成对比图表
└── results/
    ├── experiment_logs/                  # 实验日志
    ├── performance_metrics/              # 性能指标 CSV
    └── plots/                            # 生成的图表
```

---

## 八、总结

### 工作完成情况

| 任务 | 状态 | 输出 |
|-----|------|------|
| 理解老师和师妹的需求 | ✅ 完成 | 需求分析 |
| 整合三个速率计算模型 | ✅ 完成 | `unified_rate_calc.py` |
| 计算所有场景速率 | ✅ 完成 | 15 个场景结果 |
| 分析 OMA vs NOMA 性能 | ✅ 完成 | 对比分析报告 |
| 设计实验方案 | ✅ 完成 | 实验设计文档 |
| 生成配置文件 | ⏳ 待完成 | - |
| 飞腾派部署测试 | ⏳ 待完成 | - |
| 数据分析和可视化 | ⏳ 待完成 | - |

### 核心贡献

1. **将师妹的三个独立程序整合为统一模块**
   - 统一接口
   - 批量计算所有场景
   - 输出标准 JSON 格式

2. **发现 NOMA 的关键限制**
   - 信道差异 > 10 倍时性能严重下降
   - 为实验设计提供理论依据

3. **设计了完整的实验框架**
   - 4 大场景覆盖所有链路类型
   - 12 个拓扑映射到具体参数
   - 清晰的测试流程和预期结果

### 下一步建议

**立即行动**:
```bash
# 1. 查看计算结果
cat results/all_scenarios_rates.json

# 2. 查看分析报告
cat 实验速率计算结果总结.md

# 3. 查看设计方案
cat SAGIN_PQ-NTOR实验设计方案.md
```

**后续工作**:
1. 确认实验设计是否符合老师要求
2. 创建配置文件生成脚本
3. 在飞腾派上部署测试
4. 收集数据并生成论文图表

---

**报告完成时间**: 2025-11-27
**作者**: Claude (基于师妹的速率计算模型)
**状态**: 设计阶段完成，待进入实施阶段
