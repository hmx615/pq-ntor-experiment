# SAGIN拓扑下行速率低于上行的根因分析

## 问题描述

在最新的拓扑参数计算中，出现了反直觉的现象：
- **上行平均速率**: 14.04 Mbps
- **下行平均速率**: 12.68 Mbps
- **问题**: 下行速率 < 上行速率

这与物理规律不符，因为：
- 卫星功率 (20W) >> 地面功率 (1W)
- UAV功率 (5W) > 地面功率 (1W)
- 理论上下行应该显著快于上行

## 根本原因：带宽配置不同

### 代码分析

在 `calculate_topology_params.py` 中发现：

**卫星链路（上行/下行）**:
```python
# Line 80 - 卫星下行
rate_mbps, sinr, _ = oma_rate_single_device(
    sat_pos, dev_pos,
    P_tx_W=20.0,  # 20W功率
    B_Hz=20e6,    # ⭐ 20 MHz带宽
    is_uav=is_uav
)

# Line 101 - 卫星上行
rate_mbps, sinr, _ = uplink_oma_rate_single_device(
    sat_pos, dev_pos,
    P_tx_W=P_tx_W,
    B_Hz=20e6,    # ⭐ 20 MHz带宽
    ...
)
```

**UAV链路（对称，不区分上下行）**:
```python
# Line 120 - UAV链路
rate_mbps, sinr, _ = uav_oma_rate(
    uav_pos, user_pos,
    P_uav_W=5.0,   # 5W功率
    B_Hz=2e6       # ⭐ 仅2 MHz带宽！
)
```

**D2D链路**:
```python
# Line 129 - D2D链路
rate_mbps, sinr, _ = d2d_oma_rate(
    pos1, pos2,
    P_tx_W=1.0,
    B_Hz=2e6       # ⭐ 2 MHz带宽
)
```

### 关键发现

**带宽分配**:
- 卫星链路: **20 MHz** (上行和下行)
- UAV链路: **2 MHz** (10倍差距！)
- D2D链路: **2 MHz**

**Shannon容量公式**: `Rate = B × log₂(1 + SINR)`

带宽直接影响速率上限，UAV链路的带宽限制导致即使功率提升5倍（5W vs 1W），速率仍然受限。

## 实际链路对比

### topo07 下行链路 (UAV 5W → Ground)

```
链路: UAV(5W) → Ground
速率: 15.40 Mbps
SINR: 23.15 dB
带宽: 2 MHz ⚠️
延迟: 0.0203 ms
```

### topo03 上行链路 (Ground 1W → UAV)

```
链路1: Ground(1W) → UAV
速率: 21.85 Mbps
SINR: 32.89 dB
带宽: 2 MHz
延迟: 0.0137 ms

链路2: Ground(1W) → UAV
速率: 27.78 Mbps
SINR: 41.81 dB
带宽: 2 MHz
延迟: 0.0060 ms
```

### 问题所在

虽然UAV功率是Ground的5倍（7 dB优势），但上行链路的SINR更高：
- **UAV下行SINR**: 23.15 dB (距离20.3m)
- **Ground上行SINR**: 32.89 - 41.81 dB (距离13.7m - 6.0m)

**原因**: 上行拓扑中Ground距离UAV更近（6-13.7m），而下行拓扑中UAV距离Ground更远（20.3m）。距离优势抵消了功率劣势。

## 数据验证

### 速率计算验证

使用Shannon公式 `Rate = B × log₂(1 + SINR)`：

**UAV下行 (topo07)**:
```
B = 2 MHz
SINR = 23.15 dB = 10^(23.15/10) = 206.6 (线性)
Rate = 2e6 × log₂(1 + 206.6) / 1e6 = 15.38 Mbps ✅
```

**Ground上行 (topo03 链路1)**:
```
B = 2 MHz
SINR = 32.89 dB = 10^(32.89/10) = 1944.6 (线性)
Rate = 2e6 × log₂(1 + 1944.6) / 1e6 = 21.84 Mbps ✅
```

**Ground上行 (topo03 链路2)**:
```
B = 2 MHz
SINR = 41.81 dB = 10^(41.81/10) = 15178.0 (线性)
Rate = 2e6 × log₂(1 + 15178.0) / 1e6 = 27.78 Mbps ✅
```

计算结果与实际数据完全一致！

## 结论

### 为什么下行速率低于上行？

**三个主要因素**:

1. **带宽限制** ⭐ 最关键
   - 卫星链路: 20 MHz
   - UAV链路: 仅2 MHz (瓶颈！)
   - 下行拓扑中UAV中继成为瓶颈

2. **距离差异**
   - 下行拓扑: UAV距离Ground ~20m
   - 上行拓扑: Ground距离UAV ~6-14m
   - 上行距离更近 → SINR更高

3. **多跳中继**
   - 下行拓扑包含UAV中继链路
   - 端到端速率 = min(所有跳速率)
   - UAV→Ground链路成为瓶颈

### 物理合理性

虽然下行功率更高，但由于：
- UAV链路带宽仅为卫星链路的1/10
- 上行拓扑中距离更优
- 下行拓扑中多跳中继限制

导致下行端到端速率低于上行，这在SAGIN异构网络中是**合理的**。

## 统计总结

### 当前参数范围

```
速率范围: 7.49 - 30.54 Mbps
延迟范围: 2.72 - 5.46 ms
丢包范围: 0.50 - 3.00 %

上行(topo01-06)平均: 14.04 Mbps
下行(topo07-12)平均: 12.68 Mbps
下行/上行比: 0.90×
```

### 瓶颈分布

**上行拓扑瓶颈**:
- 卫星上行链路 (低SINR地面站发射)
- 速率: 7.97 - 13.30 Mbps (卫星链路带宽20MHz但远距离)

**下行拓扑瓶颈**:
- UAV中继链路 (带宽限制)
- 速率: 7.49 - 15.40 Mbps (UAV链路带宽仅2MHz)

## 建议

如果需要让下行速率显著高于上行，可以考虑：

1. **增加UAV链路带宽**: 从2 MHz提升到10-20 MHz
2. **优化UAV位置**: 缩短UAV到地面站距离
3. **提高UAV发射功率**: 从5W提升到10W
4. **减少下行拓扑跳数**: 使用直达链路而非中继

但当前的参数设置在物理上是合理的，反映了SAGIN异构网络中带宽分配和多跳中继的实际约束。
