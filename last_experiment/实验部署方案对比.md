# PQ-NTOR实验部署方案对比：1个飞腾派 vs 7个飞腾派

**决策目的**: 确定PQ-NTOR性能测试的实验部署方案
**对比维度**: 复杂度、成本、真实性、可行性、数据价值

---

## 📊 方案对比总览

| 对比项 | 方案A: 1个飞腾派 | 方案B: 7个飞腾派 |
|--------|----------------|----------------|
| **硬件需求** | 1台飞腾派 | 7台飞腾派(6节点+1控制台) |
| **网络拓扑** | 单机模拟(loopback) | 真实分布式网络 |
| **部署复杂度** | ⭐ 简单 | ⭐⭐⭐⭐ 复杂 |
| **调试难度** | ⭐ 容易 | ⭐⭐⭐⭐ 困难 |
| **实验周期** | 1-2天 | 5-7天 |
| **数据真实性** | ⭐⭐ 模拟 | ⭐⭐⭐⭐⭐ 真实 |
| **论文价值** | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 高 |
| **可重复性** | ⭐⭐⭐⭐⭐ 非常好 | ⭐⭐⭐ 一般 |
| **故障风险** | ⭐ 低 | ⭐⭐⭐⭐ 高 |

---

## 方案A: 1个飞腾派（单机模拟）

### 🏗️ 架构设计

```
┌─────────────────────────────────────────┐
│        单个飞腾派 (WSL/Linux)            │
│  ┌───────────────────────────────────┐  │
│  │  loopback (127.0.0.1)             │  │
│  │  ┌────┐  ┌────┐  ┌────┐  ┌────┐ │  │
│  │  │Dir │  │Grd │  │Mid │  │Exit│ │  │
│  │  │9001│  │9002│  │9003│  │9004│ │  │
│  │  └────┘  └────┘  └────┘  └────┘ │  │
│  │         ↕ Linux TC 模拟网络参数   │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │ Client (PQ-NTOR测试脚本)   │  │  │
│  │  └────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 🔧 实现方式

#### 1. 网络模拟
```bash
# 为loopback接口应用TC参数
sudo tc qdisc del dev lo root 2>/dev/null
sudo tc qdisc add dev lo root handle 1: prio

# 对Directory Server流量应用topo01参数
sudo tc qdisc add dev lo parent 1:1 handle 10: netem \
  rate 31.81mbit \
  delay 5.42ms \
  loss 2.0%

# 对Guard Relay流量应用topo02参数
# ... (依次为每个角色配置不同参数)
```

**挑战**: loopback不支持TC带宽限制，需要使用veth pair：
```bash
# 创建虚拟网络对
ip link add veth0 type veth peer name veth1
ip addr add 10.0.0.1/24 dev veth0
ip addr add 10.0.0.2/24 dev veth1
ip link set veth0 up
ip link set veth1 up

# 应用TC参数到veth接口
tc qdisc add dev veth0 root netem ...
```

#### 2. PQ-NTOR测试流程
```python
# test_pq_ntor_single_machine.py

import subprocess
import json

# 加载12拓扑参数
with open('topology_tc_params.json') as f:
    params = json.load(f)

for topo_id, topo_params in params.items():
    # 1. 应用TC参数
    apply_tc_config(topo_params)

    # 2. 启动Directory + 3个Relay节点
    start_directory()
    start_guard_relay()
    start_middle_relay()
    start_exit_relay()

    # 3. 运行100次PQ-NTOR握手
    results = run_pq_ntor_handshakes(num_circuits=100)

    # 4. 记录结果
    save_results(topo_id, results)

    # 5. 清理TC配置
    cleanup_tc()
```

### ✅ 优点

1. **快速启动** (1-2天)
   - 无需配置7台设备
   - 无需网络布线
   - 调试简单

2. **完全可控**
   - 参数精确可调
   - 无真实网络干扰
   - 可重复性100%

3. **资源高效**
   - 只需1台飞腾派
   - 或者用WSL/Linux虚拟机

4. **自动化程度高**
   - 一键运行全部12拓扑
   - 自动化脚本简单

### ❌ 缺点

1. **真实性不足**
   - 所有节点在同一进程/机器
   - 无真实网络传输
   - TCP loopback优化（不真实）

2. **论文说服力弱**
   - 审稿人可能质疑：只是单机测试
   - 无法展示真实分布式系统

3. **部分场景无法模拟**
   - 真实网络抖动
   - 多跳中继的真实延迟累加
   - 协作链路的真实干扰

4. **技术限制**
   - loopback无法限速（需veth pair）
   - TC模拟有误差
   - 无法测试真实硬件差异

### 📈 论文价值评估

**可以支撑的论文论点**:
- ✅ PQ-NTOR基础性能（握手延迟、计算开销）
- ✅ 不同网络参数下的相对性能
- ✅ 算法正确性验证
- ❌ 真实SAGIN网络性能
- ❌ 分布式系统开销
- ❌ 实际部署可行性

**适用期刊/会议**:
- 算法类会议（如ACM CCS理论track）
- 技术报告
- 不适合: 系统类会议（USENIX, NSDI）

---

## 方案B: 7个飞腾派（真实分布式）

### 🏗️ 架构设计

```
┌──────────────────────────────────────────────────────────┐
│               局域网 192.168.100.0/24                     │
│                                                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │飞腾派1   │  │飞腾派2   │  │飞腾派3   │  │飞腾派4   │    │
│  │ SAT     │  │ UAV1    │  │ UAV2    │  │Ground1  │    │
│  │.11      │  │.12      │  │.13      │  │.14      │    │
│  │Dir+Relay│  │ Relay   │  │ Relay   │  │ Relay   │    │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │
│        ↕TC         ↕TC         ↕TC         ↕TC          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │
│  │飞腾派5   │  │飞腾派6   │  │飞腾派7   │                 │
│  │Ground2  │  │Ground3  │  │控制台    │                 │
│  │.15      │  │.16      │  │.17      │                 │
│  │ Relay   │  │Client   │  │Web监控  │                 │
│  └─────────┘  └─────────┘  └─────────┘                 │
│        ↕TC         ↕TC                                   │
└──────────────────────────────────────────────────────────┘
```

### 🔧 实现方式

#### 1. 网络配置
每个飞腾派根据拓扑ID应用不同的TC参数：

**拓扑1示例**（直连NOMA）:
```bash
# 飞腾派2 (UAV1 → SAT): 高RSSI天基上行
# 目标: 飞腾派1 (.11)
tc qdisc add dev eth0 root netem \
  rate 161mbit delay 2.71ms loss 0.1%

# 飞腾派4 (Ground1 → SAT): 低RSSI天基上行
# 目标: 飞腾派1 (.11)
tc qdisc add dev eth0 root netem \
  rate 31mbit delay 2.71ms loss 2.0%
```

#### 2. 动态拓扑切换
```python
# 控制台脚本: switch_topology.py

def switch_to_topology(topo_id):
    # 1. 从topology_params.json加载拓扑参数
    params = load_topology_params(topo_id)

    # 2. 通过SSH向每个飞腾派发送TC配置命令
    for node_id, links in params['links'].items():
        ssh_apply_tc(node_id, links)

    # 3. 等待配置生效
    time.sleep(2)

    # 4. 验证配置
    verify_network_config()
```

#### 3. 自动化测试流程
```python
# run_distributed_experiment.py

for topo_id in range(1, 13):
    # 1. 切换拓扑
    switch_to_topology(f'topo{topo_id:02d}')

    # 2. 在Ground3(飞腾派6)运行Client
    ssh_run_client('192.168.100.16', num_circuits=100)

    # 3. 收集所有节点的日志
    collect_logs_from_all_nodes()

    # 4. 分析结果
    analyze_results(topo_id)
```

### ✅ 优点

1. **真实性极高** ⭐⭐⭐⭐⭐
   - 真实的网络传输
   - 真实的多跳中继
   - 真实的硬件开销
   - 真实的协作链路干扰

2. **论文价值高**
   - 审稿人信服度高
   - 可展示实际部署系统
   - 可拍摄实物照片/视频

3. **可视化展示**
   - Web监控界面实时显示12拓扑
   - 3D地球视角切换
   - 适合演示和答辩

4. **完整的系统验证**
   - 测试真实分布式开销
   - 验证部署可行性
   - 发现单机测试无法发现的问题

### ❌ 缺点

1. **部署复杂** ⭐⭐⭐⭐
   - 需要配置7台设备
   - 需要网络布线/配置
   - 需要同步时钟
   - SSH远程管理

2. **调试困难**
   - 多节点日志分散
   - 网络问题难排查
   - 一台故障影响全局

3. **时间成本高** (5-7天)
   - Day 1-2: 硬件配置
   - Day 3-4: 网络调试
   - Day 5: 自动化脚本
   - Day 6-7: 运行实验

4. **故障风险高**
   - 网络不稳定
   - 飞腾派死机/断电
   - SSH连接中断
   - TC配置冲突

5. **可重复性一般**
   - 真实网络有波动
   - 难以完全复现结果
   - 需要多次重复实验

### 📈 论文价值评估

**可以支撑的论文论点**:
- ✅ PQ-NTOR在真实SAGIN网络的性能
- ✅ 分布式系统部署开销
- ✅ 多跳中继的真实延迟
- ✅ 协作链路的实际效果
- ✅ 系统可行性验证

**适用期刊/会议**:
- ⭐⭐⭐⭐⭐ 系统类顶会（USENIX Security, NSDI, INFOCOM）
- ⭐⭐⭐⭐⭐ 网络类期刊（ToN, TIFS）
- 适合: 所有重视实际部署的venue

---

## 🎯 混合方案（推荐）⭐

### 策略: 两阶段实验

#### **阶段1: 单机快速验证** (1-2天)
- 使用1个飞腾派或WSL
- 快速测试所有12拓扑
- 验证PQ-NTOR基础性能
- 调试测试脚本
- **产出**: 初步数据、完善的测试脚本

#### **阶段2: 分布式真实验证** (3-5天)
- 使用7个飞腾派
- 复用阶段1的测试脚本
- 运行真实分布式实验
- 收集高质量数据
- **产出**: 论文级数据、演示系统

### 优点
- ✅ 快速迭代（阶段1）
- ✅ 高质量数据（阶段2）
- ✅ 脚本可复用
- ✅ 风险可控（阶段1先验证）

---

## 📋 决策建议

### 如果时间紧张 (< 1周)
→ **选择方案A** (1个飞腾派)
- 快速产出基础数据
- 发表到算法类会议/期刊

### 如果投稿顶会 (USENIX, NSDI, INFOCOM)
→ **必须选择方案B** (7个飞腾派)
- 审稿人要求真实系统验证

### 如果资源充足 (时间+设备)
→ **推荐混合方案**
- 先单机验证脚本（1-2天）
- 再分布式真实实验（3-5天）
- 总计5-7天

---

## 🔧 我的实施建议

### 立即开始: 方案A (单机)
**原因**:
1. 测试脚本必须先写出来
2. 单机调试比分布式简单10倍
3. 可以快速验证12拓扑参数是否合理
4. 脚本可直接迁移到方案B

**具体任务**:
```bash
# 今天-明天 (Day 1-2)
1. 编写 test_pq_ntor_automated.py
2. 单机运行12拓扑测试
3. 生成初步数据和图表

# 后续 (Day 3-7，如果需要)
4. 迁移到7个飞腾派
5. 运行真实分布式实验
```

### 下一步行动

**现在需要您决定**:
1. **先做单机测试吗？** (推荐✅)
   - 我可以立即开始编写测试脚本
   - 1-2天内产出初步结果

2. **最终需要分布式数据吗？**
   - 如果投稿顶会: 需要
   - 如果仅作业/毕设: 单机足够

3. **7个飞腾派现在可用吗？**
   - 如果可用: 准备混合方案
   - 如果不可用: 先单机，等设备到位再升级

---

**建议路线**:
🚀 **今天**: 启动方案A，编写单机测试脚本
📊 **明天**: 运行12拓扑，产出初步数据
🎯 **下周**: 如果需要，升级到方案B（7个飞腾派）

**您的决定？**
