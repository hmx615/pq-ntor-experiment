# PQ-NTOR SAGIN 实验需求理解文档

**日期**: 2025-11-28
**状态**: ✅ 需求明确，准备重新设计实验

---

## 🎯 核心目标（非常清晰）

### 最终产出
**绘制2张性能曲线图**，类似上一篇NTRU密钥交换协议论文中的STK实验图：

```
图1: PQ-NTOR Average Handshake Time vs Communication Rate
  X轴: Communication Rate (Mbps)
  Y轴: Average Handshake Time (ms)
  曲线: PQ-NTOR在不同速率下的握手延迟

图2: PQ-NTOR Average Handshake Time vs Packet Loss
  X轴: Packet Loss Rate (%)
  Y轴: Average Handshake Time (ms)
  曲线: PQ-NTOR在不同丢包率下的握手延迟
```

### 实验本质
- ✅ **测试PQ-NTOR在不同网络条件下的性能**
- ✅ **使用真实SAGIN网络参数**（师妹提供的物理模型计算）
- ✅ **不关心具体的SAGIN拓扑细节**（老师已设计好12个专业NOMA拓扑）
- ✅ **替代STK仿真**（上次用STK，这次用师妹的Python模型）

---

## 📊 上一篇论文的参考（NTRU密钥交换）

### STK实验设计
1. **场景**: 卫星通信环境
2. **变量1**: Communication Rate（通信速率）
   - 范围: 可能是10-100 Mbps
   - 测试不同速率对握手时间的影响
3. **变量2**: Packet Loss（丢包率）
   - 范围: 可能是0-5%
   - 测试丢包对握手时间的影响
4. **测量指标**: Average Handshake Time（平均握手时间）

### 为什么这次不用STK？
- STK（Satellite Tool Kit）是商业软件，配置复杂
- 师妹已经提供了Python物理层模型，可以直接计算
- 更灵活，可以自定义参数

---

## 🔑 关键理解

### 1. 12个拓扑的作用
**老师已经设计好的专业NOMA协作拓扑**，我们**不需要纠结**具体含义：
- 拓扑01: Z1 Up - 直连NOMA
- 拓扑02: Z1 Up - 双路径
- ...
- 拓扑12: Z6 Down - 双中继协作下行

**它们的作用**:
- 提供**不同的网络条件组合**（延迟、速率、丢包率）
- 覆盖SAGIN网络的多种典型场景
- 每个拓扑对应一组**真实的物理参数**

### 2. 师妹的贡献
提供**三个Python脚本**，基于无线通信物理层模型计算：
- `test_satellite_noma.py` - 卫星链路速率计算（20 GHz）
- `test_uav_noma.py` - 无人机链路速率计算（2.4 GHz）
- `test_d2d_noma.py` - D2D链路速率计算（2.4 GHz）

**模型包含**:
- 自由空间路径损耗（FSPL）
- 波束赋形增益（卫星）
- LOS/NLOS概率（UAV）
- NOMA功率分配
- SINR、速率计算

### 3. 我需要做什么
1. **使用师妹的模型计算12个拓扑的真实网络参数**
   - Communication Rate (Mbps)
   - Propagation Delay (ms)
   - Packet Loss (%) - 根据SINR推算

2. **应用这些参数到Linux TC**
   ```bash
   sudo tc qdisc add dev lo root netem \
     rate 35mbit \
     delay 20ms \
     loss 1.25%
   ```

3. **运行PQ-NTOR测试，测量握手时间**
   - 每个拓扑测试N次（如10次）
   - 记录平均握手时间、成功率

4. **绘制性能曲线图**
   - 图1: 握手时间 vs 速率
   - 图2: 握手时间 vs 丢包率

---

## 🚫 不需要做的事情

1. ❌ **不需要理解12个NOMA拓扑的具体协作机制**
   - 那是老师的专业领域
   - 我们只需要知道它们对应的网络参数

2. ❌ **不需要设计新的拓扑**
   - 12个拓扑已经确定

3. ❌ **不需要证明SAGIN网络架构的优越性**
   - 我们的目标是测试PQ-NTOR，不是SAGIN

4. ❌ **不需要飞腾派实测**（至少现阶段）
   - 可以在WSL本地完成
   - 如果老师要求，后续可以部署到飞腾派

5. ❌ **不需要240次大规模测试**
   - 上次的240次是在**没有真实参数**的情况下跑的
   - 现在有真实参数，每个拓扑10-20次足够

---

## 📋 实验设计方案

### 阶段1: 参数计算（1-2天）

**任务**: 为12个拓扑计算真实网络参数

**方法**:
```python
# 示例: 拓扑01 - 卫星直连地面
# 根据拓扑定义，确定节点位置
sat_pos = np.array([-118056.04, 14085.41, 813291.98])  # 师妹提供
user_pos = np.array([5000.0, 3000.0, 0.0])  # 根据拓扑定义

# 使用师妹的模型计算速率
from test_satellite_noma import oma_rate_single_device
rate_mbps, sinr, gain = oma_rate_single_device(
    sat_pos, user_pos,
    P_tx_W=20.0,
    B_Hz=20e6,
    is_uav=False
)

# 计算传播延迟
distance = np.linalg.norm(user_pos - sat_pos)
delay_ms = distance / 3e8 * 1000

# 根据SINR推算丢包率
sinr_db = 10 * np.log10(sinr)
if sinr_db > 20:
    loss_percent = 0.1
elif sinr_db > 10:
    loss_percent = 1.0
elif sinr_db > 0:
    loss_percent = 2.0
else:
    loss_percent = 5.0
```

**输出**: `topology_params.json`
```json
{
  "topo01": {
    "rate_mbps": 35.06,
    "delay_ms": 2.72,
    "loss_percent": 1.25,
    "sinr_db": 3.75
  },
  "topo02": { ... },
  ...
}
```

### 阶段2: 实验执行（1-2天）

**任务**: 使用真实参数测试PQ-NTOR

**脚本**:
```python
# run_pq_ntor_with_real_params.py

import json
import subprocess

# 加载真实参数
with open('topology_params.json') as f:
    params = json.load(f)

results = []

for topo_id, param in params.items():
    # 应用TC参数
    apply_tc(param['rate_mbps'], param['delay_ms'], param['loss_percent'])

    # 运行PQ-NTOR测试（10次）
    handshake_times = []
    for run in range(10):
        time_ms = run_pq_ntor_handshake()
        handshake_times.append(time_ms)

    # 记录结果
    results.append({
        'topo_id': topo_id,
        'rate_mbps': param['rate_mbps'],
        'loss_percent': param['loss_percent'],
        'avg_handshake_ms': np.mean(handshake_times),
        'std_handshake_ms': np.std(handshake_times)
    })

    # 清除TC配置
    clear_tc()

# 保存结果
save_results(results)
```

### 阶段3: 数据分析与可视化（1天）

**任务**: 绘制两张关键图表

**图1: 握手时间 vs 通信速率**
```python
import matplotlib.pyplot as plt

# 提取数据
rates = [r['rate_mbps'] for r in results]
times = [r['avg_handshake_ms'] for r in results]
errors = [r['std_handshake_ms'] for r in results]

# 绘图
plt.figure(figsize=(10, 6))
plt.errorbar(rates, times, yerr=errors, fmt='o-', capsize=5)
plt.xlabel('Communication Rate (Mbps)')
plt.ylabel('Average Handshake Time (ms)')
plt.title('PQ-NTOR Performance vs Communication Rate in SAGIN')
plt.grid(True)
plt.savefig('fig1_handshake_vs_rate.pdf')
```

**图2: 握手时间 vs 丢包率**
```python
# 提取数据
losses = [r['loss_percent'] for r in results]
times = [r['avg_handshake_ms'] for r in results]

# 绘图
plt.figure(figsize=(10, 6))
plt.errorbar(losses, times, yerr=errors, fmt='s-', capsize=5)
plt.xlabel('Packet Loss Rate (%)')
plt.ylabel('Average Handshake Time (ms)')
plt.title('PQ-NTOR Performance vs Packet Loss in SAGIN')
plt.grid(True)
plt.savefig('fig2_handshake_vs_loss.pdf')
```

---

## 📊 预期结果

### 图表特征

**图1: 握手时间 vs 速率**
- **趋势**: 速率越高，握手时间越短（消息传输快）
- **范围**:
  - X轴: 3.47 - 161.23 Mbps（师妹模型计算范围）
  - Y轴: 预计 0.5 - 5 ms
- **关键点**:
  - 低速率（<10 Mbps）: 握手时间显著增加
  - 高速率（>50 Mbps）: 握手时间趋于平稳

**图2: 握手时间 vs 丢包率**
- **趋势**: 丢包率越高，握手时间越长（重传）
- **范围**:
  - X轴: 0.1% - 5%
  - Y轴: 预计 0.5 - 10 ms
- **关键点**:
  - 低丢包（<1%）: 影响很小
  - 高丢包（>3%）: 握手时间急剧上升

### 论文贡献点

1. **首次在真实SAGIN参数下评估PQ-NTOR**
   - 基于物理层模型，非拍脑袋参数

2. **性能边界明确**
   - 最低可支持速率：~3 Mbps
   - 最高可容忍丢包：~5%

3. **与上一篇NTRU论文对比**
   - 可以说："PQ-NTOR比NTRU在低速率下性能更好"
   - 或："丢包容忍度更高"

---

## 🔄 与之前工作的关系

### 已完成的240次测试
**状态**: 可以**保留但不作为主要结果**

**用途**:
- 附录材料：展示大规模测试的可行性
- 对比参考：说明"使用真实参数后的改进"
- 可靠性验证：100%成功率仍然有效

**不足**:
- 网络参数缺乏物理依据
- 无法回答"为什么选这些参数？"

### 新实验的优势
- ✅ 参数有物理模型支撑
- ✅ 可以回答评审的质疑
- ✅ 与上一篇论文方法一致（都基于真实参数）
- ✅ 实验规模合理（12拓扑 × 10次 = 120次）

---

## ✅ 工作计划

### Week 1: 参数计算
- [ ] 理解12个拓扑的节点配置
- [ ] 为每个拓扑分配合适的节点位置
- [ ] 使用师妹的模型计算速率、SINR
- [ ] 计算传播延迟
- [ ] 根据SINR推算丢包率
- [ ] 输出 `topology_params.json`

### Week 2: 实验执行
- [ ] 编写自动化测试脚本
- [ ] 应用TC参数
- [ ] 运行PQ-NTOR测试（12 × 10 = 120次）
- [ ] 记录握手时间、成功率
- [ ] 验证数据质量

### Week 3: 数据分析
- [ ] 绘制图1: 握手时间 vs 速率
- [ ] 绘制图2: 握手时间 vs 丢包率
- [ ] 统计分析（均值、方差、置信区间）
- [ ] 对比Classic NTOR（可选）
- [ ] 撰写实验章节

---

## 🎓 论文章节结构

### Section 5: Evaluation

**5.1 Experimental Setup**
- SAGIN网络参数来源（师妹的物理模型）
- 12个NOMA拓扑配置
- 测试环境（WSL + Linux TC）

**5.2 Parameter Calculation**
- 卫星链路速率计算（20 GHz, 20 MHz）
- UAV链路速率计算（2.4 GHz, 2 MHz）
- D2D链路速率计算
- Table: 12拓扑的真实参数

**5.3 PQ-NTOR Performance Evaluation**
- **Figure 1**: Handshake Time vs Communication Rate
- **Figure 2**: Handshake Time vs Packet Loss
- 分析：速率和丢包率对PQ-NTOR的影响

**5.4 Discussion**
- PQ-NTOR适用的网络条件
- 性能边界（最低速率、最高丢包）
- 与上一篇NTRU论文对比

---

## 🤝 角色分工

### 师妹
✅ **已完成**: 提供速率计算Python模型
- `test_satellite_noma.py`
- `test_uav_noma.py`
- `test_d2d_noma.py`

### 我（Claude + 学生）
⏳ **待完成**:
1. 使用师妹的模型计算12拓扑参数
2. 设计实验脚本
3. 运行PQ-NTOR测试
4. 分析数据、绘图
5. 撰写论文

### 老师
✅ **已提供**: 12个专业NOMA拓扑设计
⏳ **需要确认**:
- 12个拓扑的具体节点位置配置？
- 或者我自己根据拓扑名称合理分配？

---

## ❓ 待澄清问题

### 1. 12个拓扑的节点位置
**问题**: 师妹的模型需要具体的节点3D坐标
- 卫星位置：已知 `[-118056.04, 14085.41, 813291.98]`
- UAV位置：需要定义（例如 `[x, y, 1000]`）
- 用户位置：需要定义（例如 `[x, y, 0]`）

**方案A**: 老师提供每个拓扑的详细节点坐标
**方案B**: 我根据拓扑名称合理推测节点位置

**建议**: 采用方案B，我自己分配，然后请老师审核

### 2. NOMA双用户的处理
**问题**: NOMA拓扑有两个用户，计算出两个速率

**方案A**: 使用**两个速率的平均值**
**方案B**: 使用**较低速率**（瓶颈）
**方案C**: 分别绘制两个用户的曲线

**建议**: 采用方案B（瓶颈速率），因为端到端性能受限于最慢链路

### 3. 两跳链路的处理
**问题**: 有些拓扑是两跳（卫星→UAV→用户）

**方案**: 使用 `min(第一跳速率, 第二跳速率)` 作为端到端速率

---

## 📝 总结

### 核心理解
1. **目标清晰**: 绘制握手时间 vs (速率、丢包) 两张图
2. **方法明确**: 使用师妹的物理模型计算真实参数
3. **不纠结拓扑**: 12个拓扑是老师设计的专业内容
4. **实验规模**: 120次测试即可（12 × 10）

### 下一步行动
1. **立即开始**: 为12拓扑分配节点位置
2. **运行计算**: 使用师妹的模型计算参数
3. **生成配置**: 输出 `topology_params.json`
4. **请您确认**: 参数是否合理

### 预期时间
- **参数计算**: 1-2天
- **实验运行**: 1-2天
- **数据分析**: 1天
- **总计**: ~1周完成核心实验

---

**状态**: ✅ 需求完全理解
**准备状态**: 🚀 Ready to start!
**下一步**: 为12拓扑定义节点位置并计算参数

---

**文档版本**: v1.0
**创建时间**: 2025-11-28
**作者**: Claude (基于用户澄清)
