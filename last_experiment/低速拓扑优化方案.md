# 低速拓扑优化方案分析

**问题拓扑**: topo02, topo09, topo11
**当前速率**: 3.60 Mbps, 3.60 Mbps, 1.59 Mbps
**共同问题**: D2D链路成为严重瓶颈（SINR仅3-4dB，甚至负值）

---

## 🔍 问题根因分析

### topo02: 3.60 Mbps
**瓶颈链路**: `t_ground → s2_r1_ground` (D2D链路)
- 速率: 3.60 Mbps
- SINR: 3.95 dB (极低！)
- 距离: 1000m
- **问题**: D2D功率仅0.2W，远距离传输能力差

### topo09: 3.60 Mbps
**瓶颈链路**: `t1_ground → t2_ground` (D2D协作链路)
- 速率: 3.60 Mbps
- SINR: 3.95 dB (极低！)
- 距离: 1000m
- **问题**: 已经从2.8km缩短到1km了，仍然很慢

### topo11: 1.59 Mbps ⚠️⚠️
**瓶颈链路**: `t1_ground → t2_ground` (D2D协作链路)
- 速率: 1.59 Mbps
- SINR: -1.33 dB (负值！！！)
- 距离: 1500m
- **问题**: 最严重，SINR为负，几乎无法通信

---

## 💡 优化方案对比

### 方案A: 缩短距离 ✅ 最简单
**适用**: 所有3个拓扑

#### topo02优化
```python
# 当前配置
"t_ground": np.array([7000.0, 0.0, GROUND_HEIGHT]),       # 距S2/R1约1km
"s2_r1_ground": np.array([8000.0, 0.0, GROUND_HEIGHT]),

# 优化方案：缩短到500m
"t_ground": np.array([7500.0, 0.0, GROUND_HEIGHT]),       # 距S2/R1仅500m
"s2_r1_ground": np.array([8000.0, 0.0, GROUND_HEIGHT]),
```
**预期效果**: 速率从3.60 Mbps → ~8-10 Mbps

#### topo09优化
```python
# 当前配置
"t1_ground": np.array([3500.0, 0.0, GROUND_HEIGHT]),
"t2_ground": np.array([4500.0, 0.0, GROUND_HEIGHT]),      # 距离1km

# 优化方案：缩短到500m
"t1_ground": np.array([3500.0, 0.0, GROUND_HEIGHT]),
"t2_ground": np.array([4000.0, 0.0, GROUND_HEIGHT]),      # 距离500m
```
**预期效果**: 速率从3.60 Mbps → ~8-10 Mbps

#### topo11优化
```python
# 当前配置
"t1_ground": np.array([7500.0, 0.0, GROUND_HEIGHT]),
"t2_ground": np.array([9000.0, 0.0, GROUND_HEIGHT]),      # 距离1.5km

# 优化方案：缩短到500m
"t1_ground": np.array([7500.0, 0.0, GROUND_HEIGHT]),
"t2_ground": np.array([8000.0, 0.0, GROUND_HEIGHT]),      # 距离500m
```
**预期效果**: 速率从1.59 Mbps → ~8-10 Mbps

**优点**:
- ✅ 最简单，只需修改坐标
- ✅ 不改变物理模型
- ✅ 符合实际（用户距离本就应该近）

**缺点**:
- ❌ 所有D2D链路都需要<500m才能保证速率
- ❌ 不够真实（用户不可能总是靠很近）

---

### 方案B: 增加D2D发射功率 ⚠️ 需改模型

**原理**: D2D功率从0.2W提升到1W或2W

#### 修改师妹的模型
```python
# test_d2d_noma.py
def d2d_oma_rate(pos1, pos2, P_tx_W=0.2, B_Hz=2e6):  # 当前
def d2d_oma_rate(pos1, pos2, P_tx_W=1.0, B_Hz=2e6):  # 优化方案1
def d2d_oma_rate(pos1, pos2, P_tx_W=2.0, B_Hz=2e6):  # 优化方案2
```

**预期效果**（以topo11为例）:
| 功率 | 距离 | 预期速率 | SINR |
|------|------|---------|------|
| 0.2W | 1.5km | 1.59 Mbps | -1.33 dB ⚠️ |
| 1.0W | 1.5km | ~8-10 Mbps | ~10 dB ✓ |
| 2.0W | 1.5km | ~15-18 Mbps | ~13 dB ✓ |

**优点**:
- ✅ 可以保持用户距离真实性
- ✅ 符合实际（可以为D2D分配更大功率）

**缺点**:
- ❌ 需要修改师妹的模型参数
- ❌ 需要验证新功率值的合理性
- ❌ 所有D2D链路都会受影响（包括其他拓扑）

---

### 方案C: 增加D2D带宽 ⚠️ 需改模型

**原理**: D2D带宽从2MHz提升到10MHz或20MHz

#### 修改师妹的模型
```python
# test_d2d_noma.py
def d2d_oma_rate(pos1, pos2, P_tx_W=0.2, B_Hz=2e6):    # 当前2MHz
def d2d_oma_rate(pos1, pos2, P_tx_W=0.2, B_Hz=10e6):   # 优化方案1: 10MHz
def d2d_oma_rate(pos1, pos2, P_tx_W=0.2, B_Hz=20e6):   # 优化方案2: 20MHz
```

**预期效果**: 速率提升5-10倍（香农公式 C = B * log2(1+SINR)）

**优点**:
- ✅ 可以保持用户距离真实性
- ✅ 带宽分配灵活，容易调整

**缺点**:
- ❌ D2D通常用2.4GHz ISM频段，带宽有限
- ❌ 与UAV链路冲突（UAV也用2MHz）
- ❌ 需要验证频谱分配合理性

---

### 方案D: UAV中继代替D2D ✅ 架构优化

**原理**: 不使用D2D直接通信，改用UAV中继

#### topo09改造示例
```python
# 当前架构（D2D协作）
SAT → UAV → T1
           → T2
T1 ----→ T2  (D2D 3.60 Mbps ⚠️)

# 优化架构（UAV双路径）
SAT → UAV → T1 (高RSSI，近)
         → T2 (低RSSI，远)
(移除T1→T2链路)
```

**修改节点定义**:
```python
# 当前
"topo09": {
    "links": [
        ("sat", "s_r_uav", "卫星链路"),
        ("s_r_uav", "t1_ground", "空/地-高RSSI"),
        ("s_r_uav", "t2_ground", "空/地-低RSSI"),
        ("t1_ground", "t2_ground", "协作链路(D2D)"),  # 移除这条
    ]
}
```

**预期效果**:
- 瓶颈从`t1→t2 D2D (3.60 Mbps)` 变为 `UAV→t2 (20-29 Mbps)`
- 速率提升至 20+ Mbps

**优点**:
- ✅ 速率大幅提升
- ✅ 不需要修改物理模型
- ✅ 更符合实际（UAV中继优于D2D）

**缺点**:
- ❌ 改变了拓扑结构（不再是"协作下行"）
- ❌ 需要老师确认是否可以修改拓扑定义

---

### 方案E: 混合方案 ✅ 推荐

**策略**: 根据拓扑特点选择不同方案

#### 针对topo02
**推荐**: 方案A（缩短距离）+ 轻微提升功率
```python
"t_ground": np.array([7500.0, 0.0, GROUND_HEIGHT]),  # 距离500m
# 并且在calculate_topology_params.py中为topo02特殊处理
if topo_id == 'topo02':
    P_tx_W = 0.5  # 略微提升D2D功率到0.5W
```
**预期速率**: ~10-12 Mbps

#### 针对topo09
**推荐**: 方案D（移除D2D协作链路）
- 改为纯UAV双路径下行
- 保持"下行NOMA"特性，只是去掉地面协作
**预期速率**: ~20 Mbps

#### 针对topo11
**推荐**: 方案A（大幅缩短距离）+ 方案B（提升功率）
```python
"t1_ground": np.array([7500.0, 0.0, GROUND_HEIGHT]),
"t2_ground": np.array([7800.0, 0.0, GROUND_HEIGHT]),  # 距离仅300m

# 并且提升D2D功率
P_tx_W = 1.0  # 从0.2W提升到1W
```
**预期速率**: ~15-18 Mbps

---

## 🎯 我的推荐方案

### 保守方案（最小改动）
**仅使用方案A**: 缩短所有D2D距离到500m以内

**修改清单**:
```python
# topo02
"t_ground": [7500, 0, 0]  # 改为距S2/R1仅500m

# topo09
"t2_ground": [4000, 0, 0]  # 改为距T1仅500m

# topo11
"t2_ground": [7800, 0, 0]  # 改为距T1仅300m
```

**优点**:
- ✅ 改动最小，只需修改topology_node_positions.py
- ✅ 不涉及物理模型修改
- ✅ 可快速验证

**缺点**:
- ❌ 速率仍然偏低（8-10 Mbps）
- ❌ 用户距离过近，不够真实

---

### 激进方案（最佳性能）
**方案B + 方案A**: 提升D2D功率 + 适度缩短距离

**修改清单**:
1. 修改 `test_d2d_noma.py`:
```python
def d2d_oma_rate(pos1, pos2, P_tx_W=1.0, B_Hz=2e6):  # 0.2W → 1.0W
```

2. 适度调整距离:
```python
# topo02
"t_ground": [7200, 0, 0]  # 距S2/R1约800m

# topo09
"t2_ground": [4300, 0, 0]  # 距T1约800m

# topo11
"t2_ground": [8200, 0, 0]  # 距T1约700m
```

**预期效果**:
- topo02: 3.60 Mbps → ~15 Mbps
- topo09: 3.60 Mbps → ~15 Mbps
- topo11: 1.59 Mbps → ~12 Mbps

**优点**:
- ✅ 速率大幅提升
- ✅ 用户距离更真实（不需要<500m）
- ✅ 仍在合理范围内（D2D用1W功率可接受）

**缺点**:
- ❌ 需要修改师妹的模型
- ❌ 需要验证1W功率的合理性

---

### 平衡方案（推荐） ⭐
**仅针对topo11使用方案B，其他用方案A**

**修改清单**:
1. 保持师妹模型不变（P_tx_W=0.2W）
2. 在`calculate_topology_params.py`中特殊处理topo11:
```python
def calculate_link_params(node1, node2, node1_name, node2_name, topo_id=None):
    # ... 现有代码 ...

    elif is_d2d_link:
        # 特殊处理：topo11的D2D功率提升
        if topo_id == 'topo11':
            P_tx_W = 1.0  # 仅topo11提升功率
        else:
            P_tx_W = 0.2  # 其他拓扑保持默认

        rate_mbps, sinr, _ = d2d_oma_rate(
            pos1, pos2,
            P_tx_W=P_tx_W,
            B_Hz=2e6
        )
```

3. 距离调整（仅topo02/09）:
```python
# topo02
"t_ground": [7500, 0, 0]  # 缩短到500m

# topo09
"t2_ground": [4000, 0, 0]  # 缩短到500m

# topo11 - 保持当前距离，但提升功率
"t2_ground": [9000, 0, 0]  # 保持1.5km，依赖功率提升
```

**预期效果**:
- topo02: 3.60 → ~10 Mbps (距离优化)
- topo09: 3.60 → ~10 Mbps (距离优化)
- topo11: 1.59 → ~15 Mbps (功率优化)

**优点**:
- ✅ 不修改师妹的源文件
- ✅ 仅在计算脚本中特殊处理
- ✅ 灵活性高，可针对不同拓扑定制
- ✅ 保持大部分拓扑的真实性

---

## ❓ 需要您决策的问题

1. **接受度**:
   - 您能接受D2D用户距离<500m吗？（方案A）
   - 您能接受修改D2D功率到1W吗？（方案B）
   - 您能接受修改拓扑结构（移除D2D协作）吗？（方案D）

2. **目标速率**:
   - 您希望这3个拓扑达到多少速率？
   - 5-10 Mbps：方案A足够
   - 15-20 Mbps：需要方案B或D
   - >20 Mbps：必须用方案D

3. **论文需求**:
   - 老师是否要求必须保留"D2D协作"场景？
   - 如果是，只能用方案A/B/C
   - 如果不是，方案D最优

---

## 🔧 快速验证方法

我可以帮您快速测试不同方案的效果，只需5分钟：

```python
# 测试不同距离下的D2D速率
from test_d2d_noma import d2d_oma_rate
import numpy as np

distances = [300, 500, 800, 1000, 1500]
powers = [0.2, 0.5, 1.0, 2.0]

for P in powers:
    print(f"\n功率 {P}W:")
    for d in distances:
        pos1 = np.array([0, 0, 0])
        pos2 = np.array([d, 0, 0])
        rate, sinr, _ = d2d_oma_rate(pos1, pos2, P_tx_W=P, B_Hz=2e6)
        sinr_db = 10*np.log10(sinr)
        print(f"  {d}m: {rate:.2f} Mbps, SINR {sinr_db:.2f} dB")
```

**您希望我运行这个测试，帮您找到最优的距离+功率组合吗？**

---

**文档版本**: v1.0
**创建时间**: 2025-11-28
**等待决策**: 选择优化方案（A/B/C/D/E）
