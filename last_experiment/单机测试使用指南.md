# PQ-NTOR单机性能测试使用指南

**创建时间**: 2025-11-28
**测试环境**: 单个飞腾派/WSL/Linux
**测试目标**: 验证PQ-NTOR在12种SAGIN拓扑下的性能

---

## 🚀 快速开始

### 1. 环境检查

```bash
cd /home/ccc/pq-ntor-experiment/last_experiment

# 方法1: 运行Python快速检查
python3 -c "
import sys
from pathlib import Path
print('Python版本:', sys.version.split()[0])
print('PQ-NTOR程序:', '✓' if Path('../c/benchmark_pq_ntor').exists() else '✗')
print('拓扑参数:', '✓' if Path('topology_tc_params.json').exists() else '✗')
"

# 方法2: 运行完整检查脚本
bash quick_compatibility_test.sh
```

**预期输出**:
```
✓ 环境就绪，可以运行测试！
```

---

### 2. 运行测试

```bash
# 运行完整的12拓扑测试
python3 test_pq_ntor_single_machine.py
```

**测试过程**:
- 自动测试12个拓扑
- 每个拓扑100次PQ-NTOR握手
- 预计耗时: 2-5分钟

---

### 3. 查看结果

测试完成后，会生成3个文件：

```bash
results/
├── handshake_times.json         # 详细的握手时间数据
├── performance_summary.csv      # 性能汇总表格
└── comparison_plots.png         # 对比图表
```

**查看CSV报告**:
```bash
cat results/performance_summary.csv
```

**查看图表** (如果在有GUI的环境):
```bash
# Ubuntu/Linux
xdg-open results/comparison_plots.png

# WSL (需要安装WSLg)
explorer.exe results/comparison_plots.png
```

---

## 📊 预期结果示例

### 控制台输出
```
======================================================================
                    PQ-NTOR 性能测试结果摘要
======================================================================

Topo     Rate       Delay      Loss     Mean(µs)     P95(µs)
----------------------------------------------------------------------
topo01   31.81 Mbps  5.42 ms   2.0%       48.50       52.30
topo02    8.77 Mbps  5.44 ms   2.0%       49.20       53.10
topo03   20.53 Mbps  2.73 ms   0.1%       47.80       51.50
...
======================================================================

总体统计:
  平均握手时间: 48.92 µs
  最快: 47.50 µs
  最慢: 50.80 µs
```

### CSV报告格式
```csv
Topology,Rate(Mbps),Delay(ms),Loss(%),Mean(µs),Median(µs),StdDev(µs),...
topo01,31.81,5.42,2.0,48.50,48.20,3.45,42.10,65.30,52.30,58.40
topo02,8.77,5.44,2.0,49.20,48.90,3.62,43.20,66.50,53.10,59.20
...
```

---

## 🔧 高级配置

### 修改测试参数

编辑 `test_pq_ntor_single_machine.py`:

```python
# 在文件开头的配置部分

# 每个拓扑测试次数（默认100）
NUM_HANDSHAKES_PER_TOPO = 100  # 可改为 50, 200, 1000 等

# 预热次数（默认10）
WARMUP_RUNS = 10  # 建议保持10-20
```

### 只测试特定拓扑

修改主程序循环部分：

```python
# 只测试topo01, topo02, topo03
for topo_id in ['topo01', 'topo02', 'topo03']:
    topo_params = topo_params_dict[topo_id]
    # ...
```

---

## 🐛 故障排除

### 问题1: benchmark_pq_ntor 未找到

**错误信息**:
```
错误: 找不到PQ-NTOR测试程序: ../c/benchmark_pq_ntor
```

**解决方法**:
```bash
cd ../c
make benchmark_pq_ntor
cd ../last_experiment
```

---

### 问题2: 没有握手时间数据

**现象**:
```
警告: 未获取到握手时间数据
```

**可能原因**:
1. benchmark_pq_ntor 输出格式不匹配
2. 程序崩溃或超时

**调试方法**:
```bash
# 手动运行benchmark程序查看输出
cd ../c
./benchmark_pq_ntor 10
```

**预期输出格式**:
```
Handshake time: 48.5 µs
Handshake time: 49.2 µs
...
```

或CSV格式:
```
1,48.5
2,49.2
...
```

---

### 问题3: matplotlib未安装（图表生成失败）

**警告信息**:
```
警告: matplotlib未安装，跳过图表生成
```

**解决方法**:
```bash
pip3 install matplotlib
```

这不影响数据收集，只是无法生成PNG图表。

---

## 📈 数据分析建议

### 关注的指标

1. **平均握手时间**: 反映整体性能
2. **P95/P99时间**: 反映最坏情况
3. **标准差**: 反映稳定性

### 对比分析

**网络参数 vs 握手时间**:
- 速率对握手时间的影响（预期：无显著影响）
- 延迟对握手时间的影响（预期：无显著影响）
- 丢包对握手时间的影响（预期：无显著影响）

**原因**: PQ-NTOR握手主要是计算密集型，网络参数影响数据传输而非握手本身。

**单机测试 vs 真实环境**:
- 单机: 测试纯计算性能
- 真实网络: 测试端到端性能（包含网络开销）

---

## ✅ 测试清单

运行测试前检查:

- [ ] Python3已安装 (version ≥ 3.7)
- [ ] benchmark_pq_ntor已编译
- [ ] topology_tc_params.json存在
- [ ] results/目录可写

测试完成后验证:

- [ ] 所有12个拓扑都有数据
- [ ] 平均握手时间在 40-60 µs 范围
- [ ] CSV文件格式正确
- [ ] JSON文件可解析

---

## 🔄 下一步

### 单机测试完成后

1. **数据分析**:
   - 查看CSV报告
   - 分析图表
   - 编写初步结论

2. **升级到分布式** (如果需要):
   - 准备7个飞腾派
   - 配置网络
   - 部署真实TC参数
   - 运行真实分布式实验

3. **论文撰写**:
   - 使用单机数据展示基础性能
   - 使用分布式数据展示真实SAGIN性能

---

## 📞 技术支持

如遇到问题，检查:

1. **日志输出**: 脚本会打印详细的执行日志
2. **错误信息**: 注意 [ERROR] 标记的行
3. **数据文件**: 检查 results/ 目录下的文件

**常见文件路径**:
```
/home/ccc/pq-ntor-experiment/
├── last_experiment/
│   ├── test_pq_ntor_single_machine.py  # 测试脚本
│   ├── topology_tc_params.json          # 拓扑参数
│   ├── results/                         # 结果目录
│   └── 单机测试使用指南.md              # 本文档
└── c/
    └── benchmark_pq_ntor                # PQ-NTOR程序
```

---

**文档版本**: v1.0
**最后更新**: 2025-11-28
**适用环境**: 飞腾派、WSL、Linux
