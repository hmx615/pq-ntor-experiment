# 6+1优化方案：6个节点飞腾派 + 1个全局控制台

**创建时间**: 2025-11-16
**优化目标**: 将第7个飞腾派从"备用中继"改为"全局控制台+3D总览"
**状态**: 🟢 推荐方案

---

## 🎯 核心思路

您的建议非常实用！与其让第7个飞腾派运行一个**使用率较低的备用节点**，不如让它运行**全局控制台+3D总览视图**，这样观众可以同时看到：

1. **6个节点专属视角**（飞腾派1-6）
2. **1个全局3D视图**（飞腾派7，类似当前的3d_globe_html.html）
3. **统一控制台**（飞腾派7，切换拓扑、监控状态）

---

## 📊 12个拓扑的节点需求分析

让我先分析每个拓扑实际需要多少个物理节点：

| 拓扑ID | 名称 | 需要的节点 | 节点数量 |
|--------|------|-----------|---------|
| **拓扑1** | Z1 Up-1 | SAT, S1, S2 | 3个 ✅ |
| **拓扑2** | Z1 Up-2 | SAT, S1/R2, S2/R1, T | 4个 ✅ |
| **拓扑3** | Z2 Up-1 | SAT, S/R, S1, S2, T1, T2 | 6个 ✅ |
| **拓扑4** | Z2 Up-2 | SAT, S1/R1, S2/R2 | 3个 ✅ |
| **拓扑5** | Z3 Up | SAT, S/R, T1, T2 | 4个 ✅ |
| **拓扑6** | Z4 Up | SAT, S1, S2, T | 4个 ✅ |
| **拓扑7** | Z1 Down | SAT, S1, S2 | 3个 ✅ |
| **拓扑8** | Z2 Down | SAT, S1/R1, S2/R2, T | 4个 ✅ |
| **拓扑9** | Z3 Down | SAT, S/R, T1, T2 | 4个 ✅ |
| **拓扑10** | Z4 Down | SAT, S1/R1, S2/R2, T1, T2 | 5个 ✅ |
| **拓扑11** | Z5 Down | SAT, S1, S2, T1, T2 | 5个 ✅ |
| **拓扑12** | Z6 Down | SAT, S1, S2, T1, T2 | 5个 ✅ |

### 关键发现

✅ **所有12个拓扑都只需要最多6个节点**（拓扑3需要6个）
✅ **没有任何拓扑需要7个节点**
✅ **第7个飞腾派完全可以用作全局控制台**

---

## 🏗️ 优化后的6+1架构

### 节点角色重新分配

| 飞腾派 | IP地址 | 角色 | 用途 | 拓扑参与度 |
|--------|--------|------|------|-----------|
| **Pi-1** | 192.168.100.11 | 🛰 卫星 (SAT) | SAGIN核心节点 | 全部12个拓扑 |
| **Pi-2** | 192.168.100.12 | ✈ 无人机1 (S/R, S1/R1) | 空中中继 | 10个拓扑 |
| **Pi-3** | 192.168.100.13 | ✈ 无人机2 (S1/R2, S2/R2) | 空中中继 | 6个拓扑 |
| **Pi-4** | 192.168.100.14 | 📱 终端1 (S1, T1) | 地面用户 | 10个拓扑 |
| **Pi-5** | 192.168.100.15 | 📱 终端2 (S2, T2) | 地面用户 | 10个拓扑 |
| **Pi-6** | 192.168.100.16 | 📱 终端3 (T, S2/R1) | 地面用户 | 8个拓扑 |
| **Pi-7** | 192.168.100.17 | 🎮 **全局控制台** | 控制+总览 | **不参与拓扑** |

### Pi-7的新功能

飞腾派7不再运行SAGIN节点，而是运行：

1. **全局3D地球视图**
   - 复用当前的 `3d_globe_html.html`
   - 显示所有节点的全局视角
   - 实时更新6个节点的位置、连接、流量

2. **拓扑切换控制台**
   - Web界面控制拓扑切换
   - 一键切换12种拓扑
   - 同步通知其他6个飞腾派

3. **监控仪表盘**
   - 显示6个节点的实时状态
   - 流量统计、延迟监控
   - PQ-NTOR握手次数

4. **中央WebSocket Hub**
   - 收集所有节点数据
   - 分发到其他节点和前端
   - 协调拓扑切换

---

## 🖥️ 7个屏幕的展示效果

### 物理布局建议

```
观众视角：

┌─────────┐  ┌─────────┐  ┌─────────┐
│ 屏幕1    │  │ 屏幕2    │  │ 屏幕3    │
│ 🛰卫星   │  │ ✈无人机1 │  │ ✈无人机2 │
│ (Pi-1)  │  │ (Pi-2)  │  │ (Pi-3)  │
└─────────┘  └─────────┘  └─────────┘

┌─────────┐  ┌─────────┐  ┌─────────┐
│ 屏幕4    │  │ 屏幕5    │  │ 屏幕6    │
│ 📱终端1  │  │ 📱终端2  │  │ 📱终端3  │
│ (Pi-4)  │  │ (Pi-5)  │  │ (Pi-6)  │
└─────────┘  └─────────┘  └─────────┘

        ┌─────────────────┐
        │  屏幕7 (中央)     │
        │  🌍 全局3D视图   │
        │  🎮 控制台       │
        │     (Pi-7)      │
        └─────────────────┘
```

### 屏幕7的界面设计

```
┌──────────────────────────────────────────────────────┐
│  🌍 SAGIN NOMA演示系统 - 全局控制台                    │
├────────────────────────┬─────────────────────────────┤
│                        │  🎮 拓扑控制                 │
│   🌍 3D地球全局视图     │  ┌─────────────────────┐   │
│                        │  │ 当前拓扑: Topology 1 │   │
│  (Globe.GL 实时渲染)   │  └─────────────────────┘   │
│                        │                             │
│  - 显示所有6个节点     │  拓扑切换:                   │
│  - 实时连接线闪烁      │  [1] [2] [3] [4] [5] [6]   │
│  - 流量动画效果        │  [7] [8] [9] [10][11][12]  │
│  - 旋转/缩放          │                             │
│                        │  📊 系统监控                 │
│                        │  ├─ 节点在线: 6/6 🟢        │
│                        │  ├─ 活跃链路: 5条           │
│                        │  ├─ 总流量: ↑520KB/s        │
│                        │  └─ PQ-NTOR: 239次握手      │
│                        │                             │
│                        │  📱 节点状态                 │
│                        │  🛰 SAT: 🟢 100% [详情]     │
│                        │  ✈ S/R: 🟢 98% [详情]      │
│                        │  ✈ S1/R2: 🟢 95% [详情]    │
│                        │  📱 S1: 🟢 100% [详情]      │
│                        │  📱 S2: 🟢 99% [详情]       │
│                        │  📱 T: 🟢 97% [详情]        │
└────────────────────────┴─────────────────────────────┘
```

---

## 🔗 系统通信架构

### WebSocket通信拓扑

```
                ┌─────────────────────┐
                │   Pi-7 (控制台)      │
                │  WebSocket Hub      │
                │  (端口 9000)         │
                └──────────┬──────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   [Pi-1 SAT]         [Pi-2 S/R]         [Pi-3 S1/R2]
        │                  │                  │
   [Pi-4 S1]          [Pi-5 S2]          [Pi-6 T]

数据流:
1. 各节点(Pi-1到Pi-6) → WebSocket → Pi-7
2. Pi-7汇总数据 → 广播 → 各节点前端
3. Pi-7控制台 → 拓扑切换命令 → 各节点
```

### Pi-7的软件栈

```
Pi-7 (全局控制台飞腾派):
├─ Nginx (端口80)
│   └─ 静态文件服务
│       ├─ control_panel.html (控制台界面)
│       ├─ 3d_globe_html.html (全局3D视图)
│       └─ js/css资源
│
├─ WebSocket Hub (端口9000)
│   ├─ 接收6个节点数据
│   ├─ 实时汇总和转发
│   └─ 广播拓扑切换命令
│
└─ Flask REST API (端口5000)
    ├─ GET /api/topology (当前拓扑)
    ├─ POST /api/topology (切换拓扑)
    ├─ GET /api/nodes (所有节点状态)
    └─ GET /api/stats (统计数据)
```

---

## ✅ 6+1方案的优势

| 维度 | 原7节点方案 | 6+1优化方案 | 优势 |
|------|------------|------------|------|
| **展示效果** | 7个节点视角 | 6节点+1全局视角 | ✅ 更好：全局视图更直观 |
| **控制方式** | 需要额外电脑控制 | Pi-7自带控制台 | ✅ 更简单：一体化控制 |
| **观众体验** | 只看节点视角 | 同时看节点+全局 | ✅ 更清晰：双重视角 |
| **拓扑覆盖** | 100% (但有节点闲置) | 100% (无节点闲置) | ✅ 更高效：资源利用率高 |
| **成本** | ¥15,000 | ¥15,000 | ⚖️ 相同 |
| **复杂度** | 7个节点协调 | 6节点+1控制台 | ✅ 更低：集中管理 |

---

## 🛠️ 实现调整

### 修改部署脚本

**原deploy_all.sh**:
```bash
NODES=(
    "192.168.100.11:SAT:satellite"
    "192.168.100.12:SR:aircraft"
    "192.168.100.13:S1:ground"
    "192.168.100.14:S2:ground"
    "192.168.100.15:T:ground"
    "192.168.100.16:S1R1:aircraft"
    "192.168.100.17:S2R2:aircraft"  # ← 改为控制台
)
```

**新deploy_6plus1.sh**:
```bash
# 6个SAGIN节点
NODES=(
    "192.168.100.11:SAT:satellite"
    "192.168.100.12:SR:aircraft"
    "192.168.100.13:S1R2:aircraft"
    "192.168.100.14:S1:ground"
    "192.168.100.15:S2:ground"
    "192.168.100.16:T:ground"
)

# 单独部署控制台
CONTROL_CONSOLE="192.168.100.17"

# 部署6个节点
for node in "${NODES[@]}"; do
    # ... 原有节点部署逻辑
done

# 部署控制台 (Pi-7)
echo "部署全局控制台到 $CONTROL_CONSOLE..."
scp -r control_panel frontend/3d_globe_html.html websocket_hub pi@$CONTROL_CONSOLE:/home/pi/sagin-control/
ssh pi@$CONTROL_CONSOLE << 'EOF'
    cd /home/pi/sagin-control
    docker-compose -f docker-compose-control.yml up -d
    echo "✅ 控制台部署完成"
EOF
```

### Pi-7的docker-compose配置

**docker-compose-control.yml**:
```yaml
version: '3'
services:
  # WebSocket Hub
  websocket-hub:
    build: ./websocket_hub
    ports:
      - "9000:9000"
    environment:
      - NODE_IPS=192.168.100.11,192.168.100.12,192.168.100.13,192.168.100.14,192.168.100.15,192.168.100.16

  # Flask API
  api-server:
    build: ./api
    ports:
      - "5000:5000"
    depends_on:
      - websocket-hub

  # Nginx前端
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
```

---

## 📋 实施步骤调整

### Phase 1: 后台服务开发 (2天)
不变，但增加：
- `websocket_hub.py` (Pi-7的WebSocket中心)
- `control_panel.html` (控制台界面)

### Phase 2: 前端界面开发 (1.5天)
新增：
- Pi-7的全局视图（复用3d_globe_html.html，添加实时数据）
- Pi-7的控制台界面

### Phase 3: Docker配置 (1天)
调整：
- Pi-1到Pi-6: 节点配置
- Pi-7: 控制台配置（新增）

### Phase 4: 一键部署脚本 (0.5天)
调整：
- `deploy_6plus1.sh` (区分节点和控制台)

### Phase 5: 测试和优化 (1天)
不变

---

## 🎯 推荐方案总结

### ✅ 强烈推荐6+1方案

**理由**:
1. **展示效果更好**: 观众能同时看到节点视角和全局视角
2. **控制更方便**: 一体化控制台，无需额外设备
3. **资源利用率高**: 没有闲置节点
4. **技术实现简单**: Pi-7不需要运行复杂的SAGIN节点
5. **成本不变**: 依然是7个飞腾派 + 7个屏幕

### 典型演示流程

1. **观众站在屏幕7前** (控制台)
2. **讲解员点击"拓扑3"按钮**
3. **屏幕7的3D地球立即切换到拓扑3** (全局视角)
4. **同时，屏幕1-6同步切换** (各节点视角)
5. **观众可以同时看到**:
   - 屏幕7: 整体网络结构、数据流动
   - 屏幕1-6: 每个节点的第一视角、实时状态

---

## 📞 下一步

如果您确认采用**6+1方案**，我可以立即开始：

1. ✅ 创建 `websocket_hub.py` (Pi-7的中央WebSocket服务)
2. ✅ 创建 `control_panel.html` (Pi-7的控制台界面)
3. ✅ 修改 `3d_globe_html.html` 支持实时数据（用于Pi-7）
4. ✅ 编写 `deploy_6plus1.sh` 部署脚本
5. ✅ 更新节点角色分配文档

---

**创建时间**: 2025-11-16
**版本**: v1.0
**状态**: 🟢 推荐采用

