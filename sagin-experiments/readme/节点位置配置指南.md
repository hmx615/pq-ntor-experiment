# 节点位置配置指南

**文档版本**: v1.0
**创建时间**: 2025-11-20
**适用系统**: SAGIN NOMA 6+1分布式展示系统

---

## 📍 概述

本文档详细说明6+1系统中所有节点的地理位置配置方法，包括坐标系统、配置文件位置、修改方法、以及最佳实践。

---

## 🌐 坐标系统

### 坐标格式

系统使用**WGS84地理坐标系**（GPS标准坐标系）：

| 参数 | 符号 | 范围 | 单位 | 说明 |
|------|------|------|------|------|
| **纬度** | `lat` | -90° ~ +90° | 度 (°) | 正值=北纬，负值=南纬 |
| **经度** | `lon` | -180° ~ +180° | 度 (°) | 正值=东经，负值=西经 |
| **高度** | `alt` | 0 ~ 1 | 归一化 | Globe.GL使用的相对高度 |

### 高度说明

高度使用**归一化值**（相对地球半径）：

| 节点类型 | 高度值 | 实际意义 | 视觉效果 |
|---------|--------|----------|----------|
| **地面终端** | 0 | 地表 | 贴在地球表面 |
| **无人机** | 0.05 | 低空 (~5-10km) | 略微离开地表 |
| **卫星** | 0.15 | 轨道 (~1000km) | 明显高于地表 |

**计算公式**: `alt = 实际高度(km) / 地球半径(6371km)`

---

## 📂 配置文件位置

### 两个配置文件

节点位置在**两个HTML文件**中配置，必须**同步修改**：

```
distributed-demo/
└── frontend/
    ├── control-panel/
    │   └── index.html          # ⭐ 配置文件1：控制台视图
    └── node-view/
        └── index.html          # ⭐ 配置文件2：节点视图
```

### 配置对象

两个文件中都有 `nodeConfigs` 对象：

**control-panel/index.html** (第378-385行):
```javascript
const nodeConfigs = {
    'SAT': { icon: '🛰', name: '卫星', lat: 35, lon: 122, alt: 0.15, type: 'satellite' },
    'SR': { icon: '✈', name: '无人机1', lat: 35, lon: 110, alt: 0.05, type: 'aircraft' },
    'S1R2': { icon: '✈', name: '无人机2', lat: 31.2, lon: 121.5, alt: 0.05, type: 'aircraft' },
    'S1': { icon: '📱', name: '终端1', lat: 39.9, lon: 116.4, alt: 0, type: 'ground' },
    'S2': { icon: '📱', name: '终端2', lat: 30, lon: 105, alt: 0, type: 'ground' },
    'T': { icon: '📱', name: '终端3', lat: 28, lon: 115, alt: 0, type: 'ground' }
};
```

**node-view/index.html** (第410-416行):
```javascript
const nodeConfigs = {
    'SAT': { icon: '🛰', name: '卫星', role: 'Satellite', lat: 35, lon: 122, alt: 0.15, type: 'satellite' },
    'SR': { icon: '✈', name: '无人机1', role: 'Aircraft', lat: 35, lon: 110, alt: 0.05, type: 'aircraft' },
    'S1R2': { icon: '✈', name: '无人机2', role: 'Aircraft', lat: 31.2, lon: 121.5, alt: 0.05, type: 'aircraft' },
    'S1': { icon: '📱', name: '终端1', role: 'Ground', lat: 39.9, lon: 116.4, alt: 0, type: 'ground' },
    'S2': { icon: '📱', name: '终端2', role: 'Ground', lat: 30, lon: 105, alt: 0, type: 'ground' },
    'T': { icon: '📱', name: '终端3', role: 'Ground', lat: 28, lon: 115, alt: 0, type: 'ground' }
};
```

**注意**: node-view 多了 `role` 字段，但位置坐标完全相同。

---

## 📊 当前节点位置

### 节点配置表

| 节点ID | 名称 | 类型 | 纬度 (lat) | 经度 (lon) | 高度 (alt) | 图标 |
|--------|------|------|------------|------------|------------|------|
| **SAT** | 卫星 | satellite | 35.0° | 122.0° | 0.15 | 🛰 |
| **SR** | 无人机1 | aircraft | 35.0° | 110.0° | 0.05 | ✈ |
| **S1R2** | 无人机2 | aircraft | 31.2° | 121.5° | 0.05 | ✈ |
| **S1** | 终端1 | ground | 39.9° | 116.4° | 0 | 📱 |
| **S2** | 终端2 | ground | 30.0° | 105.0° | 0 | 📱 |
| **T** | 终端3 | ground | 28.0° | 115.0° | 0 | 📱 |

### 地理分布图

```
       中国地图坐标分布 (大致位置)

  北 ↑
     |
     |  S1 (39.9°, 116.4°)  ← 北京附近 (终端1)
     |
     |  SAT (35°, 122°)     ← 青岛东部海域 (卫星)
     |  SR (35°, 110°)      ← 西安附近 (无人机1)
     |
     |  S1R2 (31.2°, 121.5°) ← 上海附近 (无人机2)
     |
     |  S2 (30°, 105°)      ← 成都附近 (终端2)
     |
     |  T (28°, 115°)       ← 南昌附近 (终端3)
     |
  南 ↓
    西 ←                  → 东
```

### 节点间距离

**纬度分布** (从北到南):
```
S1    39.9°  ┐
              │ 4.9°
SAT   35.0°   ├─ 同纬度
SR    35.0°   │
              │ 3.8°
S1R2  31.2°   ┤
              │ 1.2°
S2    30.0°   ┤
              │ 2.0°
T     28.0°   ┘
```

**经度分布** (从西到东):
```
S2    105.0°  ┐
              │ 5.0°
SR    110.0°  ┤
              │ 5.0°
T     115.0°  ┤
              │ 1.4°
S1    116.4°  ┤
              │ 5.1°
S1R2  121.5°  ┤
              │ 0.5°
SAT   122.0°  ┘
```

---

## 🛠️ 修改节点位置

### 方法1: 手动编辑（推荐）

**步骤**:

1. **打开配置文件**
   ```bash
   # 控制台视图
   vim distributed-demo/frontend/control-panel/index.html

   # 节点视图
   vim distributed-demo/frontend/node-view/index.html
   ```

2. **找到 nodeConfigs 对象**
   - control-panel: 第378-385行
   - node-view: 第410-416行

3. **修改目标节点坐标**

   例如，将卫星向东移动5°：
   ```javascript
   // 修改前
   'SAT': { icon: '🛰', name: '卫星', lat: 35, lon: 122, alt: 0.15, type: 'satellite' }

   // 修改后
   'SAT': { icon: '🛰', name: '卫星', lat: 35, lon: 127, alt: 0.15, type: 'satellite' }
   ```

4. **确保两个文件同步修改**

   ⚠️ 必须在两个文件中修改相同的坐标！

5. **重启服务器**
   ```bash
   cd distributed-demo/scripts
   ./test_local.sh restart
   ```

6. **刷新浏览器验证**
   - Ctrl + Shift + R (硬刷新)

### 方法2: 使用脚本（批量修改）

**创建修改脚本** `scripts/update_node_position.sh`:

```bash
#!/bin/bash
# 批量修改节点位置

NODE_ID=$1
NEW_LAT=$2
NEW_LON=$3

if [ -z "$NODE_ID" ] || [ -z "$NEW_LAT" ] || [ -z "$NEW_LON" ]; then
    echo "用法: $0 <节点ID> <纬度> <经度>"
    echo "示例: $0 SAT 35 125"
    exit 1
fi

# 查找并显示当前位置
echo "查找节点 $NODE_ID 的当前位置..."
grep "'$NODE_ID':" ../frontend/control-panel/index.html | head -1

# 修改控制台视图
echo "修改控制台视图..."
sed -i "s/\('$NODE_ID':.*lat:\s*\)[0-9.]\+\(.*lon:\s*\)[0-9.]\+/\1$NEW_LAT\2$NEW_LON/" \
    ../frontend/control-panel/index.html

# 修改节点视图
echo "修改节点视图..."
sed -i "s/\('$NODE_ID':.*lat:\s*\)[0-9.]\+\(.*lon:\s*\)[0-9.]\+/\1$NEW_LAT\2$NEW_LON/" \
    ../frontend/node-view/index.html

echo "✅ 节点 $NODE_ID 位置已更新为: lat=$NEW_LAT, lon=$NEW_LON"
echo "请运行 ./test_local.sh restart 重启服务器"
```

**使用示例**:
```bash
cd distributed-demo/scripts
chmod +x update_node_position.sh

# 将卫星移动到新位置
./update_node_position.sh SAT 35 125

# 将终端3向南移动
./update_node_position.sh T 25 115

# 重启服务器
./test_local.sh restart
```

---

## 📐 位置调整技巧

### 调整方向指南

| 方向 | 修改参数 | 数值变化 | 示例 |
|------|----------|----------|------|
| **向北** | 纬度 lat | +增加 | 35° → 40° |
| **向南** | 纬度 lat | -减少 | 35° → 30° |
| **向东** | 经度 lon | +增加 | 115° → 120° |
| **向西** | 经度 lon | -减少 | 115° → 110° |
| **升高** | 高度 alt | +增加 | 0.05 → 0.10 |
| **降低** | 高度 alt | -减少 | 0.15 → 0.10 |

### 常见调整场景

#### 场景1: 节点重叠，需要分离

**问题**: 两个节点位置太接近，图标重叠

**解决方案**:
```javascript
// 原位置（重叠）
'SAT': { lat: 35, lon: 115, ... }
'SR':  { lat: 35, lon: 115, ... }  // 完全重叠！

// 调整后（分离）
'SAT': { lat: 35, lon: 122, ... }  // 向东移动7°
'SR':  { lat: 35, lon: 110, ... }  // 保持不变
```

#### 场景2: 节点分布不均，需要重新布局

**问题**: 所有节点集中在某个区域

**解决方案**: 扩大分布范围
```javascript
// 调整前（集中）
纬度范围: 30-35° (5°范围)
经度范围: 110-120° (10°范围)

// 调整后（分散）
纬度范围: 25-40° (15°范围)
经度范围: 100-125° (25°范围)
```

#### 场景3: 需要模拟真实场景

**问题**: 需要模拟中国东部沿海SAGIN场景

**解决方案**: 使用真实城市坐标
```javascript
// 使用真实城市坐标
'S1': { lat: 39.9, lon: 116.4, ... }  // 北京
'S2': { lat: 31.2, lon: 121.5, ... }  // 上海
'T':  { lat: 22.5, lon: 114.1, ... }  // 深圳
```

### 位置调整最佳实践

✅ **推荐做法**:
- 节点间距至少相差 2-5°
- 同类型节点可以接近，但不要重叠
- 卫星应该在覆盖范围的中心
- 地面终端分散分布更真实

❌ **避免问题**:
- 不要将所有节点放在同一经纬度
- 避免节点距离太近 (<1°)
- 不要超出合理的地理范围
- 注意海洋位置（可能看不清节点）

---

## 🔗 链路自动更新

### 链路坐标绑定机制

**重要**: 链路起点和终点坐标**自动从 nodeConfigs 获取**，无需手动修改！

**代码机制** (control-panel/index.html 第611-634行):
```javascript
globe.arcsData(links)
    .arcStartLat(d => {
        const sourceNode = nodeConfigs[d.source];
        return sourceNode ? sourceNode.lat : 0;  // 自动读取起点纬度
    })
    .arcStartLng(d => {
        const sourceNode = nodeConfigs[d.source];
        return sourceNode ? sourceNode.lon : 0;  // 自动读取起点经度
    })
    .arcEndLat(d => {
        const targetNode = nodeConfigs[d.target];
        return targetNode ? targetNode.lat : 0;  // 自动读取终点纬度
    })
    .arcEndLng(d => {
        const targetNode = nodeConfigs[d.target];
        return targetNode ? targetNode.lon : 0;  // 自动读取终点经度
    })
```

**这意味着**:
- ✅ 修改 `nodeConfigs` 后，所有相关链路**自动更新**
- ✅ 不需要手动修改链路定义 (`topologyLinks`)
- ✅ 所有12种拓扑的链路都会自动适配新位置

**示例**:
```javascript
// 修改卫星位置
'SAT': { lat: 35, lon: 122, ... }  // 从115改为122

// 所有与SAT相关的链路自动更新：
拓扑1: S1→SAT, S2→SAT          ✅ 自动指向新位置
拓扑2: S1R2→SAT                ✅ 自动指向新位置
拓扑7: SAT→S1, SAT→S2          ✅ 自动从新位置出发
... (所有拓扑都自动更新)
```

---

## 🧪 测试和验证

### 修改后的验证步骤

1. **检查配置文件同步**
   ```bash
   # 对比两个文件的nodeConfigs
   diff <(grep -A 6 "const nodeConfigs" distributed-demo/frontend/control-panel/index.html) \
        <(grep -A 6 "const nodeConfigs" distributed-demo/frontend/node-view/index.html)

   # 应该只有 role 字段不同，坐标完全相同
   ```

2. **重启服务器**
   ```bash
   cd distributed-demo/scripts
   ./test_local.sh restart
   ```

3. **浏览器硬刷新**
   - Windows/Linux: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

4. **视觉验证**
   - 打开控制台: http://localhost:8080/control-panel/
   - 检查节点图标是否在预期位置
   - 旋转地球，从不同角度查看

5. **链路验证**
   - 切换不同拓扑 (1-12)
   - 检查链路是否正确连接到节点
   - 观察链路弧线是否合理

6. **节点视图验证**
   - 打开各节点视图
   - 检查当前节点是否高亮显示
   - 确认其他节点位置正确

### 调试工具

**浏览器控制台日志**:
```javascript
// 打开浏览器开发者工具 (F12) → Console

// 查找节点坐标日志 (带 🔍 图标)
🔍 SAT 起点纬度: 35
🔍 SAT 起点经度: 122
🔍 S1 终点纬度: 39.9
🔍 S1 终点经度: 116.4
```

**命令行验证**:
```bash
# 查看节点配置
grep "'SAT':" distributed-demo/frontend/control-panel/index.html

# 输出应该显示当前坐标
'SAT': { icon: '🛰', name: '卫星', lat: 35, lon: 122, alt: 0.15, type: 'satellite' }
```

---

## 📋 配置模板

### 中国区域模板

```javascript
const nodeConfigs = {
    // 卫星 - 覆盖中国东部
    'SAT': { icon: '🛰', name: '卫星', lat: 35, lon: 115, alt: 0.15, type: 'satellite' },

    // 无人机 - 中高空
    'SR': { icon: '✈', name: '无人机1', lat: 35, lon: 110, alt: 0.05, type: 'aircraft' },
    'S1R2': { icon: '✈', name: '无人机2', lat: 31.2, lon: 121.5, alt: 0.05, type: 'aircraft' },

    // 地面终端 - 分散在东部沿海
    'S1': { icon: '📱', name: '终端1', lat: 39.9, lon: 116.4, alt: 0, type: 'ground' },  // 北京
    'S2': { icon: '📱', name: '终端2', lat: 31.2, lon: 121.5, alt: 0, type: 'ground' },  // 上海
    'T': { icon: '📱', name: '终端3', lat: 22.5, lon: 114.1, alt: 0, type: 'ground' }    // 深圳
};
```

### 全球区域模板

```javascript
const nodeConfigs = {
    // 卫星 - 太平洋上空
    'SAT': { icon: '🛰', name: '卫星', lat: 0, lon: 180, alt: 0.15, type: 'satellite' },

    // 无人机 - 不同大陆
    'SR': { icon: '✈', name: '无人机1', lat: 40, lon: -100, alt: 0.05, type: 'aircraft' },  // 北美
    'S1R2': { icon: '✈', name: '无人机2', lat: 50, lon: 10, alt: 0.05, type: 'aircraft' },  // 欧洲

    // 地面终端 - 分布在三大洲
    'S1': { icon: '📱', name: '终端1', lat: 35, lon: 139, alt: 0, type: 'ground' },  // 东京
    'S2': { icon: '📱', name: '终端2', lat: 51, lon: -0.1, alt: 0, type: 'ground' },  // 伦敦
    'T': { icon: '📱', name: '终端3', lat: 40, lon: -74, alt: 0, type: 'ground' }    // 纽约
};
```

### 密集测试模板

```javascript
const nodeConfigs = {
    // 所有节点集中在小范围内（测试链路显示）
    'SAT': { icon: '🛰', name: '卫星', lat: 30, lon: 120, alt: 0.15, type: 'satellite' },
    'SR': { icon: '✈', name: '无人机1', lat: 30.5, lon: 120.5, alt: 0.05, type: 'aircraft' },
    'S1R2': { icon: '✈', name: '无人机2', lat: 31, lon: 121, alt: 0.05, type: 'aircraft' },
    'S1': { icon: '📱', name: '终端1', lat: 29.5, lon: 119.5, alt: 0, type: 'ground' },
    'S2': { icon: '📱', name: '终端2', lat: 30, lon: 119, alt: 0, type: 'ground' },
    'T': { icon: '📱', name: '终端3', lat: 31, lon: 120, alt: 0, type: 'ground' }
};
```

---

## ⚠️ 注意事项

### 必须遵守的规则

1. **两文件同步** ⭐⭐⭐
   - 必须同时修改 `control-panel/index.html` 和 `node-view/index.html`
   - 坐标必须完全一致
   - 只有 `role` 字段可以不同

2. **节点ID不可修改**
   - `'SAT'`, `'SR'`, `'S1R2'`, `'S1'`, `'S2'`, `'T'` 是固定的
   - 修改ID会导致链路定义失效

3. **类型字段必须正确**
   - `satellite`, `aircraft`, `ground` 三种类型
   - 类型决定颜色和显示效果

4. **坐标范围限制**
   - 纬度: -90 ~ +90
   - 经度: -180 ~ +180
   - 高度: 0 ~ 1 (推荐 0, 0.05, 0.15)

### 常见错误

❌ **错误1**: 只修改一个文件
```javascript
// control-panel: lon: 122 ✓
// node-view: lon: 115 ✗
// 结果：控制台和节点视图位置不一致
```

❌ **错误2**: 修改了节点ID
```javascript
// 修改前
'SAT': { ... }

// 错误修改
'SATELLITE': { ... }  // ✗ 链路找不到节点
```

❌ **错误3**: 坐标超出范围
```javascript
'SAT': { lat: 95, lon: 200, ... }  // ✗ 超出有效范围
```

❌ **错误4**: 忘记重启服务器
```
修改配置 → 刷新浏览器 → 位置没变？
原因：HTML文件被缓存，必须重启服务器
```

---

## 🔧 故障排查

### 问题1: 修改后节点位置没变

**可能原因**:
1. 浏览器缓存 → 硬刷新 (Ctrl+Shift+R)
2. 服务器未重启 → `./test_local.sh restart`
3. 修改了错误的文件 → 检查文件路径

**检查方法**:
```bash
# 查看实际配置
grep "'SAT':" distributed-demo/frontend/control-panel/index.html

# 查看浏览器加载的内容 (F12 → Sources → index.html → 搜索 nodeConfigs)
```

### 问题2: 链路没有连接到节点

**可能原因**:
1. 节点ID在链路定义中拼写错误
2. nodeConfigs 和 topologyLinks 不匹配

**检查方法**:
```bash
# 检查所有链路定义中使用的节点ID
grep "source:\|target:" distributed-demo/frontend/control-panel/index.html | sort -u
```

### 问题3: 两个文件坐标不一致

**检查命令**:
```bash
# 对比SAT节点的配置
echo "=== Control Panel ==="
grep "'SAT':" distributed-demo/frontend/control-panel/index.html

echo "=== Node View ==="
grep "'SAT':" distributed-demo/frontend/node-view/index.html

# 坐标应该完全相同
```

---

## 📚 参考资料

### 中国主要城市坐标

| 城市 | 纬度 | 经度 | 备注 |
|------|------|------|------|
| 北京 | 39.9 | 116.4 | 首都 |
| 上海 | 31.2 | 121.5 | 经济中心 |
| 广州 | 23.1 | 113.3 | 华南中心 |
| 深圳 | 22.5 | 114.1 | 科技中心 |
| 成都 | 30.7 | 104.1 | 西南中心 |
| 西安 | 34.3 | 108.9 | 西北中心 |
| 武汉 | 30.6 | 114.3 | 华中中心 |
| 哈尔滨 | 45.8 | 126.5 | 东北中心 |

### 世界主要城市坐标

| 城市 | 纬度 | 经度 | 备注 |
|------|------|------|------|
| 纽约 | 40.7 | -74.0 | 美国东海岸 |
| 伦敦 | 51.5 | -0.1 | 英国首都 |
| 东京 | 35.7 | 139.7 | 日本首都 |
| 巴黎 | 48.9 | 2.4 | 法国首都 |
| 悉尼 | -33.9 | 151.2 | 澳大利亚 |
| 莫斯科 | 55.8 | 37.6 | 俄罗斯首都 |

---

## 📝 总结

### 关键要点

1. ✅ 节点位置配置在两个HTML文件中
2. ✅ 必须同时修改，保持坐标一致
3. ✅ 链路会自动更新到新位置
4. ✅ 修改后需要重启服务器并硬刷新浏览器

### 快速修改流程

```
1. 编辑 control-panel/index.html
   └─ 修改 nodeConfigs 中的坐标

2. 编辑 node-view/index.html
   └─ 修改相同的坐标

3. 重启服务器
   └─ ./test_local.sh restart

4. 硬刷新浏览器
   └─ Ctrl + Shift + R

5. 验证效果
   └─ 检查节点和链路位置
```

---

**文档作者**: Claude AI Assistant
**最后更新**: 2025-11-20
**版本**: v1.0
**状态**: ✅ 完整
