# 7屏幕分布式SAGIN展示系统设计方案

**创建时间**: 2025-11-16
**目标**: 在7个飞腾派上部署分布式SAGIN NOMA演示系统，每个设备独立显示
**状态**: 🟡 参考方案（已有更优方案）

---

## ⚠️ 推荐阅读优化方案

**本方案已被优化为更实用的"6+1方案"**：
- 6个飞腾派运行SAGIN节点（节点专属视角）
- 1个飞腾派运行全局控制台（3D总览+拓扑控制）

**👉 强烈推荐阅读**: **[6+1优化方案.md](6+1优化方案.md)**

优势：
- ✅ 展示效果更好（同时看节点视角+全局视角）
- ✅ 控制更方便（一体化控制台）
- ✅ 资源利用率更高（无闲置节点）
- ✅ 技术实现更简单（集中管理）

如果您确定需要7个SAGIN节点部署，请继续阅读本方案。

---

## 📋 系统概述

### 核心理念
- **7个飞腾派** = 7个物理SAGIN节点
- **7块屏幕** = 7个独立视角的实时展示
- **真实后台** = Docker容器 + PQ-NTOR + WebSocket实时通信
- **统一协调** = 中央控制节点协调拓扑切换

### 与当前DEMO的区别
| 维度 | 当前DEMO (3d_globe_html.html) | 7屏幕分布式系统 |
|------|-------------------------------|-----------------|
| 展示方式 | 单个网页，全局视角 | 7个网页，每个显示一个节点视角 |
| 后台连接 | ❌ 无，纯静态展示 | ✅ 有，WebSocket实时通信 |
| 数据来源 | 硬编码的12个拓扑配置 | 真实Docker容器运行数据 |
| 交互性 | 点击切换拓扑场景 | 实时显示节点状态、通信流量 |
| 部署位置 | 1台电脑浏览器 | 7个飞腾派，每个独立显示 |

---

## 🏗️ 系统架构

### 1. 物理拓扑

```
┌─────────────────────────────────────────────────────────────┐
│                     局域网 192.168.100.0/24                   │
└─────────────────────────────────────────────────────────────┘
         │          │          │          │          │
    ┌────┴────┐┌───┴────┐┌───┴────┐┌───┴────┐┌───┴────┐
    │飞腾派1   ││飞腾派2  ││飞腾派3  ││飞腾派4  ││飞腾派5  │
    │SAT      ││S/R     ││S1      ││S2      ││T       │
    │🛰卫星   ││✈无人机1││📱终端1 ││📱终端2 ││📱目标  │
    │屏幕1    ││屏幕2   ││屏幕3   ││屏幕4   ││屏幕5   │
    └─────────┘└────────┘└────────┘└────────┘└────────┘
              ┌────┴────┐┌───┴────┐
              │飞腾派6   ││飞腾派7  │
              │S1/R1    ││S2/R2   │
              │✈无人机2 ││✈无人机3│
              │屏幕6    ││屏幕7   │
              └─────────┘└────────┘
```

### 2. 节点角色分配

| 飞腾派 | IP地址 | 节点角色 | 图标 | 拓扑参与度 |
|--------|--------|----------|------|-----------|
| Pi-1 | 192.168.100.11 | SAT (卫星) | 🛰 | 全部12个拓扑 |
| Pi-2 | 192.168.100.12 | S/R (无人机) | ✈ | 拓扑1,7 (直连场景) |
| Pi-3 | 192.168.100.13 | S1 (终端1) | 📱 | 大部分拓扑 |
| Pi-4 | 192.168.100.14 | S2 (终端2) | 📱 | 大部分拓扑 |
| Pi-5 | 192.168.100.15 | T (目标) | 📱 | 大部分拓扑 |
| Pi-6 | 192.168.100.16 | S1/R1 (无人机2) | ✈ | 拓扑2-6, 8-12 |
| Pi-7 | 192.168.100.17 | S2/R2 (无人机3) | ✈ | 部分拓扑 |

### 3. 软件架构

```
每个飞腾派运行：
┌──────────────────────────────────────────┐
│ 飞腾派 (物理机)                            │
│  ├─ Docker容器 (PQ-NTOR节点)              │
│  │   ├─ PQ-NTOR守护进程                   │
│  │   ├─ 网络参数模拟器 (TC/应用层)         │
│  │   └─ 数据采集Agent (监控性能)          │
│  │                                        │
│  ├─ 后台服务 (Flask + WebSocket)          │
│  │   ├─ WebSocket Server (端口9001)       │
│  │   ├─ REST API (端口5000)               │
│  │   ├─ Docker监控模块                    │
│  │   └─ 数据推送模块                      │
│  │                                        │
│  └─ Web前端 (Nginx/Python HTTP)           │
│      ├─ 节点专属页面 (node_view.html)     │
│      ├─ 实时数据展示 (WebSocket客户端)    │
│      └─ 本地静态资源                      │
└──────────────────────────────────────────┘

额外：中央控制台 (可选)
┌──────────────────────────────────────────┐
│ 任意电脑 (开发机/第8个飞腾派)              │
│  └─ 控制台 (control_panel.html)           │
│      ├─ 拓扑切换控制                      │
│      ├─ 全局3D视图 (复用3d_globe_html)    │
│      └─ 7节点统一管理                     │
└──────────────────────────────────────────┘
```

---

## 🖥️ 每个屏幕显示内容

### 屏幕设计原则
- **左侧**：当前节点视角的3D地球（突出显示自己）
- **右侧**：节点状态面板
  - 当前拓扑名称
  - 节点角色和RSSI等级
  - 实时通信流量
  - 连接状态
  - PQ-NTOR握手次数

### 示例：飞腾派1 (卫星节点) 的屏幕

```
┌─────────────────────────────────────────────────────────────┐
│ 🛰 卫星节点 (SAT) - Topology 1: Z1 Up-1                      │
├──────────────────────┬──────────────────────────────────────┤
│                      │  📊 节点状态                          │
│    🌍 3D地球视图      │  ├─ 角色: 卫星 (SAT)                 │
│                      │  ├─ 当前拓扑: Z1 Up-1                │
│   (Globe.GL渲染)     │  ├─ 高度: 0.15 (550km LEO)           │
│                      │  └─ IP: 192.168.100.11               │
│   - 卫星高亮显示🛰   │                                       │
│   - 连接线实时闪烁   │  📡 通信状态                          │
│   - 其他节点半透明   │  ├─ 活跃链路: 2条                    │
│                      │  ├─ SAT→S (高RSSI): ✅ 10ms, 50Mbps  │
│                      │  ├─ SAT→R (低RSSI): ✅ 30ms, 20Mbps  │
│                      │  └─ 总流量: ↑120KB/s ↓85KB/s         │
│                      │                                       │
│                      │  🔐 PQ-NTOR                           │
│                      │  ├─ 握手次数: 47                     │
│                      │  ├─ Kyber-512运算: 2.3ms             │
│                      │  └─ 电路状态: 🟢 活跃                │
└──────────────────────┴──────────────────────────────────────┘
```

### 其他节点屏幕内容类似
- **飞腾派2 (无人机S/R)**: 突出显示自己的无人机节点，显示与卫星和地面的连接
- **飞腾派3-5 (地面终端)**: 显示地面视角，显示接收信号质量
- **飞腾派6-7 (其他无人机)**: 在多无人机拓扑中激活显示

---

## 🔗 后台通信架构

### 1. WebSocket实时通信

#### 数据流向
```
Docker容器 → 数据采集Agent → Flask后台 → WebSocket → Web前端
   (每秒)        (Python)       (端口9001)   (实时推送)  (更新UI)
```

#### 消息格式 (JSON)
```json
{
  "node_id": "SAT",
  "node_name": "卫星",
  "topology_id": 1,
  "timestamp": 1731753600,
  "status": {
    "role": "satellite",
    "altitude": 0.15,
    "ip": "192.168.100.11",
    "container_ip": "172.20.0.11"
  },
  "links": [
    {
      "target": "S",
      "rssi": "high",
      "delay_ms": 10,
      "bandwidth_mbps": 50,
      "packet_loss": 0.5,
      "traffic_up_kbps": 120,
      "traffic_down_kbps": 85
    }
  ],
  "pq_ntor": {
    "handshakes": 47,
    "avg_time_ms": 2.3,
    "circuit_status": "active"
  }
}
```

### 2. REST API (控制接口)

| 端点 | 方法 | 功能 | 示例 |
|------|------|------|------|
| `/api/topology` | GET | 获取当前拓扑 | `{"topology_id": 1}` |
| `/api/topology` | POST | 切换拓扑 | `{"topology_id": 2}` |
| `/api/node/status` | GET | 获取节点状态 | 返回完整状态JSON |
| `/api/nodes` | GET | 获取所有节点列表 | 返回7个节点 |

### 3. 拓扑切换协调机制

**问题**: 如何让7个飞腾派同步切换到同一个拓扑？

**解决方案**: 中央控制台 + 消息广播

```
用户在控制台点击 "切换到拓扑3"
         ↓
控制台发送 POST /api/topology {"topology_id": 3} 到所有7个飞腾派
         ↓
每个飞腾派的后台服务：
1. 停止当前Docker容器
2. 启动拓扑3对应的Docker配置
3. 更新网络参数
4. 通过WebSocket推送新状态到前端
         ↓
7个屏幕同步更新显示
```

---

## 🛠️ 实现步骤

### Phase 1: 后台服务开发 (2天)

**文件结构**:
```
sagin-experiments/
├── backend/
│   ├── websocket_server.py      # WebSocket服务器
│   ├── docker_monitor.py        # Docker监控模块
│   ├── data_collector.py        # 数据采集Agent
│   ├── topology_manager.py      # 拓扑切换管理
│   └── requirements.txt         # Flask, Flask-SocketIO, docker-py
├── frontend/
│   ├── node_view.html           # 节点专属页面模板
│   ├── js/
│   │   ├── websocket_client.js  # WebSocket客户端
│   │   ├── node_status.js       # 状态面板渲染
│   │   └── globe_viewer.js      # 3D地球视图(复用现有)
│   └── css/
│       └── node_view.css        # 样式
└── control/
    └── control_panel.html       # 中央控制台
```

**关键代码**:
```python
# websocket_server.py
from flask import Flask
from flask_socketio import SocketIO, emit
import docker

app = Flask(__name__)
socketio = SocketIO(app, cors_allowed_origins="*")

# 监控Docker容器，推送实时数据
@socketio.on('connect')
def handle_connect():
    print('Client connected')
    start_monitoring()

def start_monitoring():
    client = docker.from_env()
    while True:
        # 获取容器统计数据
        stats = get_container_stats(client)
        # 推送到前端
        socketio.emit('node_update', stats)
        time.sleep(1)  # 每秒更新
```

### Phase 2: 前端界面开发 (1.5天)

**节点视图页面** (node_view.html):
```html
<!DOCTYPE html>
<html>
<head>
    <title>节点视图 - ${NODE_NAME}</title>
    <script src="three.min.js"></script>
    <script src="globe.gl.min.js"></script>
    <script src="socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 左侧: 3D地球 -->
        <div id="globe-view"></div>

        <!-- 右侧: 状态面板 -->
        <div id="status-panel">
            <h2 id="node-title">🛰 卫星节点 (SAT)</h2>
            <div id="node-status">...</div>
            <div id="link-status">...</div>
            <div id="pq-ntor-status">...</div>
        </div>
    </div>

    <script>
        // WebSocket连接
        const socket = io('ws://192.168.100.11:9001');

        socket.on('node_update', (data) => {
            updateStatusPanel(data);
            updateGlobeView(data);
        });
    </script>
</body>
</html>
```

### Phase 3: Docker配置和部署 (1天)

**每个飞腾派的docker-compose.yml**:
```yaml
version: '3'
services:
  # PQ-NTOR节点容器
  pq-ntor-node:
    image: pqtor:latest
    container_name: ${NODE_ID}_node
    networks:
      sagin_net:
        ipv4_address: ${CONTAINER_IP}
    volumes:
      - ./configs/${TOPOLOGY_ID}.json:/config/topology.json

  # 后台服务
  backend:
    build: ./backend
    ports:
      - "9001:9001"  # WebSocket
      - "5000:5000"  # REST API
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - pq-ntor-node

  # Web前端
  frontend:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./frontend:/usr/share/nginx/html

networks:
  sagin_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### Phase 4: 一键部署脚本 (0.5天)

**deploy_all.sh**:
```bash
#!/bin/bash

# 7个飞腾派的IP地址
NODES=(
    "192.168.100.11:SAT:satellite"
    "192.168.100.12:SR:aircraft"
    "192.168.100.13:S1:ground"
    "192.168.100.14:S2:ground"
    "192.168.100.15:T:ground"
    "192.168.100.16:S1R1:aircraft"
    "192.168.100.17:S2R2:aircraft"
)

for node in "${NODES[@]}"; do
    IFS=':' read -r ip node_id role <<< "$node"

    echo "部署到 $ip ($node_id)..."

    # SCP传输文件
    scp -r backend frontend docker-compose.yml pi@$ip:/home/pi/sagin-demo/

    # SSH执行部署
    ssh pi@$ip << EOF
        cd /home/pi/sagin-demo
        export NODE_ID=$node_id
        export NODE_ROLE=$role
        docker-compose up -d
        echo "✅ $node_id 部署完成"
EOF
done

echo "🎉 全部7个节点部署完成！"
echo "访问各节点Web界面："
for node in "${NODES[@]}"; do
    IFS=':' read -r ip node_id role <<< "$node"
    echo "  - $node_id: http://$ip:8080"
done
```

### Phase 5: 测试和优化 (1天)

1. 单节点测试 (飞腾派1)
2. 多节点联调 (2-3个节点)
3. 全部7节点集成测试
4. 性能优化 (WebSocket并发、3D渲染)

---

## 📊 对比总结

### 与当前DEMO的关系

| 组件 | 当前DEMO | 7屏幕系统 | 复用程度 |
|------|---------|----------|---------|
| 3D地球渲染 | ✅ 3d_globe_html.html | ✅ 集成到node_view.html | 🟢 80%复用 |
| 拓扑数据 | ✅ 硬编码12个拓扑 | ✅ 从配置文件加载 | 🟢 100%复用 |
| 图标/颜色 | ✅ 🛰✈📱 | ✅ 完全相同 | 🟢 100%复用 |
| 交互方式 | 点击按钮切换 | WebSocket实时推送 | 🔴 全新开发 |
| 后台连接 | ❌ 无 | ✅ Docker + WebSocket | 🔴 全新开发 |

**总结**: 可以**复用70%的前端代码**（3D渲染、拓扑配置），需要**新增30%后台代码**（WebSocket、Docker监控）。

---

## 💰 成本估算

### 硬件成本
- 7个飞腾派: ¥1,500 × 7 = **¥10,500**
- 7个显示器 (假设1080p 24寸): ¥600 × 7 = **¥4,200**
- 网络设备 (千兆交换机): **¥300**
- **总计**: ¥15,000

### 开发时间
- 后台服务: 2天
- 前端界面: 1.5天
- Docker配置: 1天
- 部署脚本: 0.5天
- 测试优化: 1天
- **总计**: 6天 (单人工作量)

### 替代方案：虚拟7屏幕
如果硬件预算有限，可以在**1个飞腾派上模拟7个节点**，用**1台大屏幕分屏显示**：
- 成本: ¥1,500 (飞腾派) + ¥2,000 (大屏) = ¥3,500
- 开发时间: 4天 (省去分布式部署的复杂性)

---

## 🎯 推荐方案

### 建议：分阶段实施

**阶段1 (1周)**: 单飞腾派 + 虚拟7节点 + 分屏显示
- 成本低，快速验证
- 开发后台WebSocket + 前端界面
- 在1个大屏上展示效果

**阶段2 (2周)**: 扩展到3个飞腾派
- 验证分布式部署流程
- 测试网络通信稳定性
- 3个屏幕显示核心节点 (卫星 + 2个终端)

**阶段3 (1周)**: 最终7个飞腾派完整部署
- 复制阶段2的部署脚本
- 一键部署到所有节点
- 完整演示效果

---

## 📝 下一步行动

### 立即可做
1. ✅ 阅读本设计文档
2. 确认是否采用分阶段方案
3. 确认当前有几个飞腾派可用
4. 确认是否需要先开发后台服务

### 需要您决策
1. **预算**: 是否采购7个飞腾派 + 7个显示器？
2. **时间**: 是否有6天开发时间？
3. **方案**: 选择完整7屏幕 or 单飞腾派分屏？

### 我可以立即开始
如果您确认需求，我可以立即开始：
1. 创建 `backend/websocket_server.py`
2. 创建 `frontend/node_view.html`
3. 编写部署脚本
4. 生成12个拓扑的配置文件

---

**创建时间**: 2025-11-16
**版本**: v1.0
**状态**: 🟢 设计完成，等待实施
