<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGIN NOMA - å…¨å±€æ§åˆ¶å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        /* å·¦ä¾§3Dåœ°çƒè§†å›¾ */
        #globe-container {
            flex: 2;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #globe-view {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #globe-view > div {
            width: 100% !important;
            height: 100% !important;
            position: relative !important;
        }

        #globe-view canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* é˜²æ­¢ä»»ä½•å­å…ƒç´ é€ƒå‡ºå®¹å™¨ */
        #globe-view * {
            max-width: 100%;
            max-height: 100%;
        }

        .globe-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .globe-overlay h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .globe-overlay p {
            font-size: 14px;
            opacity: 0.8;
        }

        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        #control-panel {
            flex: 1;
            min-width: 400px;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 30px;
            overflow-y: auto;
            border-left: 3px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .panel-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        /* å½“å‰æ‹“æ‰‘æ˜¾ç¤º */
        .current-topology {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* æ‹“æ‰‘åˆ‡æ¢æŒ‰é’® */
        .topology-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .topology-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 12px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .topology-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .topology-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-color: #fff;
            box-shadow: 0 0 15px rgba(245, 87, 108, 0.5);
        }

        /* ç³»ç»Ÿç›‘æ§ */
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.05em;  /* åŠ å¤§æ ‡ç­¾å­—ä½“ä»¥é€‚é…14å¯¸å°å±å¹• */
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-value {
            font-weight: bold;
            color: #4ade80;
            font-size: 1.1em;  /* åŠ å¤§å­—ä½“ä»¥é€‚é…14å¯¸å°å±å¹• */
        }

        /* èŠ‚ç‚¹çŠ¶æ€åˆ—è¡¨ */
        .node-list {
            margin-top: 10px;
        }

        .node-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .node-icon {
            font-size: 20px;
        }

        .node-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .node-details-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .node-details-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .connection-status.connected {
            border: 2px solid #4ade80;
        }

        .connection-status.disconnected {
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ï¼š3Dåœ°çƒå…¨å±€è§†å›¾ -->
        <div id="globe-container">
            <div class="globe-overlay">
                <h1>ğŸŒ SAGIN NOMA æ¼”ç¤ºç³»ç»Ÿ</h1>
                <p>Space-Air-Ground Integrated Network with NOMA</p>
            </div>
            <div id="globe-view"></div>

            <!-- å·¦ä¸Šè§’æ—¶é—´æ˜¾ç¤º -->
            <div style="
                position: absolute;
                top: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.7);
                padding: 12px 20px;
                border-radius: 10px;
                border: 2px solid #4ade80;
                box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
                font-family: 'Courier New', monospace;
                z-index: 100;">
                <div style="color: #fbbf24; font-size: 14px; font-weight: bold; margin-bottom: 4px;">
                    ğŸ“… å½“å‰æ—¶é—´
                </div>
                <div id="current-time" style="color: #4ade80; font-size: 18px; font-weight: bold; letter-spacing: 1px;">
                    --
                </div>
            </div>

            <!-- é“¾è·¯å›¾ä¾‹ -->
            <div style="
                position: absolute;
                bottom: 30px;
                left: 20px;
                background: rgba(0, 0, 0, 0.7);
                padding: 15px 20px;
                border-radius: 10px;
                border: 2px solid #fbbf24;
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
                z-index: 100;">
                <div style="color: #fbbf24; font-size: 14px; font-weight: bold; margin-bottom: 10px;">
                    ğŸ”— é“¾è·¯ç±»å‹
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #00ff00; border-radius: 2px;"></div>
                        <span style="color: #fff; font-size: 13px;">é«˜RSSI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #ff6600; border-radius: 2px;"></div>
                        <span style="color: #fff; font-size: 13px;">ä½RSSI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #ff00ff; border-radius: 2px;
                                   background-image: repeating-linear-gradient(
                                       90deg,
                                       #ff00ff,
                                       #ff00ff 5px,
                                       transparent 5px,
                                       transparent 10px
                                   );"></div>
                        <span style="color: #fff; font-size: 13px;">åä½œNOMA</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <!-- å½“å‰æ‹“æ‰‘ -->
            <div class="current-topology" id="current-topology">
                Topology 1: Z1 Up-1
            </div>

            <!-- æ‹“æ‰‘æ§åˆ¶ -->
            <div class="panel-section">
                <h2>ğŸ® æ‹“æ‰‘åˆ‡æ¢</h2>
                <div class="topology-grid" id="topology-grid">
                    <!-- æ‹“æ‰‘æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                    <button class="topology-btn">1</button>
                    <button class="topology-btn">2</button>
                    <button class="topology-btn">3</button>
                    <button class="topology-btn">4</button>
                    <button class="topology-btn">5</button>
                    <button class="topology-btn">6</button>
                    <button class="topology-btn">7</button>
                    <button class="topology-btn">8</button>
                    <button class="topology-btn">9</button>
                    <button class="topology-btn">10</button>
                    <button class="topology-btn">11</button>
                    <button class="topology-btn">12</button>
                </div>
            </div>

            <!-- ç³»ç»Ÿç›‘æ§ -->
            <div class="panel-section">
                <h2>ğŸ“Š ç³»ç»Ÿç›‘æ§</h2>
                <div class="stat-item">
                    <span>èŠ‚ç‚¹åœ¨çº¿</span>
                    <span class="stat-value" id="stat-nodes">0/6</span>
                </div>
                <div class="stat-item">
                    <span>æ´»è·ƒé“¾è·¯</span>
                    <span class="stat-value" id="stat-links">0æ¡</span>
                </div>
                <div class="stat-item">
                    <span>æ€»æµé‡</span>
                    <span class="stat-value" id="stat-traffic">â†‘0KB/s â†“0KB/s</span>
                </div>
                <div class="stat-item">
                    <span>PQ-NTORæ¡æ‰‹</span>
                    <span class="stat-value" id="stat-handshakes">0æ¬¡</span>
                </div>
            </div>

            <!-- èŠ‚ç‚¹çŠ¶æ€ -->
            <div class="panel-section">
                <h2>ğŸ“± èŠ‚ç‚¹çŠ¶æ€</h2>
                <div class="node-list" id="node-list">
                    <!-- èŠ‚ç‚¹åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                    <div class="node-item">
                        <div class="node-name">
                            <span class="node-icon">ğŸ›°</span>
                            <span>å«æ˜Ÿ (SAT)</span>
                        </div>
                        <div class="node-status">
                            <div class="status-dot"></div>
                            <span>åœ¨çº¿</span>
                        </div>
                    </div>
                    <div class="node-item">
                        <div class="node-name">
                            <span class="node-icon">âœˆ</span>
                            <span>æ— äººæœº1 (SR)</span>
                        </div>
                        <div class="node-status">
                            <div class="status-dot"></div>
                            <span>åœ¨çº¿</span>
                        </div>
                    </div>
                    <div class="node-item">
                        <div class="node-name">
                            <span class="node-icon">ğŸ“±</span>
                            <span>ç»ˆç«¯1 (S1)</span>
                        </div>
                        <div class="node-status">
                            <div class="status-dot"></div>
                            <span>åœ¨çº¿</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status disconnected" id="connection-status">
        <div class="status-dot"></div>
        <span id="connection-text">è¿æ¥ä¸­...</span>
    </div>

    <!-- å¼•å…¥Three.jså’ŒGlobe.GL -->
    <script src="../shared/three.min.js"></script>
    <script src="../shared/globe.gl.min.js"></script>

    <script>
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('current-time').textContent =
                `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ—¶é—´æ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
        });

        // å…¨å±€çŠ¶æ€
        const state = {
            websocket: null,
            currentTopology: 1,
            nodes: {},
            reconnectAttempts: 0,
            globeInitialized: false  // æ ‡è®°GlobeèŠ‚ç‚¹æ˜¯å¦å·²åˆå§‹åŒ–
        };

        // æ‹“æ‰‘åç§°
        const topologyNames = [
            'Z1 Up-1', 'Z1 Up-2', 'Z2 Up-1', 'Z2 Up-2', 'Z3 Up', 'Z4 Up',
            'Z1 Down', 'Z2 Down', 'Z3 Down', 'Z4 Down', 'Z5 Down', 'Z6 Down'
        ];

        // èŠ‚ç‚¹é…ç½®
        const nodeConfigs = {
            'SAT': { icon: 'ğŸ›°', name: 'å«æ˜Ÿ', lat: 35, lon: 122, alt: 0.15, type: 'satellite' },
            'SR': { icon: 'âœˆ', name: 'æ— äººæœº1', lat: 35, lon: 110, alt: 0.05, type: 'aircraft' },
            'S1R2': { icon: 'âœˆ', name: 'æ— äººæœº2', lat: 31.2, lon: 121.5, alt: 0.05, type: 'aircraft' },
            'S1': { icon: 'ğŸ“±', name: 'ç»ˆç«¯1', lat: 39.9, lon: 116.4, alt: 0, type: 'ground' },
            'S2': { icon: 'ğŸ“±', name: 'ç»ˆç«¯2', lat: 30, lon: 105, alt: 0, type: 'ground' },
            'T': { icon: 'ğŸ“±', name: 'ç»ˆç«¯3', lat: 28, lon: 115, alt: 0, type: 'ground' }
        };

        // èŠ‚ç‚¹é¢œè‰²æ˜ å°„
        const nodeColorMap = {
            satellite: 0xffff00,  // é»„è‰²ï¼ˆå«æ˜Ÿï¼‰
            aircraft: 0x00ffff,   // é’è‰²ï¼ˆæ— äººæœºï¼‰
            ground: 0x00ff00      // ç»¿è‰²ï¼ˆåœ°é¢ç«™/ç»ˆç«¯ï¼‰
        };

        // æ‹“æ‰‘é“¾è·¯å®šä¹‰ï¼ˆ12ç§æ‹“æ‰‘çš„è¿æ¥å…³ç³»ï¼‰
        const topologyLinks = {
            1: [ // Z1 Up-1: S1â†’SAT, S2â†’SAT (ç›´è¿NOMA)
                { source: 'S1', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' },
                { source: 'S2', target: 'SAT', rssi: 'low', label: 'ä½RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            2: [ // Z1 Up-2: S2â†’S1R2â†’SAT (åä½œ)
                { source: 'S2', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            3: [ // Z2 Up-1: S1â†’SRâ†’SAT, S2â†’SRâ†’SAT (2è·³åä½œ)
                { source: 'S1', target: 'SR', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'S2', target: 'SR', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            4: [ // Z2 Up-2: S2â†’S1R2, S1R2â†’SRâ†’SAT (æ··åˆåä½œ)
                { source: 'S2', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SR', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            5: [ // Z3 Up: Tâ†’SRâ†’SAT (ä¸­ç»§)
                { source: 'T', target: 'SR', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            6: [ // Z4 Up: Tâ†’S1R2â†’SRâ†’SAT (å¤šè·³ä¸­ç»§)
                { source: 'T', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SR', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            7: [ // Z1 Down: SATâ†’S1, SATâ†’S2, S1â†’S2 (ç›´è¿+åä½œ)
                { source: 'SAT', target: 'S1', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SAT', target: 'S2', rssi: 'low', label: 'ä½RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'åä½œé“¾è·¯' }
            ],
            8: [ // Z2 Down: SATâ†’SRâ†’S1, SATâ†’SRâ†’S2 (ä¸­ç»§ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'SR', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ],
            9: [ // Z3 Down: SATâ†’SRâ†’T (ä¸­ç»§ä¸‹è¡Œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' }
            ],
            10: [ // Z4 Down: SATâ†’SRâ†’S1R2â†’T (å¤šè·³ä¸‹è¡Œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'S1R2', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' }
            ],
            11: [ // Z5 Down: SATâ†’SRâ†’S1R2, SRâ†’S1, S1R2â†’S2 (å¹¿æ’­ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'S1R2', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ],
            12: [ // Z6 Down: SATâ†’SR, SRâ†’S1R2â†’T, SRâ†’S1, SRâ†’S2 (å¤šç‚¹ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'S1R2', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'SR', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ]
        };

        // é“¾è·¯é¢œè‰²æ˜ å°„
        const linkColorMap = {
            high: '#00ff00',    // ç»¿è‰² - é«˜RSSI
            low: '#ff6600',     // é²œæ©™è‰² - ä½RSSI (æ›´äº®)
            coop: '#ff00ff'     // ç´«è‰²/å“çº¢ - åä½œé“¾è·¯
        };

        // åˆå§‹åŒ–3Dåœ°çƒ
        let globe;
        function initGlobe() {
            try {
                if (typeof Globe === 'undefined') {
                    console.error('Globe.GLåº“æœªåŠ è½½');
                    return;
                }

                const container = document.getElementById('globe-view');

                globe = Globe()
                    (container)
                    .width(container.offsetWidth)
                    .height(container.offsetHeight)
                    .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                    .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
                    .showAtmosphere(true)
                    .atmosphereColor('lightskyblue')
                    .atmosphereAltitude(0.15)
                    .pointOfView({ lat: 35, lng: 115, altitude: 2 });

                console.log('âœ… Globeåˆå§‹åŒ–æˆåŠŸ', `å°ºå¯¸: ${container.offsetWidth}x${container.offsetHeight}`);

                // æ£€æŸ¥æ§åˆ¶é¢æ¿æ˜¯å¦è¿˜å¯è§
                setTimeout(() => {
                    const panel = document.getElementById('control-panel');
                    const panelRect = panel.getBoundingClientRect();
                    console.log('æ§åˆ¶é¢æ¿ä½ç½®:', {
                        visible: panelRect.width > 0 && panelRect.height > 0,
                        width: panelRect.width,
                        height: panelRect.height,
                        left: panelRect.left,
                        top: panelRect.top
                    });

                    // æ£€æŸ¥Globeåˆ›å»ºçš„å…ƒç´ 
                    const globeDivs = container.querySelectorAll('div');
                    const globeCanvases = container.querySelectorAll('canvas');
                    console.log(`Globeå®¹å™¨å†…: ${globeDivs.length} divs, ${globeCanvases.length} canvases`);
                }, 100);

                // åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (Object.keys(state.nodes).length > 0) {
                    updateGlobeNodes();
                }

                // åˆå§‹åŒ–æ—¶ç«‹å³æ˜¾ç¤ºé»˜è®¤æ‹“æ‰‘ï¼ˆæ‹“æ‰‘1ï¼‰çš„é“¾è·¯
                setTimeout(() => {
                    updateGlobeLinks();
                    console.log('âœ… åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæ‹“æ‰‘1çš„é“¾è·¯');
                }, 500);
            } catch (error) {
                console.error('Globeåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åœ°çƒä¸Šçš„èŠ‚ç‚¹æ˜¾ç¤º - ä½¿ç”¨emoji HTMLå…ƒç´ 
        function updateGlobeNodes() {
            try {
                if (!globe) {
                    console.warn('Globeæœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }

                // åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé¿å…æ¯æ¬¡WebSocketæ¶ˆæ¯éƒ½é‡æ–°æ¸²æŸ“å¯¼è‡´é—ªçƒ
                if (state.globeInitialized) {
                    return;
                }

                if (Object.keys(state.nodes).length === 0) {
                    console.log('èŠ‚ç‚¹æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }

                // æ„å»ºèŠ‚ç‚¹æ•°æ®
                const nodesData = Object.entries(state.nodes).map(([id, node]) => {
                    const config = nodeConfigs[id];
                    if (!config) {
                        console.warn(`èŠ‚ç‚¹é…ç½®ä¸å­˜åœ¨: ${id}`);
                        return null;
                    }
                    return {
                        id: id,
                        lat: config.lat,
                        lng: config.lon,
                        alt: config.alt,
                        icon: config.icon,
                        name: config.name,
                        type: config.type,
                        online: node.status?.online || false
                    };
                }).filter(p => p !== null);

                // ä½¿ç”¨htmlElementsDataæ˜¾ç¤ºemojiå›¾æ ‡
                globe.htmlElementsData(nodesData)
                    .htmlLat(d => d.lat)
                    .htmlLng(d => d.lng)
                    .htmlAltitude(d => d.alt)
                    .htmlElement(d => {
                        const el = document.createElement('div');
                        el.style.fontSize = '32px';
                        el.style.cursor = 'pointer';
                        el.style.textAlign = 'center';
                        el.style.pointerEvents = 'auto';

                        // é¢œè‰²æ˜ å°„
                        const colors = {
                            satellite: '#ffff00',
                            aircraft: '#00ffff',
                            ground: '#00ff00'
                        };

                        el.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 32px;">${d.icon}</div>
                                <div style="font-size: 12px; color: ${colors[d.type]}; margin-top: 2px; text-shadow: 0 0 3px black;">${d.name}</div>
                            </div>
                        `;

                        return el;
                    });

                state.globeInitialized = true;  // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                console.log(`âœ… åˆå§‹åŒ–äº† ${nodesData.length} ä¸ªemojièŠ‚ç‚¹ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰`);

                // æ›´æ–°é“¾è·¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”æ ¹æ®æ‹“æ‰‘åŠ¨æ€ç”Ÿæˆï¼‰
                updateGlobeLinks();
            } catch (error) {
                console.error('æ›´æ–°GlobeèŠ‚ç‚¹å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åœ°çƒä¸Šçš„é“¾è·¯æ˜¾ç¤º
        function updateGlobeLinks() {
            try {
                if (!globe) {
                    console.warn('Globeæœªåˆå§‹åŒ–ï¼Œè·³è¿‡é“¾è·¯æ›´æ–°');
                    return;
                }

                // è·å–å½“å‰æ‹“æ‰‘çš„é“¾è·¯æ•°æ®
                const links = topologyLinks[state.currentTopology] || [];
                console.log(`æ›´æ–°æ‹“æ‰‘ ${state.currentTopology} çš„é“¾è·¯ï¼Œå…± ${links.length} æ¡`);

                // ä½¿ç”¨arcsDataæ˜¾ç¤ºé“¾è·¯
                globe.arcsData(links)
                    .arcStartLat(d => {
                        const sourceNode = nodeConfigs[d.source];
                        const lat = sourceNode ? sourceNode.lat : 0;
                        console.log(`ğŸ” ${d.source} èµ·ç‚¹çº¬åº¦: ${lat}`);
                        return lat;
                    })
                    .arcStartLng(d => {
                        const sourceNode = nodeConfigs[d.source];
                        const lon = sourceNode ? sourceNode.lon : 0;
                        console.log(`ğŸ” ${d.source} èµ·ç‚¹ç»åº¦: ${lon}`);
                        return lon;
                    })
                    .arcEndLat(d => {
                        const targetNode = nodeConfigs[d.target];
                        const lat = targetNode ? targetNode.lat : 0;
                        console.log(`ğŸ” ${d.target} ç»ˆç‚¹çº¬åº¦: ${lat}`);
                        return lat;
                    })
                    .arcEndLng(d => {
                        const targetNode = nodeConfigs[d.target];
                        const lon = targetNode ? targetNode.lon : 0;
                        console.log(`ğŸ” ${d.target} ç»ˆç‚¹ç»åº¦: ${lon}`);
                        return lon;
                    })
                    .arcAltitude(d => {
                        // è®¡ç®—å¼§çº¿çš„æœ€å¤§é«˜åº¦ï¼šæ ¹æ®èµ·ç‚¹å’Œç»ˆç‚¹çš„æœ€å¤§é«˜åº¦
                        const sourceNode = nodeConfigs[d.source];
                        const targetNode = nodeConfigs[d.target];
                        const sourceAlt = sourceNode ? (sourceNode.alt || 0) : 0;
                        const targetAlt = targetNode ? (targetNode.alt || 0) : 0;
                        // å¼§çº¿é«˜åº¦å–ä¸¤ç«¯æœ€å¤§å€¼ï¼Œå¦‚æœæœ‰å«æ˜Ÿåˆ™æ›´é«˜
                        const maxAlt = Math.max(sourceAlt, targetAlt);
                        const arcAlt = maxAlt > 0 ? maxAlt * 1.5 : 0.3; // å«æ˜Ÿé“¾è·¯å¼§åº¦æ›´é«˜
                        console.log(`é“¾è·¯ ${d.source}â†’${d.target}: é«˜åº¦=${arcAlt.toFixed(3)}`);
                        return arcAlt;
                    })
                    .arcAltitudeAutoScale(d => {
                        // æ ¹æ®é“¾è·¯ç±»å‹è‡ªåŠ¨è°ƒæ•´é«˜åº¦ç¼©æ”¾
                        const sourceNode = nodeConfigs[d.source];
                        const targetNode = nodeConfigs[d.target];
                        const isSatellite = (sourceNode && sourceNode.type === 'satellite') ||
                                          (targetNode && targetNode.type === 'satellite');
                        return isSatellite ? 0.8 : 0.5; // å«æ˜Ÿé“¾è·¯æ›´é«˜çš„å¼§åº¦
                    })
                    .arcColor(d => {
                        const color = linkColorMap[d.rssi] || '#ffffff';
                        console.log(`é“¾è·¯ ${d.source}â†’${d.target}: RSSI=${d.rssi}, é¢œè‰²=${color}`);
                        return color;
                    })
                    .arcStroke(2.0)  // ç»Ÿä¸€çº¿å®½æ ‡å‡†
                    .arcDashLength(d => {
                        // åä½œé“¾è·¯ç”¨è™šçº¿ï¼Œå…¶ä»–é“¾è·¯ç”¨å®çº¿æ®µæ¥äº§ç”ŸæµåŠ¨æ•ˆæœ
                        if (d.rssi === 'coop') return 0.5;  // è™šçº¿
                        return 0.4;  // å®çº¿æ®µï¼ˆæ‰€æœ‰é“¾è·¯éƒ½æœ‰æµåŠ¨æ•ˆæœï¼‰
                    })
                    .arcDashGap(d => {
                        if (d.rssi === 'coop') return 0.2;  // è™šçº¿é—´éš™
                        return 0.1;  // å®çº¿æ®µé—´éš™
                    })
                    .arcDashAnimateTime(d => {
                        // ğŸš€ ä¼˜åŒ–: å‡æ…¢åŠ¨ç”»é€Ÿåº¦ä»¥é™ä½GPUè´Ÿè½½
                        if (d.rssi === 'coop') return 3000;   // åä½œé“¾è·¯ï¼šæ›´æ…¢ï¼ˆ3ç§’ï¼ŒåŸ2ç§’ï¼‰
                        if (d.rssi === 'high') return 1200;   // é«˜RSSIï¼šè¾ƒå¿«ï¼ˆ1.2ç§’ï¼ŒåŸ0.8ç§’ï¼‰
                        if (d.rssi === 'low') return 1800;    // ä½RSSIï¼šä¸­é€Ÿï¼ˆ1.8ç§’ï¼ŒåŸ1.2ç§’ï¼‰
                        return 1500;  // é»˜è®¤ï¼ˆ1.5ç§’ï¼ŒåŸ1ç§’ï¼‰
                    })
                    .arcLabel(d => `
                        <div style="background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; color: white; border: 2px solid ${linkColorMap[d.rssi]};">
                            <strong style="font-size: 16px;">${d.source} â†’ ${d.target}</strong><br>
                            <span style="color: #ccc;">${d.label} (RSSI: ${d.rssi})</span>
                        </div>
                    `);

                console.log(`âœ… é“¾è·¯æ˜¾ç¤ºå·²æ›´æ–°`);
            } catch (error) {
                console.error('æ›´æ–°Globeé“¾è·¯å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–æ‹“æ‰‘æŒ‰é’®
        function initTopologyButtons() {
            const grid = document.getElementById('topology-grid');

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æŒ‰é’®ï¼ˆé™æ€HTMLä¸­å·²æ·»åŠ ï¼‰
            const existingButtons = grid.querySelectorAll('.topology-btn');
            if (existingButtons.length > 0) {
                console.log(`æ‹“æ‰‘æŒ‰é’®å·²å­˜åœ¨ (${existingButtons.length}ä¸ª)ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬å™¨`);
                // åªéœ€è¦ç»™ç°æœ‰æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                existingButtons.forEach((btn, index) => {
                    const topologyId = index + 1;
                    btn.dataset.topology = topologyId;
                    if (topologyId === 1) btn.classList.add('active');
                    btn.addEventListener('click', () => changeTopology(topologyId));
                });
                return;
            }

            // å¦‚æœæ²¡æœ‰æŒ‰é’®ï¼ŒåŠ¨æ€åˆ›å»º
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.className = 'topology-btn';
                btn.textContent = i;
                btn.dataset.topology = i;

                if (i === 1) btn.classList.add('active');

                btn.addEventListener('click', () => changeTopology(i));
                grid.appendChild(btn);
            }
        }

        // åˆ‡æ¢æ‹“æ‰‘
        function changeTopology(topologyId) {
            if (!state.websocket || state.websocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥ï¼Œæ— æ³•åˆ‡æ¢æ‹“æ‰‘');
                return;
            }

            // å‘é€åˆ‡æ¢å‘½ä»¤
            state.websocket.send(JSON.stringify({
                type: 'change_topology',
                topology_id: topologyId
            }));

            console.log(`Requesting topology change to ${topologyId}`);
        }

        // æ›´æ–°æ‹“æ‰‘æ˜¾ç¤º
        function updateTopologyDisplay(topologyId) {
            state.currentTopology = topologyId;

            // æ›´æ–°æ ‡é¢˜
            const topologyElement = document.getElementById('current-topology');
            if (topologyElement) {
                topologyElement.textContent = `Topology ${topologyId}: ${topologyNames[topologyId - 1]}`;
                // æ·»åŠ é—ªçƒåŠ¨ç”»æç¤ºåˆ‡æ¢æˆåŠŸ
                topologyElement.style.animation = 'none';
                setTimeout(() => {
                    topologyElement.style.animation = 'pulse 0.5s ease-in-out';
                }, 10);
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.topology-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.topology) === topologyId);
            });

            // æ›´æ–°3Dåœ°çƒä¸Šçš„é“¾è·¯æ˜¾ç¤º
            updateGlobeLinks();

            console.log(`âœ… æ‹“æ‰‘æ˜¾ç¤ºå·²æ›´æ–°ä¸º: Topology ${topologyId}`);
        }

        // æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨æ˜¾ç¤º
        function updateNodeList() {
            try {
                const nodeList = document.getElementById('node-list');
                if (!nodeList) {
                    console.error('node-listå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                // åªæœ‰å½“æœ‰èŠ‚ç‚¹æ•°æ®æ—¶æ‰æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
                if (Object.keys(state.nodes).length === 0) {
                    console.log('èŠ‚ç‚¹æ•°æ®ä¸ºç©ºï¼Œä¿ç•™é™æ€å†…å®¹');
                    return;
                }

                nodeList.innerHTML = '';

                Object.entries(state.nodes).forEach(([id, nodeData]) => {
                    const config = nodeConfigs[id];
                    if (!config) {
                        console.warn(`èŠ‚ç‚¹é…ç½®ä¸å­˜åœ¨: ${id}`);
                        return;
                    }

                    const item = document.createElement('div');
                    item.className = 'node-item';

                    item.innerHTML = `
                        <div class="node-name">
                            <span class="node-icon">${config.icon}</span>
                            <span>${config.name} (${id})</span>
                        </div>
                        <div class="node-status">
                            <div class="status-dot"></div>
                            <span>åœ¨çº¿</span>
                        </div>
                    `;

                    nodeList.appendChild(item);
                });

                console.log(`âœ… æ›´æ–°äº†èŠ‚ç‚¹åˆ—è¡¨: ${Object.keys(state.nodes).length} ä¸ªèŠ‚ç‚¹`);
            } catch (error) {
                console.error('æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            try {
                const nodesOnline = Object.keys(state.nodes).length;
                document.getElementById('stat-nodes').textContent = `${nodesOnline}/6`;

                // è®¡ç®—æ€»æµé‡ã€æ¡æ‰‹æ¬¡æ•°å’Œæ´»è·ƒé“¾è·¯
                let totalUp = 0, totalDown = 0, totalHandshakes = 0;
                Object.values(state.nodes).forEach(node => {
                    if (node.traffic) {
                        totalUp += node.traffic.up_kbps || 0;
                        totalDown += node.traffic.down_kbps || 0;
                    }
                    if (node.pq_ntor) {
                        totalHandshakes += node.pq_ntor.handshakes || 0;
                    }
                });

                // æ´»è·ƒé“¾è·¯æ•°é‡ï¼šç›´æ¥ä»å½“å‰æ‹“æ‰‘çš„é“¾è·¯é…ç½®ä¸­è·å–
                const currentTopologyLinks = topologyLinks[state.currentTopology] || [];
                const totalLinks = currentTopologyLinks.length;

                // ç¾åŒ–æµé‡æ˜¾ç¤º
                document.getElementById('stat-traffic').innerHTML = `
                    <span style="color: #4ade80; margin-right: 12px;">â–²${totalUp}</span>
                    <span style="color: #f87171; margin-right: 6px;">â–¼${totalDown}</span>
                    <span style="opacity: 0.7;">KB/s</span>
                `;
                document.getElementById('stat-handshakes').textContent = `${totalHandshakes}æ¬¡`;
                document.getElementById('stat-links').textContent = `${totalLinks}æ¡`;

                console.log(`âœ… æ›´æ–°ç»Ÿè®¡: æµé‡ â†‘${totalUp} â†“${totalDown}, æ¡æ‰‹ ${totalHandshakes}, é“¾è·¯ ${totalLinks}`);
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            // è‡ªåŠ¨æ£€æµ‹WebSocketåœ°å€ï¼šæœ¬åœ°æµ‹è¯•ç”¨localhostï¼Œéƒ¨ç½²æ—¶ç”¨å®é™…IP
            const hostname = window.location.hostname;
            const wsHost = hostname === 'localhost' || hostname === '127.0.0.1'
                ? 'localhost'
                : '192.168.100.17';
            const wsUrl = `ws://${wsHost}:9000`;
            console.log('Connecting to WebSocket Hub:', wsUrl);

            state.websocket = new WebSocket(wsUrl);

            state.websocket.onopen = () => {
                console.log('WebSocket connected');
                state.reconnectAttempts = 0;

                // æ³¨å†Œä¸ºå‰ç«¯
                state.websocket.send(JSON.stringify({
                    client_type: 'frontend'
                }));

                // æ›´æ–°è¿æ¥çŠ¶æ€
                const status = document.getElementById('connection-status');
                status.className = 'connection-status connected';
                document.getElementById('connection-text').textContent = 'å·²è¿æ¥';
            };

            state.websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data.type, data);

                    if (data.type === 'all_nodes') {
                        // æ¥æ”¶æ‰€æœ‰èŠ‚ç‚¹æ•°æ®
                        console.log(`æ”¶åˆ° ${Object.keys(data.nodes).length} ä¸ªèŠ‚ç‚¹æ•°æ®`);
                        state.nodes = data.nodes;
                        updateNodeList();
                        updateGlobeNodes();
                        updateStats();
                        updateTopologyDisplay(data.topology_id);
                        updateGlobeLinks();  // åˆå§‹åŒ–æ—¶ä¹Ÿæ˜¾ç¤ºé“¾è·¯

                    } else if (data.type === 'node_update') {
                        // å•ä¸ªèŠ‚ç‚¹æ›´æ–°
                        state.nodes[data.node_id] = data.data;
                        updateNodeList();
                        updateGlobeNodes();
                        updateStats();

                    } else if (data.type === 'topology_changed') {
                        // æ‹“æ‰‘åˆ‡æ¢æˆåŠŸ
                        updateTopologyDisplay(data.topology_id);
                        console.log(`Topology changed to ${data.topology_id}`);

                        // æ›´æ–°é“¾è·¯æ˜¾ç¤ºå’Œç»Ÿè®¡ä¿¡æ¯
                        updateGlobeLinks();
                        updateStats();  // é‡æ–°è®¡ç®—æ´»è·ƒé“¾è·¯ç­‰ç»Ÿè®¡ä¿¡æ¯
                    }
                } catch (error) {
                    console.error('å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error, event.data);
                }
            };

            state.websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            state.websocket.onclose = () => {
                console.log('WebSocket disconnected');

                // æ›´æ–°è¿æ¥çŠ¶æ€
                const status = document.getElementById('connection-status');
                status.className = 'connection-status disconnected';
                document.getElementById('connection-text').textContent = 'è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...';

                // é‡è¿
                state.reconnectAttempts++;
                const delay = Math.min(5000, 1000 * state.reconnectAttempts);
                setTimeout(connectWebSocket, delay);
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // å…ˆåˆå§‹åŒ–æ§åˆ¶é¢æ¿ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
            initTopologyButtons();
            connectWebSocket();

            // å»¶è¿ŸåŠ è½½Globeï¼ˆé¿å…é˜»å¡é¡µé¢ï¼‰
            setTimeout(() => {
                console.log('å¼€å§‹åŠ è½½3Dåœ°çƒ...');
                initGlobe();
            }, 500);
        });
    </script>
</body>
</html>
