<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚ç‚¹è§†å›¾ - ${NODE_NAME}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            overflow: hidden;
        }

        /* èŠ‚ç‚¹ç±»å‹ç‰¹è‰²ä¸»é¢˜ */
        body.theme-satellite {
            background: linear-gradient(135deg, #1a0a2e 0%, #2e1a47 50%, #4a2c5e 100%);
        }

        body.theme-aircraft {
            background: linear-gradient(135deg, #0a2e3e 0%, #1a4e5e 50%, #2a6e8e 100%);
        }

        body.theme-ground {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        /* å·¦ä¾§ï¼š3Dåœ°çƒè§†å›¾ï¼ˆèŠ‚ç‚¹è§†è§’ï¼‰*/
        #globe-container {
            flex: 2;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        #globe-view {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #globe-view > div {
            width: 100% !important;
            height: 100% !important;
            position: relative !important;
        }

        #globe-view canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* é˜²æ­¢ä»»ä½•å­å…ƒç´ é€ƒå‡ºå®¹å™¨ */
        #globe-view * {
            max-width: 100%;
            max-height: 100%;
        }

        .globe-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .globe-overlay h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .globe-overlay .node-type {
            font-size: 14px;
            opacity: 0.7;
        }

        /* å³ä¾§ï¼šèŠ‚ç‚¹çŠ¶æ€é¢æ¿ */
        #status-panel {
            flex: 1;
            min-width: 400px;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            padding: 30px;
            overflow-y: auto;
            position: relative;
            z-index: 10;
            border-left: 3px solid rgba(255, 255, 255, 0.2);
        }

        .status-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            opacity: 0.7;
        }

        .info-value {
            font-weight: bold;
        }

        /* æ‹“æ‰‘æ ‡é¢˜ */
        .topology-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .topology-title h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .topology-title p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* é“¾è·¯åˆ—è¡¨ */
        .link-list {
            margin-top: 10px;
        }

        .link-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .link-target {
            font-weight: bold;
            font-size: 16px;
        }

        .link-rssi {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .link-rssi.high {
            background: #4ade80;
            color: #000;
        }

        .link-rssi.low {
            background: #ef4444;
            color: #fff;
        }

        .link-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
        }

        .link-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            border-radius: 4px;
        }

        /* PQ-NTORçŠ¶æ€ */
        .pqntor-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .pqntor-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .pqntor-stat .value {
            font-size: 28px;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 5px;
        }

        .pqntor-stat .label {
            font-size: 12px;
            opacity: 0.7;
        }

        /* åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid #4ade80;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .online-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        /* è¿æ¥çŠ¶æ€ */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 2px solid #ef4444;
        }

        .connection-status.connected {
            border-color: #4ade80;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ï¼š3Dåœ°çƒè§†å›¾ï¼ˆèŠ‚ç‚¹è§†è§’ï¼‰-->
        <div id="globe-container">
            <div class="globe-overlay">
                <h1 id="node-title">èŠ‚ç‚¹è§†å›¾</h1>
                <p class="node-type" id="node-subtitle">åˆå§‹åŒ–ä¸­...</p>
            </div>

            <!-- å·¦ä¸Šè§’æ—¶é—´æ˜¾ç¤º -->
            <div style="
                position: absolute;
                top: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.7);
                padding: 12px 20px;
                border-radius: 10px;
                border: 2px solid #4ade80;
                box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
                font-family: 'Courier New', monospace;
                z-index: 100;">
                <div style="color: #fbbf24; font-size: 14px; font-weight: bold; margin-bottom: 4px;">
                    ğŸ“… å½“å‰æ—¶é—´
                </div>
                <div id="current-time" style="color: #4ade80; font-size: 18px; font-weight: bold; letter-spacing: 1px;">
                    --
                </div>
            </div>

            <!-- é“¾è·¯å›¾ä¾‹ -->
            <div style="
                position: absolute;
                bottom: 80px;
                left: 20px;
                background: rgba(0, 0, 0, 0.7);
                padding: 15px 20px;
                border-radius: 10px;
                border: 2px solid #fbbf24;
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
                z-index: 100;">
                <div style="color: #fbbf24; font-size: 14px; font-weight: bold; margin-bottom: 10px;">
                    ğŸ”— é“¾è·¯ç±»å‹
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #00ff00; border-radius: 2px;"></div>
                        <span style="color: #fff; font-size: 13px;">é«˜RSSI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #ff6600; border-radius: 2px;"></div>
                        <span style="color: #fff; font-size: 13px;">ä½RSSI</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 3px; background: #ff00ff; border-radius: 2px;
                                   background-image: repeating-linear-gradient(
                                       90deg,
                                       #ff00ff,
                                       #ff00ff 5px,
                                       transparent 5px,
                                       transparent 10px
                                   );"></div>
                        <span style="color: #fff; font-size: 13px;">åä½œNOMA</span>
                    </div>
                </div>
            </div>
            <!-- å½“å‰èŠ‚ç‚¹å›ºå®šæ ‡è¯† -->
            <div id="current-node-badge" style="
                position: absolute;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                padding: 15px 25px;
                border-radius: 12px;
                border: 2px solid #ffff00;
                text-align: center;
                box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
                z-index: 100;
            ">
                <div style="font-size: 48px; margin-bottom: 5px;" id="current-node-icon">ğŸ›°</div>
                <div style="font-size: 16px; color: #ffff00; font-weight: bold;" id="current-node-name">å½“å‰èŠ‚ç‚¹</div>
            </div>
            <div id="globe-view"></div>
        </div>

        <!-- å³ä¾§ï¼šèŠ‚ç‚¹çŠ¶æ€é¢æ¿ -->
        <div id="status-panel">
            <!-- åœ¨çº¿çŠ¶æ€ -->
            <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="online-status">èŠ‚ç‚¹åœ¨çº¿</span>
            </div>

            <!-- æ‹“æ‰‘ä¿¡æ¯ -->
            <div class="topology-title">
                <h2 id="topology-name">Topology 1: Z1 Up-1</h2>
                <p id="topology-desc">åˆå§‹æ‹“æ‰‘</p>
            </div>

            <!-- èŠ‚ç‚¹ä¿¡æ¯ -->
            <div class="status-section">
                <h2>ğŸ“¡ èŠ‚ç‚¹ä¿¡æ¯</h2>
                <div class="info-row">
                    <span class="info-label">è§’è‰²</span>
                    <span class="info-value" id="info-role">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">é«˜åº¦</span>
                    <span class="info-value" id="info-altitude">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">IPåœ°å€</span>
                    <span class="info-value" id="info-ip">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å®¹å™¨IP</span>
                    <span class="info-value" id="info-container-ip">-</span>
                </div>
            </div>

            <!-- è§’è‰²ç‰¹å¾æ•°æ® -->
            <div class="status-section" id="role-features">
                <h2 id="role-features-title">ğŸŒŸ èŠ‚ç‚¹ç‰¹å¾</h2>
                <div id="role-features-content">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </div>
            </div>

            <!-- é€šä¿¡é“¾è·¯ -->
            <div class="status-section">
                <h2>ğŸ”— é€šä¿¡é“¾è·¯</h2>
                <div class="link-list" id="link-list">
                    <p style="opacity: 0.5; text-align: center;">æš‚æ— é“¾è·¯æ•°æ®</p>
                </div>
            </div>

            <!-- PQ-NTORçŠ¶æ€ -->
            <div class="status-section">
                <h2>ğŸ” PQ-NTOR</h2>
                <div class="pqntor-stats">
                    <div class="pqntor-stat">
                        <div class="value" id="pqntor-handshakes">0</div>
                        <div class="label">æ¡æ‰‹æ¬¡æ•°</div>
                    </div>
                    <div class="pqntor-stat">
                        <div class="value" id="pqntor-time">0.0ms</div>
                        <div class="label">å¹³å‡è€—æ—¶</div>
                    </div>
                </div>
            </div>

            <!-- æµé‡ç»Ÿè®¡ -->
            <div class="status-section">
                <h2>ğŸ“Š æµé‡ç»Ÿè®¡</h2>
                <div class="info-row">
                    <span class="info-label">ä¸Šè¡Œæµé‡</span>
                    <span class="info-value" id="traffic-up">0 KB/s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ä¸‹è¡Œæµé‡</span>
                    <span class="info-value" id="traffic-down">0 KB/s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connection-status">
        WebSocket: è¿æ¥ä¸­...
    </div>

    <!-- å¼•å…¥Three.jså’ŒGlobe.GL -->
    <script src="../shared/three.min.js"></script>
    <script src="../shared/globe.gl.min.js"></script>

    <script>
        // ä»URLå‚æ•°æˆ–ç¯å¢ƒå˜é‡è·å–èŠ‚ç‚¹ID
        const urlParams = new URLSearchParams(window.location.search);
        const NODE_ID = urlParams.get('node_id') || 'SAT';

        // èŠ‚ç‚¹é…ç½®
        const nodeConfigs = {
            'SAT': { icon: 'ğŸ›°', name: 'å«æ˜Ÿ', role: 'Satellite', lat: 35, lon: 122, alt: 0.15, type: 'satellite' },
            'SR': { icon: 'âœˆ', name: 'æ— äººæœº1', role: 'Aircraft', lat: 35, lon: 110, alt: 0.05, type: 'aircraft' },
            'S1R2': { icon: 'âœˆ', name: 'æ— äººæœº2', role: 'Aircraft', lat: 31.2, lon: 121.5, alt: 0.05, type: 'aircraft' },
            'S1': { icon: 'ğŸ“±', name: 'ç»ˆç«¯1', role: 'Ground', lat: 39.9, lon: 116.4, alt: 0, type: 'ground' },
            'S2': { icon: 'ğŸ“±', name: 'ç»ˆç«¯2', role: 'Ground', lat: 30, lon: 105, alt: 0, type: 'ground' },
            'T': { icon: 'ğŸ“±', name: 'ç»ˆç«¯3', role: 'Ground', lat: 28, lon: 115, alt: 0, type: 'ground' }
        };

        const currentNodeConfig = nodeConfigs[NODE_ID];

        // èŠ‚ç‚¹é¢œè‰²æ˜ å°„
        const nodeColorMap = {
            satellite: 0xffff00,  // é»„è‰²ï¼ˆå«æ˜Ÿï¼‰
            aircraft: 0x00ffff,   // é’è‰²ï¼ˆæ— äººæœºï¼‰
            ground: 0x00ff00      // ç»¿è‰²ï¼ˆåœ°é¢ç«™/ç»ˆç«¯ï¼‰
        };

        // æ‹“æ‰‘åç§°
        const topologyNames = [
            'Z1 Up-1', 'Z1 Up-2', 'Z2 Up-1', 'Z2 Up-2', 'Z3 Up', 'Z4 Up',
            'Z1 Down', 'Z2 Down', 'Z3 Down', 'Z4 Down', 'Z5 Down', 'Z6 Down'
        ];

        // æ‹“æ‰‘é“¾è·¯å®šä¹‰ï¼ˆ12ç§æ‹“æ‰‘çš„è¿æ¥å…³ç³»ï¼‰
        const topologyLinks = {
            1: [ // Z1 Up-1: S1â†’SAT, S2â†’SAT (ç›´è¿NOMA)
                { source: 'S1', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' },
                { source: 'S2', target: 'SAT', rssi: 'low', label: 'ä½RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            2: [ // Z1 Up-2: S2â†’S1R2â†’SAT (åä½œ)
                { source: 'S2', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            3: [ // Z2 Up-1: S1â†’SRâ†’SAT, S2â†’SRâ†’SAT (2è·³åä½œ)
                { source: 'S1', target: 'SR', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'S2', target: 'SR', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            4: [ // Z2 Up-2: S2â†’S1R2, S1R2â†’SRâ†’SAT (æ··åˆåä½œ)
                { source: 'S2', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SR', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            5: [ // Z3 Up: Tâ†’SRâ†’SAT (ä¸­ç»§)
                { source: 'T', target: 'SR', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            6: [ // Z4 Up: Tâ†’S1R2â†’SRâ†’SAT (å¤šè·³ä¸­ç»§)
                { source: 'T', target: 'S1R2', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'S1R2', target: 'SR', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'SAT', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸Šè¡Œ' }
            ],
            7: [ // Z1 Down: SATâ†’S1, SATâ†’S2, S1â†’S2 (ç›´è¿+åä½œ)
                { source: 'SAT', target: 'S1', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SAT', target: 'S2', rssi: 'low', label: 'ä½RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'åä½œé“¾è·¯' }
            ],
            8: [ // Z2 Down: SATâ†’SRâ†’S1, SATâ†’SRâ†’S2 (ä¸­ç»§ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'SR', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ],
            9: [ // Z3 Down: SATâ†’SRâ†’T (ä¸­ç»§ä¸‹è¡Œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' }
            ],
            10: [ // Z4 Down: SATâ†’SRâ†’S1R2â†’T (å¤šè·³ä¸‹è¡Œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'S1R2', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' }
            ],
            11: [ // Z5 Down: SATâ†’SRâ†’S1R2, SRâ†’S1, S1R2â†’S2 (å¹¿æ’­ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'S1R2', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ],
            12: [ // Z6 Down: SATâ†’SR, SRâ†’S1R2â†’T, SRâ†’S1, SRâ†’S2 (å¤šç‚¹ä¸‹è¡Œ+åä½œ)
                { source: 'SAT', target: 'SR', rssi: 'high', label: 'é«˜RSSIå¤©åŸºä¸‹è¡Œ' },
                { source: 'SR', target: 'S1R2', rssi: 'high', label: 'ç©º/ç©ºé“¾è·¯' },
                { source: 'S1R2', target: 'T', rssi: 'high', label: 'ç©º/åœ°é“¾è·¯' },
                { source: 'SR', target: 'S1', rssi: 'high', label: 'é«˜RSSIç©º/åœ°' },
                { source: 'SR', target: 'S2', rssi: 'low', label: 'ä½RSSIç©º/åœ°' },
                { source: 'S1', target: 'S2', rssi: 'coop', label: 'NOMAåä½œé“¾è·¯' }
            ]
        };

        // é“¾è·¯é¢œè‰²æ˜ å°„
        const linkColorMap = {
            high: '#00ff00',    // ç»¿è‰² - é«˜RSSI
            low: '#ff6600',     // æ©™è‰² - ä½RSSI
            coop: '#ff00ff'     // ç´«è‰² - åä½œé“¾è·¯
        };

        // å…¨å±€çŠ¶æ€
        const state = {
            websocket: null,
            nodeData: null,
            currentTopology: 1
        };

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('current-time').textContent =
                `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // æ¯ç§’æ›´æ–°æ—¶é—´
        updateTime();
        setInterval(updateTime, 1000);

        // åˆå§‹åŒ–é¡µé¢æ ‡é¢˜
        document.getElementById('node-title').textContent =
            `${currentNodeConfig.icon} ${currentNodeConfig.name} (${NODE_ID})`;
        document.getElementById('node-subtitle').textContent =
            `${currentNodeConfig.role} Node`;

        // æ›´æ–°å½“å‰èŠ‚ç‚¹å¾½ç« 
        document.getElementById('current-node-icon').textContent = currentNodeConfig.icon;
        document.getElementById('current-node-name').textContent = `${currentNodeConfig.name} (${NODE_ID})`;

        // æ ¹æ®èŠ‚ç‚¹ç±»å‹è®¾ç½®å¾½ç« é¢œè‰²
        const badgeColors = {
            satellite: '#ffff00',
            aircraft: '#00ffff',
            ground: '#00ff00'
        };
        const badgeColor = badgeColors[currentNodeConfig.type];
        const badge = document.getElementById('current-node-badge');
        badge.style.borderColor = badgeColor;
        badge.style.boxShadow = `0 0 20px ${badgeColor}`;
        document.getElementById('current-node-name').style.color = badgeColor;

        // åˆå§‹åŒ–3Dåœ°çƒ
        let globe;
        function initGlobe() {
            const container = document.getElementById('globe-view');

            globe = Globe()
                (container)
                .width(container.offsetWidth)
                .height(container.offsetHeight)
                // ğŸš€ é£è…¾æ´¾æ€§èƒ½ä¼˜åŒ–: é™ä½èµ„æºå ç”¨
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')  // ä½åˆ†è¾¨ç‡å¤œæ™¯çº¹ç†
                .backgroundImageUrl('')  // ç§»é™¤æ˜Ÿç©ºèƒŒæ™¯ï¼ŒèŠ‚çœæ˜¾å­˜
                .showAtmosphere(false)  // å…³é—­å¤§æ°”å±‚ï¼Œå‡å°‘GPUè´Ÿæ‹…
                .rendererConfig({
                    antialias: false,               // å…³é—­æŠ—é”¯é½¿
                    alpha: false,                   // å…³é—­é€æ˜é€šé“
                    powerPreference: 'low-power'    // ä½åŠŸè€—æ¨¡å¼
                })
                .pointOfView({
                    lat: currentNodeConfig.lat,
                    lng: currentNodeConfig.lon,
                    altitude: 1.5
                });

            console.log('âœ… Globeåˆå§‹åŒ–æˆåŠŸ', `èŠ‚ç‚¹: ${NODE_ID}, å°ºå¯¸: ${container.offsetWidth}x${container.offsetHeight}`);

            // æ£€æŸ¥å³ä¾§é¢æ¿æ˜¯å¦è¿˜å¯è§
            setTimeout(() => {
                const panel = document.getElementById('status-panel');
                const panelRect = panel.getBoundingClientRect();
                console.log('çŠ¶æ€é¢æ¿ä½ç½®:', {
                    visible: panelRect.width > 0 && panelRect.height > 0,
                    width: panelRect.width,
                    height: panelRect.height,
                    left: panelRect.left,
                    top: panelRect.top
                });
            }, 100);

            // æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬å½“å‰èŠ‚ç‚¹ï¼ˆå½“å‰èŠ‚ç‚¹é«˜äº®æ˜¾ç¤ºï¼‰
            const allNodesData = Object.keys(nodeConfigs)
                .map(nodeId => ({
                    id: nodeId,
                    lat: nodeConfigs[nodeId].lat,
                    lng: nodeConfigs[nodeId].lon,
                    alt: nodeConfigs[nodeId].alt,
                    icon: nodeConfigs[nodeId].icon,
                    name: nodeConfigs[nodeId].name,
                    type: nodeConfigs[nodeId].type,
                    isCurrent: nodeId === NODE_ID  // æ ‡è®°å½“å‰èŠ‚ç‚¹
                }));

            console.log('ğŸ“ æ‰€æœ‰èŠ‚ç‚¹æ•°æ®:', allNodesData);
            console.log('ğŸ“ å½“å‰èŠ‚ç‚¹ID:', NODE_ID, '(åœ¨åœ°çƒä¸Šé«˜äº®æ˜¾ç¤º)');

            // é¢œè‰²æ˜ å°„
            const colors = {
                satellite: '#ffff00',
                aircraft: '#00ffff',
                ground: '#00ff00'
            };

            // ä½¿ç”¨htmlElementsDataæ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹emojiå›¾æ ‡ï¼ˆå½“å‰èŠ‚ç‚¹é«˜äº®æ˜¾ç¤ºï¼‰
            globe.htmlElementsData(allNodesData)
                .htmlLat(d => d.lat)
                .htmlLng(d => d.lng)
                .htmlAltitude(d => d.alt)
                .htmlElement(d => {
                    const el = document.createElement('div');

                    // ğŸš€ é£è…¾æ´¾ä¼˜åŒ–: å‡å°‘è§†è§‰æ•ˆæœä»¥æå‡æ€§èƒ½
                    // å½“å‰èŠ‚ç‚¹ï¼šç¨å¤§ã€ä¸é€æ˜ã€æ— å‘å…‰æ•ˆæœ
                    // å…¶ä»–èŠ‚ç‚¹ï¼šåŠé€æ˜æ˜¾ç¤º
                    if (d.isCurrent) {
                        el.style.fontSize = '36px';  // å½“å‰èŠ‚ç‚¹ç¨å¤§ (åŸ48px)
                        el.style.opacity = '1.0';     // å®Œå…¨ä¸é€æ˜
                        // ç§»é™¤å‘å…‰æ•ˆæœä»¥èŠ‚çœGPUèµ„æº
                    } else {
                        el.style.fontSize = '24px';   // å…¶ä»–èŠ‚ç‚¹æ›´å° (åŸ32px)
                        el.style.opacity = '0.5';     // æ›´é€æ˜ä»¥å‡å°‘æ¸²æŸ“
                    }

                    el.style.cursor = 'pointer';
                    el.style.textAlign = 'center';
                    el.style.pointerEvents = 'auto';

                    // ğŸš€ é£è…¾æ´¾ä¼˜åŒ–: ç®€åŒ–HTMLç»“æ„å’Œæ ·å¼
                    el.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: ${d.isCurrent ? '36px' : '24px'};">
                                ${d.icon}
                            </div>
                            <div style="font-size: ${d.isCurrent ? '12px' : '10px'};
                                        color: ${colors[d.type]};
                                        margin-top: 2px;
                                        font-weight: ${d.isCurrent ? 'bold' : 'normal'};">
                                ${d.name}${d.isCurrent ? ' â˜…' : ''}
                            </div>
                        </div>
                    `;

                    return el;
                });

            console.log(`âœ… æ˜¾ç¤º${allNodesData.length}ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹${NODE_ID}é«˜äº®æ˜¾ç¤º`);
        }

        // æ›´æ–°3Dåœ°çƒé“¾è·¯æ˜¾ç¤º
        function updateGlobeLinks() {
            if (!globe) {
                console.warn('Globeæœªåˆå§‹åŒ–ï¼Œæ— æ³•æ›´æ–°é“¾è·¯');
                return;
            }

            try {
                const topologyId = state.currentTopology;
                const links = topologyLinks[topologyId] || [];

                console.log(`ğŸ”— æ›´æ–°æ‹“æ‰‘${topologyId}çš„é“¾è·¯ï¼Œå…±${links.length}æ¡`);

                globe.arcsData(links)
                    .arcStartLat(d => {
                        const sourceNode = nodeConfigs[d.source];
                        const lat = sourceNode ? sourceNode.lat : 0;
                        console.log(`ğŸ” ${d.source} èµ·ç‚¹çº¬åº¦: ${lat}`);
                        return lat;
                    })
                    .arcStartLng(d => {
                        const sourceNode = nodeConfigs[d.source];
                        const lon = sourceNode ? sourceNode.lon : 0;
                        console.log(`ğŸ” ${d.source} èµ·ç‚¹ç»åº¦: ${lon}`);
                        return lon;
                    })
                    .arcEndLat(d => {
                        const targetNode = nodeConfigs[d.target];
                        const lat = targetNode ? targetNode.lat : 0;
                        console.log(`ğŸ” ${d.target} ç»ˆç‚¹çº¬åº¦: ${lat}`);
                        return lat;
                    })
                    .arcEndLng(d => {
                        const targetNode = nodeConfigs[d.target];
                        const lon = targetNode ? targetNode.lon : 0;
                        console.log(`ğŸ” ${d.target} ç»ˆç‚¹ç»åº¦: ${lon}`);
                        return lon;
                    })
                    .arcAltitude(d => {
                        // è®¡ç®—å¼§çº¿é«˜åº¦
                        const sourceNode = nodeConfigs[d.source];
                        const targetNode = nodeConfigs[d.target];
                        const sourceAlt = sourceNode ? (sourceNode.alt || 0) : 0;
                        const targetAlt = targetNode ? (targetNode.alt || 0) : 0;
                        const maxAlt = Math.max(sourceAlt, targetAlt);
                        const arcAlt = maxAlt > 0 ? maxAlt * 1.5 : 0.3;
                        return arcAlt;
                    })
                    .arcAltitudeAutoScale(d => {
                        const sourceNode = nodeConfigs[d.source];
                        const targetNode = nodeConfigs[d.target];
                        const isSatellite = (sourceNode && sourceNode.type === 'satellite') ||
                                          (targetNode && targetNode.type === 'satellite');
                        return isSatellite ? 0.8 : 0.5;
                    })
                    .arcColor(d => {
                        // é«˜äº®æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹çš„é“¾è·¯
                        const isCurrentNode = d.source === NODE_ID || d.target === NODE_ID;
                        const baseColor = linkColorMap[d.rssi] || '#ffffff';

                        if (isCurrentNode) {
                            return baseColor;  // å½“å‰èŠ‚ç‚¹é“¾è·¯ï¼šå…¨äº®
                        } else {
                            // å…¶ä»–èŠ‚ç‚¹é“¾è·¯ï¼šåŠé€æ˜
                            const rgb = baseColor.match(/\w\w/g).map(x => parseInt(x, 16));
                            return `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.3)`;
                        }
                    })
                    .arcStroke(1.5)  // ğŸš€ ä¼˜åŒ–: å‡å°çº¿å®½ä»¥é™ä½æ¸²æŸ“è´Ÿæ‹…
                    .arcDashLength(d => {
                        // åä½œé“¾è·¯ç”¨è™šçº¿ï¼Œå…¶ä»–é“¾è·¯ç”¨å®çº¿æ®µæ¥äº§ç”ŸæµåŠ¨æ•ˆæœ
                        if (d.rssi === 'coop') return 0.5;  // è™šçº¿
                        return 0.4;  // å®çº¿æ®µï¼ˆæ‰€æœ‰é“¾è·¯éƒ½æœ‰æµåŠ¨æ•ˆæœï¼‰
                    })
                    .arcDashGap(d => {
                        if (d.rssi === 'coop') return 0.2;  // è™šçº¿é—´éš™
                        return 0.1;  // å®çº¿æ®µé—´éš™
                    })
                    .arcDashAnimateTime(d => {
                        // ğŸš€ é£è…¾æ´¾ä¼˜åŒ–: å‡æ…¢åŠ¨ç”»é€Ÿåº¦ä»¥é™ä½GPUè´Ÿè½½
                        if (d.rssi === 'coop') return 3000;   // åä½œé“¾è·¯ï¼šæ›´æ…¢ï¼ˆ3ç§’ï¼ŒåŸ2ç§’ï¼‰
                        if (d.rssi === 'high') return 1200;   // é«˜RSSIï¼šè¾ƒå¿«ï¼ˆ1.2ç§’ï¼ŒåŸ0.8ç§’ï¼‰
                        if (d.rssi === 'low') return 1800;    // ä½RSSIï¼šä¸­é€Ÿï¼ˆ1.8ç§’ï¼ŒåŸ1.2ç§’ï¼‰
                        return 1500;  // é»˜è®¤ï¼ˆ1.5ç§’ï¼ŒåŸ1ç§’ï¼‰
                    })
                    .arcLabel(d => `
                        <div style="background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; color: white; border: 2px solid ${linkColorMap[d.rssi]};">
                            <strong style="font-size: 16px;">${d.source} â†’ ${d.target}</strong><br>
                            <span style="color: #ccc;">${d.label} (RSSI: ${d.rssi})</span>
                        </div>
                    `);

                console.log(`âœ… é“¾è·¯æ˜¾ç¤ºå·²æ›´æ–°`);
            } catch (error) {
                console.error('âŒ æ›´æ–°é“¾è·¯å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–è§’è‰²ç‰¹å¾é¢æ¿
        function initRoleFeatures() {
            const featuresContent = document.getElementById('role-features-content');
            const featuresTitle = document.getElementById('role-features-title');

            if (currentNodeConfig.type === 'satellite') {
                // ğŸ›°ï¸ å«æ˜ŸèŠ‚ç‚¹ç‰¹å¾
                featuresTitle.textContent = 'ğŸ›°ï¸ å«æ˜Ÿç‰¹æ€§';
                featuresContent.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">è½¨é“é«˜åº¦</span>
                        <span class="info-value">${(currentNodeConfig.alt * 6371).toFixed(0)} km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">è¦†ç›–åŠå¾„</span>
                        <span class="info-value">~2000 km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ³¢æŸæ•°é‡</span>
                        <span class="info-value">å¤šæ³¢æŸ</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å·¥ä½œæ¨¡å¼</span>
                        <span class="info-value">é€æ˜è½¬å‘</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ä¸­ç»§èƒ½åŠ›</span>
                        <span class="info-value">âœ… æ”¯æŒ</span>
                    </div>
                `;
            } else if (currentNodeConfig.type === 'aircraft') {
                // âœˆï¸ æ— äººæœºèŠ‚ç‚¹ç‰¹å¾
                featuresTitle.textContent = 'âœˆï¸ æ— äººæœºç‰¹æ€§';
                featuresContent.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">é£è¡Œé«˜åº¦</span>
                        <span class="info-value">${(currentNodeConfig.alt * 6371).toFixed(1)} km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é£è¡ŒçŠ¶æ€</span>
                        <span class="info-value">ğŸŸ¢ å·¡èˆª</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç”µæ± ç”µé‡</span>
                        <span class="info-value">85%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é£è¡Œæ¨¡å¼</span>
                        <span class="info-value">ä¸­ç»§æ¨¡å¼</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">è¦†ç›–èŒƒå›´</span>
                        <span class="info-value">~50 km</span>
                    </div>
                `;
            } else {
                // ğŸ“± åœ°é¢ç»ˆç«¯ç‰¹å¾
                const groundHeight = Math.floor(Math.random() * 11); // 0-10méšæœºé«˜åº¦
                featuresTitle.textContent = 'ğŸ“± ç»ˆç«¯ç‰¹æ€§';
                featuresContent.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">è®¾å¤‡ç±»å‹</span>
                        <span class="info-value">ç§»åŠ¨ç»ˆç«¯</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åœ°é¢é«˜åº¦</span>
                        <span class="info-value">${groundHeight} m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ¥å…¥æ–¹å¼</span>
                        <span class="info-value">NOMA</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ä¿¡å·å¼ºåº¦</span>
                        <span class="info-value" id="signal-strength">è‰¯å¥½</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åä½œèƒ½åŠ›</span>
                        <span class="info-value">âœ… æ”¯æŒ</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åº”ç”¨åœºæ™¯</span>
                        <span class="info-value">æ•°æ®ä¼ è¾“</span>
                    </div>
                `;
            }

            console.log(`âœ… åˆå§‹åŒ–${currentNodeConfig.type}èŠ‚ç‚¹ç‰¹å¾é¢æ¿`);
        }

        // æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯æ˜¾ç¤º
        function updateNodeInfo(data) {
            if (!data || !data.status) {
                console.warn('updateNodeInfo: æ•°æ®ä¸ºç©º');
                return;
            }
            const status = data.status;
            console.log('æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯:', status);

            document.getElementById('info-role').textContent = status.role || '-';
            document.getElementById('info-altitude').textContent =
                status.altitude ? `${(status.altitude * 6371).toFixed(0)} km` : '-';
            document.getElementById('info-ip').textContent = status.ip || '-';
            document.getElementById('info-container-ip').textContent = status.container_ip || '-';

            console.log('èŠ‚ç‚¹ä¿¡æ¯å·²æ›´æ–°åˆ°DOM');
        }

        // æ›´æ–°é“¾è·¯åˆ—è¡¨
        function updateLinkList(links) {
            const linkList = document.getElementById('link-list');

            if (!links || links.length === 0) {
                console.log('é“¾è·¯åˆ—è¡¨ä¸ºç©º');
                linkList.innerHTML = '<p style="opacity: 0.5; text-align: center;">æš‚æ— æ´»è·ƒé“¾è·¯</p>';
                return;
            }

            console.log(`æ›´æ–°é“¾è·¯åˆ—è¡¨: ${links.length}æ¡é“¾è·¯`);
            linkList.innerHTML = '';

            links.forEach(link => {
                const item = document.createElement('div');
                item.className = 'link-item';

                item.innerHTML = `
                    <div class="link-header">
                        <span class="link-target">â†’ ${link.target}</span>
                        <span class="link-rssi ${link.rssi}">${link.rssi.toUpperCase()} RSSI</span>
                    </div>
                    <div class="link-details">
                        <div class="link-detail">å»¶è¿Ÿ: ${link.delay_ms}ms</div>
                        <div class="link-detail">å¸¦å®½: ${link.bandwidth_mbps}Mbps</div>
                        <div class="link-detail">ä¸¢åŒ…ç‡: ${link.packet_loss}%</div>
                        <div class="link-detail">çŠ¶æ€: ${link.active ? 'ğŸŸ¢ æ´»è·ƒ' : 'ğŸ”´ æ–­å¼€'}</div>
                    </div>
                `;

                linkList.appendChild(item);
            });
        }

        // æ›´æ–°PQ-NTORç»Ÿè®¡
        function updatePQNTORStats(pqntor) {
            if (!pqntor) {
                console.log('PQ-NTORæ•°æ®ä¸ºç©º');
                return;
            }
            console.log('æ›´æ–°PQ-NTORç»Ÿè®¡:', pqntor);

            document.getElementById('pqntor-handshakes').textContent = pqntor.handshakes || 0;
            document.getElementById('pqntor-time').textContent =
                (pqntor.avg_time_ms || 0).toFixed(1) + 'ms';
        }

        // æ›´æ–°æµé‡ç»Ÿè®¡
        function updateTraffic(traffic) {
            if (!traffic) {
                console.log('æµé‡æ•°æ®ä¸ºç©º');
                return;
            }
            console.log('æ›´æ–°æµé‡ç»Ÿè®¡:', traffic);

            document.getElementById('traffic-up').textContent = `${traffic.up_kbps || 0} KB/s`;
            document.getElementById('traffic-down').textContent = `${traffic.down_kbps || 0} KB/s`;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæµé‡æ•°æ®
        function generateSimulatedTraffic() {
            // æ ¹æ®èŠ‚ç‚¹ç±»å‹ç”Ÿæˆä¸åŒèŒƒå›´çš„æµé‡
            let upRange, downRange;

            if (currentNodeConfig.type === 'satellite') {
                // å«æ˜Ÿï¼šé«˜æµé‡
                upRange = [500, 2000];
                downRange = [1000, 3000];
            } else if (currentNodeConfig.type === 'aircraft') {
                // æ— äººæœºï¼šä¸­ç­‰æµé‡
                upRange = [200, 800];
                downRange = [300, 1200];
            } else {
                // åœ°é¢ç»ˆç«¯ï¼šè¾ƒä½æµé‡
                upRange = [50, 300];
                downRange = [100, 500];
            }

            const upTraffic = Math.floor(Math.random() * (upRange[1] - upRange[0]) + upRange[0]);
            const downTraffic = Math.floor(Math.random() * (downRange[1] - downRange[0]) + downRange[0]);

            updateTraffic({
                up_kbps: upTraffic,
                down_kbps: downTraffic
            });
        }

        // å¯åŠ¨æµé‡æ¨¡æ‹Ÿ
        function startTrafficSimulation() {
            // ç«‹å³ç”Ÿæˆä¸€æ¬¡
            generateSimulatedTraffic();

            // æ¯2ç§’æ›´æ–°ä¸€æ¬¡æµé‡æ•°æ®
            setInterval(() => {
                generateSimulatedTraffic();
            }, 2000);

            console.log('âœ… æµé‡æ¨¡æ‹Ÿå·²å¯åŠ¨');
        }

        // æ›´æ–°æ‹“æ‰‘ä¿¡æ¯
        function updateTopology(topologyId) {
            state.currentTopology = topologyId;
            document.getElementById('topology-name').textContent =
                `Topology ${topologyId}: ${topologyNames[topologyId - 1]}`;

            // æ›´æ–°3Dåœ°çƒé“¾è·¯æ˜¾ç¤º
            updateGlobeLinks();

            // æ›´æ–°å³ä¾§é“¾è·¯åˆ—è¡¨ï¼ˆæ ¹æ®å½“å‰æ‹“æ‰‘ç”Ÿæˆï¼‰
            updateLinkListFromTopology(topologyId);
        }

        // æ ¹æ®æ‹“æ‰‘ç”Ÿæˆé“¾è·¯åˆ—è¡¨
        function updateLinkListFromTopology(topologyId) {
            const allLinks = topologyLinks[topologyId] || [];
            // è¿‡æ»¤å‡ºå½“å‰èŠ‚ç‚¹ç›¸å…³çš„é“¾è·¯
            const nodeLinks = allLinks.filter(link =>
                link.source === NODE_ID || link.target === NODE_ID
            );

            console.log(`æ‹“æ‰‘${topologyId}ä¸­èŠ‚ç‚¹${NODE_ID}çš„é“¾è·¯:`, nodeLinks);

            const linkList = document.getElementById('link-list');

            if (nodeLinks.length === 0) {
                console.log(`èŠ‚ç‚¹${NODE_ID}åœ¨æ‹“æ‰‘${topologyId}ä¸­æ— é“¾è·¯`);
                linkList.innerHTML = '<p style="opacity: 0.5; text-align: center;">å½“å‰æ‹“æ‰‘ä¸­æ— æ´»è·ƒé“¾è·¯</p>';
                return;
            }

            linkList.innerHTML = '';

            nodeLinks.forEach(link => {
                const item = document.createElement('div');
                item.className = 'link-item';

                // ç¡®å®šé“¾è·¯æ–¹å‘å’Œå¯¹ç«¯èŠ‚ç‚¹
                const isSource = link.source === NODE_ID;
                const peerNode = isSource ? link.target : link.source;
                const direction = isSource ? 'å‘é€åˆ°' : 'æ¥æ”¶è‡ª';
                const peerConfig = nodeConfigs[peerNode];
                const peerName = peerConfig ? peerConfig.name : peerNode;
                const peerIcon = peerConfig ? peerConfig.icon : 'ğŸ“¡';

                // RSSIé¢œè‰²æ˜ å°„
                const rssiColors = {
                    high: '#4ade80',
                    low: '#ef4444',
                    coop: '#a855f7'
                };

                item.innerHTML = `
                    <div class="link-header">
                        <span class="link-target">${isSource ? 'â†’' : 'â†'} ${peerIcon} ${peerName}</span>
                        <span class="link-rssi ${link.rssi}" style="background: ${rssiColors[link.rssi]}; color: ${link.rssi === 'high' ? '#000' : '#fff'};">
                            ${link.rssi.toUpperCase()}
                        </span>
                    </div>
                    <div class="link-details">
                        <div class="link-detail">æ–¹å‘: ${direction}</div>
                        <div class="link-detail">ç±»å‹: ${link.label}</div>
                        <div class="link-detail">å¯¹ç«¯: ${peerNode}</div>
                        <div class="link-detail">çŠ¶æ€: ğŸŸ¢ æ´»è·ƒ</div>
                    </div>
                `;

                linkList.appendChild(item);
            });

            console.log(`âœ… æ›´æ–°é“¾è·¯åˆ—è¡¨: ${nodeLinks.length}æ¡é“¾è·¯`);
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            // è‡ªåŠ¨æ£€æµ‹WebSocketåœ°å€ï¼šæœ¬åœ°æµ‹è¯•ç”¨localhostï¼Œéƒ¨ç½²æ—¶ç”¨å®é™…IP
            const hostname = window.location.hostname;
            const wsHost = hostname === 'localhost' || hostname === '127.0.0.1'
                ? 'localhost'
                : '192.168.100.17';
            const wsUrl = `ws://${wsHost}:9000`;
            console.log('Connecting to WebSocket Hub:', wsUrl);

            state.websocket = new WebSocket(wsUrl);

            state.websocket.onopen = () => {
                console.log('WebSocket connected');

                // æ³¨å†Œä¸ºå‰ç«¯ï¼ˆèŠ‚ç‚¹è§†å›¾ä¹Ÿæ˜¯å‰ç«¯ï¼‰
                state.websocket.send(JSON.stringify({
                    client_type: 'frontend'
                }));

                document.getElementById('connection-status').textContent = 'WebSocket: å·²è¿æ¥';
                document.getElementById('connection-status').className = 'connection-status connected';
            };

            state.websocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('âœ… Received:', data.type);

                    if (data.type === 'all_nodes') {
                        // æ¥æ”¶æ‰€æœ‰èŠ‚ç‚¹æ•°æ®
                        console.log(`æ”¶åˆ°æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ï¼Œå…± ${Object.keys(data.nodes).length} ä¸ªèŠ‚ç‚¹`);
                        console.log(`å½“å‰èŠ‚ç‚¹ ${NODE_ID} çš„æ•°æ®:`, data.nodes[NODE_ID]);

                        state.nodeData = data.nodes[NODE_ID];
                        if (state.nodeData) {
                            console.log('âœ… å¼€å§‹æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯');
                            updateNodeInfo(state.nodeData);
                            // é“¾è·¯æ•°æ®ä»æ‹“æ‰‘ç”Ÿæˆï¼Œä¸ä½¿ç”¨WebSocketçš„links
                            updatePQNTORStats(state.nodeData.pq_ntor);
                            updateTraffic(state.nodeData.traffic);
                            console.log('âœ… èŠ‚ç‚¹ä¿¡æ¯æ›´æ–°å®Œæˆ');
                        } else {
                            console.warn(`âš ï¸ èŠ‚ç‚¹ ${NODE_ID} çš„æ•°æ®ä¸å­˜åœ¨`);
                        }
                        updateTopology(data.topology_id);

                    } else if (data.type === 'node_update' && data.node_id === NODE_ID) {
                        // å½“å‰èŠ‚ç‚¹æ›´æ–°
                        console.log(`æ”¶åˆ°èŠ‚ç‚¹ ${NODE_ID} çš„æ›´æ–°`);
                        state.nodeData = data.data;
                        updateNodeInfo(state.nodeData);
                        // é“¾è·¯æ•°æ®ä»æ‹“æ‰‘ç”Ÿæˆï¼Œä¸ä½¿ç”¨WebSocketçš„links
                        updatePQNTORStats(state.nodeData.pq_ntor);
                        updateTraffic(state.nodeData.traffic);

                    } else if (data.type === 'topology_changed') {
                        // æ‹“æ‰‘åˆ‡æ¢
                        console.log(`æ‹“æ‰‘åˆ‡æ¢åˆ°: ${data.topology_id}`);
                        updateTopology(data.topology_id);
                    }
                } catch (error) {
                    console.error('âŒ å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error);
                    console.error('æ¶ˆæ¯å†…å®¹:', event.data);
                }
            };

            state.websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            state.websocket.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'WebSocket: æ–­å¼€ï¼Œé‡è¿ä¸­...';
                document.getElementById('connection-status').className = 'connection-status';

                // é‡è¿
                setTimeout(connectWebSocket, 3000);
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ èŠ‚ç‚¹è§†å›¾é¡µé¢åŠ è½½å®Œæˆ, èŠ‚ç‚¹ID:', NODE_ID);

            // åº”ç”¨èŠ‚ç‚¹ç±»å‹ä¸»é¢˜
            document.body.classList.add(`theme-${currentNodeConfig.type}`);
            console.log(`âœ… åº”ç”¨${currentNodeConfig.type}èŠ‚ç‚¹ä¸»é¢˜`);

            // åˆå§‹åŒ–è§’è‰²ç‰¹å¾é¢æ¿
            initRoleFeatures();

            // å¯åŠ¨æµé‡æ¨¡æ‹Ÿ
            startTrafficSimulation();

            // å…ˆè¿æ¥WebSocketè·å–æ•°æ®
            connectWebSocket();

            // å»¶è¿ŸåŠ è½½Globeï¼Œé¿å…é˜»å¡é¡µé¢
            setTimeout(() => {
                console.log('å¼€å§‹åŠ è½½3Dåœ°çƒ...');
                initGlobe();

                // åˆå§‹åŒ–åæ˜¾ç¤ºé»˜è®¤æ‹“æ‰‘é“¾è·¯
                setTimeout(() => {
                    updateGlobeLinks();
                    updateLinkListFromTopology(state.currentTopology);
                    console.log('âœ… åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæ‹“æ‰‘1çš„é“¾è·¯å’Œé“¾è·¯åˆ—è¡¨');
                }, 500);
            }, 500);
        });
    </script>
</body>
</html>
