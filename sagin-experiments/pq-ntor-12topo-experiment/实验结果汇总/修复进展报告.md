# 12æ‹“æ‰‘å®éªŒä¿®å¤è¿›å±•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-27
**çŠ¶æ€**: ğŸŸ¡ éƒ¨åˆ†æˆåŠŸ - æ³¨å†Œå·¥ä½œï¼Œéœ€ä¿®å¤ Identity

---

## âœ… å·²å®Œæˆ

### 1. æœ¬åœ°æ¨¡å¼å®ç°
- âœ… `directory_server.c` - æ·»åŠ åŠ¨æ€èŠ‚ç‚¹æ³¨å†Œ
- âœ… `relay_registration.c` - åˆ›å»ºæ³¨å†Œå®¢æˆ·ç«¯
- âœ… `relay_main.c` - æ·»åŠ å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
- âœ… `Makefile` - æ·»åŠ  `-DUSE_LOCAL_MODE=1`

### 2. ç¼–è¯‘æˆåŠŸ
```
-rwxrwxr-x 1 user user 62K directory
-rwxrwxr-x 1 user user 1.7M relay
-rwxrwxr-x 1 user user 1.7M client
```

### 3. æ³¨å†ŒåŠŸèƒ½éªŒè¯

**Directory æˆåŠŸè¿”å›èŠ‚ç‚¹åˆ—è¡¨**:
```json
{
    "version": "1.0",
    "nodes": [
        {
            "hostname": "127.0.0.1",
            "port": 9001,
            "type": "guard",
            "identity": "2020202020202020202020202020202020202020"
        },
        {
            "hostname": "127.0.0.1",
            "port": 9002,
            "type": "middle",
            "identity": "3131313131313131313131313131313131313131"
        },
        {
            "hostname": "127.0.0.1",
            "port": 9003,
            "type": "exit",
            "identity": "4242424242424242424242424242424242424242"
        }
    ]
}
```

**è¿›åº¦å¯¹æ¯”**:
| é˜¶æ®µ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Directory å¯åŠ¨ | âœ… | âœ… |
| Relay æ³¨å†Œ | âŒ (ä¸æ³¨å†Œ) | âœ… **æˆåŠŸ** |
| èŠ‚ç‚¹æ•° | 0 | âœ… **3ä¸ª** |
| Client æŸ¥è¯¢ | è¿”å›ç©ºåˆ—è¡¨ | âœ… **è¿”å›3ä¸ªèŠ‚ç‚¹** |
| Client è¿æ¥ | è¶…æ—¶ | âœ… **æˆåŠŸè¿æ¥** |
| æ¡æ‰‹å®Œæˆ | âŒ | âŒ (identity ä¸åŒ¹é…) |

---

## âŒ å½“å‰é—®é¢˜

### Relay Identity ä¸åŒ¹é…

**é”™è¯¯æ—¥å¿—**:
```
[Guard] Error: relay_identity mismatch
[Guard] PQ-Ntor handshake failed
```

**åŸå› åˆ†æ**:

1. **Directory ç”Ÿæˆçš„ identity** (registrationæ—¶):
   ```c
   memset(nodes[num_nodes].identity, (type + 1) * 0x10 + num_nodes, 20);
   // Guard (type=1): 0x20 repeated 20 times
   ```

2. **Relay è‡ªå·±çš„ identity** (é…ç½®ä¸­):
   ```c
   memset(config.identity, 0x01, sizeof(config.identity)); // Guard
   // Guard: 0x01 repeated 20 times
   ```

3. **Client ä½¿ç”¨ Directory çš„ identity** (0x20...)
4. **Relay éªŒè¯æ—¶ä½¿ç”¨è‡ªå·±çš„ identity** (0x01...)
5. **ç»“æœ**: ä¸åŒ¹é… âŒ

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: Relay æ³¨å†Œæ—¶ä¸Šä¼ è‡ªå·±çš„ identity

ä¿®æ”¹æ³¨å†Œåè®®åŒ…å«å®é™… identity:

```json
POST /register
{
    "hostname": "127.0.0.1",
    "port": 9001,
    "type": 1,
    "identity": "0101010101010101010101010101010101010101"
}
```

**å®ç°**:
1. ä¿®æ”¹ `register_with_directory()` æ¥å— identity å‚æ•°
2. åœ¨ relay_main.c ä¸­ä¼ é€’ `config.identity`
3. Directory ä½¿ç”¨æ¥æ”¶åˆ°çš„ identity

### æ–¹æ¡ˆ B: ç®€åŒ– - å–æ¶ˆ identity éªŒè¯ (ä¸´æ—¶)

åœ¨ LOCAL_MODE ä¸‹è·³è¿‡ identity æ£€æŸ¥:

```c
#ifdef USE_LOCAL_MODE
    // Skip identity verification in local mode
#else
    // Normal identity verification
#endif
```

---

## ğŸ“Š æµ‹è¯•ç»“æœå¯¹æ¯”

### ä¿®å¤å‰
```
æ€»æµ‹è¯•: 24
æˆåŠŸ: 0
å¤±è´¥: 24 (å…¨éƒ¨è¶…æ—¶ 30ç§’)
åŸå› : Directory è¿”å›ä¸å­˜åœ¨çš„ IP (172.20.x.x)
```

### ä¿®å¤å (å½“å‰)
```
æ€»æµ‹è¯•: 24
æˆåŠŸ: 0
å¤±è´¥: 24 (å¿«é€Ÿå¤±è´¥ <0.01ç§’)
åŸå› : Relay identity ä¸åŒ¹é…
è¿›å±•: âœ… è¿æ¥æˆåŠŸï¼Œæ¡æ‰‹å¤±è´¥
```

### é¢„æœŸ (ä¿®å¤ identity å)
```
æ€»æµ‹è¯•: 24
æˆåŠŸ: 24
å¤±è´¥: 0
å®Œæ•´çš„ PQ-NTOR æ¡æ‰‹æˆåŠŸ
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `c/src/directory_server.c` | âœ… å®Œæˆ | æœ¬åœ°æ¨¡å¼ + åŠ¨æ€æ³¨å†Œ |
| `c/src/relay_registration.c` | âœ… å®Œæˆ | æ³¨å†Œå®¢æˆ·ç«¯ |
| `c/include/relay_registration.h` | âœ… å®Œæˆ | å¤´æ–‡ä»¶ |
| `c/programs/relay_main.c` | âœ… å®Œæˆ | æ·»åŠ æ³¨å†Œè°ƒç”¨ |
| `c/Makefile` | âœ… å®Œæˆ | -DUSE_LOCAL_MODE=1 |
| `c/src/relay_registration.c` | â³ å¾…ä¿®å¤ | éœ€æ·»åŠ  identity å‚æ•° |
| `c/src/directory_server.c` | â³ å¾…ä¿®å¤ | éœ€æ¥å— identity å­—æ®µ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³æ‰§è¡Œ

1. **ä¿®æ”¹æ³¨å†Œåè®®** - æ·»åŠ  identity å­—æ®µ
2. **é‡æ–°ç¼–è¯‘** - æ›´æ–°æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶
3. **æµ‹è¯•éªŒè¯** - ç¡®è®¤æ¡æ‰‹æˆåŠŸ
4. **è¿è¡Œå®Œæ•´12æ‹“æ‰‘æµ‹è¯•** - éªŒè¯æ‰€æœ‰24ä¸ªæµ‹è¯•

### é¢„è®¡æ—¶é—´

- ä¿®å¤ identity: 10åˆ†é’Ÿ
- é‡æ–°ç¼–è¯‘æµ‹è¯•: 5åˆ†é’Ÿ
- å®Œæ•´12æ‹“æ‰‘æµ‹è¯•: 5-10åˆ†é’Ÿ
- **æ€»è®¡**: ~25åˆ†é’Ÿ

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### å·²å®ç°çš„åŠŸèƒ½

1. **æ¡ä»¶ç¼–è¯‘** - æ”¯æŒ LOCAL/SAGIN åŒæ¨¡å¼
2. **åŠ¨æ€æ³¨å†Œ** - HTTP POST /register API
3. **è‡ªåŠ¨å‘ç°** - Relay å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
4. **JSON API** - æ ‡å‡† REST æ¥å£
5. **è·¨å¹³å°** - WSL2 å’Œ ARM64 éƒ½æ”¯æŒ

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Directory  â”‚ :5000
â”‚  (HTTP API) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /register
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                             â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
   â”‚ Guard  â”‚  â”‚  Middle  â”‚  â”‚   Exit   â”‚
   â”‚  :9001 â”‚  â”‚   :9002  â”‚  â”‚   :9003  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚ GET /nodes
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚ Client â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡æ¡£ä½ç½®

- **æœ¬æ–‡ä»¶**: `å®éªŒç»“æœæ±‡æ€»/ä¿®å¤è¿›å±•æŠ¥å‘Š.md`
- **è¯¦ç»†ä¿®å¤æ–‡æ¡£**: `å®éªŒç»“æœæ±‡æ€»/LOCAL_MODE_FIX.md`
- **ç®€æ´è¯´æ˜**: `å®éªŒç»“æœæ±‡æ€»/ä¿®å¤è¯´æ˜_ç®€æ´ç‰ˆ.md`

---

**åˆ›å»º**: Claude Code
**æœ€åæ›´æ–°**: 2025-11-27 16:06
**çŠ¶æ€**: ğŸŸ¡ æ¥è¿‘å®Œæˆï¼Œéœ€ä¿®å¤ identity åŒ¹é…é—®é¢˜
