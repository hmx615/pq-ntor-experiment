# 飞腾派Classic vs PQ-NTOR对比实验指南

**目标**: 在真实ARM硬件上验证Classic NTOR和PQ-NTOR的性能对比

---

## 📋 实验目的

### 当前WSL2实验的局限性
1. **模拟网络**: 使用`tc netem`模拟延迟，非真实网络
2. **x86架构**: Intel/AMD处理器，性能较强
3. **单机环境**: 所有组件运行在同一台机器上

### 飞腾派实验的价值
1. **真实ARM硬件**: 飞腾派使用ARM架构（资源受限）
2. **真实网络环境**: 实际物理网络延迟和波动
3. **分布式部署**: 模拟真实SAGIN场景
4. **论文说服力**: 证明在真实硬件和网络下的可行性

---

## 🎯 实验假设

### 预期发现

**算法性能（ARM vs x86）**:
| 指标 | WSL2 (x86) | 飞腾派 (ARM) | 预期 |
|------|------------|-------------|------|
| Classic握手 | 0.156 ms | ?ms | 可能更慢 |
| PQ握手 | 0.031 ms | ?ms | 可能更慢 |
| 差异比例 | 5倍 | ?倍 | 应该相似 |

**网络性能**:
- 真实网络延迟可能更大
- 但"网络延迟主导效应"应该仍然成立
- 即使ARM慢一些，握手差异在网络延迟下仍然可忽略

### 核心论点验证

> "在资源受限的ARM设备（飞腾派）和真实网络环境下，PQ-NTOR的握手性能优势依然明显（算法层面），但在实际SAGIN网络中，网络延迟主导效应使得两种协议的端到端性能差异可忽略。"

---

## 🚀 部署步骤

### 前提条件

**飞腾派设备信息**:
- IP地址: `192.168.5.110`
- 用户名/密码: `user/user`
- 系统: Ubuntu/Debian ARM64
- 已安装: GCC, OpenSSL, liboqs

**网络要求**:
- 本地WSL2能ping通飞腾派
- SSH可以连接

### 步骤1: 运行部署脚本

```bash
cd /home/ccc/pq-ntor-experiment/sagin-experiments/pq-ntor-12topo-experiment/scripts
./deploy_to_phytium.sh
```

**脚本会自动完成**:
1. ✓ 检查飞腾派连接
2. ✓ 检查依赖环境（GCC, liboqs, OpenSSL）
3. ✓ 创建目录结构
4. ✓ 复制C源代码（包含Classic NTOR）
5. ✓ 复制测试脚本和拓扑配置
6. ✓ 在ARM上编译程序
7. ✓ 运行基础功能测试
8. ✓ 运行性能基准测试

### 步骤2: SSH登录飞腾派

```bash
ssh user@192.168.5.110
```

### 步骤3: 查看Benchmark结果（ARM性能）

```bash
cd ~/pq-ntor-experiment/c
cat benchmark_arm_results.txt
```

**关注指标**:
- Classic NTOR握手时间（ARM）
- PQ-NTOR握手时间（ARM）
- 与x86的性能差异

---

## 🧪 实验方案

### 方案A: 单设备测试（当前）

**配置**:
```
飞腾派 (localhost)
├─ Client
├─ Guard Relay
├─ Middle Relay
├─ Exit Relay
└─ Directory Server
```

**测试**:
- 运行12拓扑Classic测试
- 运行12拓扑PQ测试
- 对比ARM上的性能数据

**命令**:
```bash
cd ~/pq-ntor-experiment/sagin-experiments/pq-ntor-12topo-experiment/scripts

# Classic模式测试
python3 run_pq_ntor_12topologies.py --mode classic --runs 10

# PQ模式测试
python3 run_pq_ntor_12topologies.py --mode pq --runs 10
```

### 方案B: 多设备分布式测试（理想）

**配置**（需要多个飞腾派）:
```
飞腾派1 (192.168.5.110)  →  飞腾派2 (192.168.5.111)  →  飞腾派3 (192.168.5.112)
  Client                    Middle Relay                Exit Relay
  Guard Relay
```

**优势**:
- 真实网络延迟
- 真实分布式场景
- 更接近实际SAGIN部署

**实施条件**:
- 需要至少2-3个飞腾派设备
- 设备间网络互通
- 修改配置文件指定IP地址

---

## 📊 数据收集

### 需要收集的数据

**1. ARM基准测试数据**:
```
~/pq-ntor-experiment/c/benchmark_arm_results.txt
```
- Classic握手时间（ARM）
- PQ握手时间（ARM）
- 与x86对比

**2. 12拓扑测试数据**:
```
~/pq-ntor-experiment/sagin-experiments/pq-ntor-12topo-experiment/results/phytium_pi/
├── topo01_classic_results.json
├── topo01_pq_results.json
├── ...
├── topo12_classic_results.json
└── topo12_pq_results.json
```

**3. 对比分析**:
| 环境 | 架构 | Classic握手 | PQ握手 | 差异 | 电路建立差异 |
|------|------|------------|--------|------|-------------|
| WSL2 | x86-64 | 0.156ms | 0.031ms | 5× | 0.00ms |
| 飞腾派 | ARM64 | ?ms | ?ms | ?× | ?ms |

---

## 🔍 预期结果

### 情况1: ARM性能更慢，但比例相似

**数据**:
- Classic: 0.3ms (ARM) vs 0.156ms (x86)
- PQ: 0.06ms (ARM) vs 0.031ms (x86)
- 差异: 仍然5倍

**结论**:
✅ ARM虽然慢，但PQ优势依然明显
✅ 网络延迟主导效应在ARM上同样成立

### 情况2: ARM性能差异缩小

**数据**:
- Classic: 0.3ms (ARM)
- PQ: 0.1ms (ARM)
- 差异: 3倍（缩小了）

**原因**:
- ARM对后量子算法优化更好
- 或Classic NTOR在ARM上性能下降更多

**结论**:
✅ 仍证明PQ优势
✅ 网络延迟主导效应依然成立

### 情况3: 网络延迟更大

**数据**:
- 真实网络延迟: 50-100ms (vs 模拟15-40ms)
- 握手差异: 0.2ms
- 差异占比: <0.4%（更小）

**结论**:
✅ 网络延迟越大，握手差异越可忽略
✅ 更强的论据支持PQ-NTOR可行性

---

## 📝 论文呈现

### 实验章节结构

**5. 实验评估**

**5.1 实验环境**
- 环境1: WSL2 + tc netem模拟（算法验证）
- 环境2: 飞腾派ARM设备 + 真实网络（实际验证）

**5.2 算法性能对比**
- 表1: x86 vs ARM算法性能对比
- 发现: ARM慢?%，但比例相似

**5.3 SAGIN网络性能**
- 表2: 12拓扑在两种环境下的对比
- 发现: 网络延迟主导效应在两种环境下都成立

**5.4 真实硬件验证**
- 飞腾派ARM设备测试结果
- 证明在资源受限设备上的可行性

### 论文引用示例

> "为了验证PQ-NTOR在真实硬件和网络环境下的性能，我们在飞腾派ARM开发板（FT-2000/4）上进行了对比实验。尽管ARM架构的计算性能低于x86（Classic NTOR握手慢?%，PQ-NTOR握手慢?%），但PQ-NTOR相对Classic NTOR的性能优势依然明显（快?倍）。更重要的是，在真实网络环境下（延迟?-?ms），两种协议的电路建立时间差异仍为0.00ms，进一步验证了网络延迟主导效应。这证明了PQ-NTOR在资源受限的SAGIN边缘设备上同样可行。"

---

## 🐛 故障排除

### 问题1: 无法连接飞腾派

**检查**:
```bash
ping 192.168.5.110
ssh user@192.168.5.110
```

**解决**:
- 确认飞腾派开机
- 检查IP地址是否正确
- 检查网络配置

### 问题2: liboqs未安装

**症状**: 编译时找不到liboqs

**解决**:
```bash
ssh user@192.168.5.110
cd ~/
# 运行liboqs安装脚本
./install_liboqs_arm.sh
```

### 问题3: 编译失败

**检查依赖**:
```bash
ssh user@192.168.5.110
gcc --version
openssl version
pkg-config --libs openssl
```

### 问题4: Python脚本报错

**检查Python环境**:
```bash
ssh user@192.168.5.110
python3 --version
python3 -c "import json, pathlib"
```

---

## 📈 数据分析

### 本地分析飞腾派数据

**步骤1: 下载飞腾派数据**
```bash
cd /home/ccc/pq-ntor-experiment/sagin-experiments/pq-ntor-12topo-experiment
scp -r user@192.168.5.110:~/pq-ntor-experiment/sagin-experiments/pq-ntor-12topo-experiment/results/phytium_pi/ results/
```

**步骤2: 生成对比报告**
```bash
cd scripts
python3 generate_phytium_comparison_report.py
```

**步骤3: 更新可视化图表**
- 在图表中添加ARM数据
- 对比x86 vs ARM性能

---

## ✅ 检查清单

部署前:
- [ ] 飞腾派网络连通
- [ ] SSH可以登录
- [ ] liboqs已安装

部署后:
- [ ] C程序编译成功
- [ ] test_classic_ntor通过
- [ ] test_pq_ntor通过
- [ ] benchmark运行成功

测试前:
- [ ] directory服务器启动
- [ ] relay程序可运行
- [ ] client支持--mode参数

测试后:
- [ ] 12拓扑Classic数据收集
- [ ] 12拓扑PQ数据收集
- [ ] 数据下载到本地
- [ ] 生成对比报告

---

## 📚 相关文档

- `deploy_to_phytium.sh` - 自动部署脚本
- `run_pq_ntor_12topologies.py` - 12拓扑测试脚本
- `飞腾派访问指南-正确IP.md` - 飞腾派连接说明

---

**版本**: v1.0
**日期**: 2025-11-26
**状态**: 准备就绪，可开始部署
