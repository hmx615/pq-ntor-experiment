# PQ-NTOR 代码重构评估与本地验证方案

**评估日期**: 2025-11-12
**评估对象**: PQ-NTOR现有代码适配SAGIN 7节点拓扑
**结论**: ❌ **不需要重构**，仅需 ✅ **适配和扩展**

---

## 📋 执行摘要

### 问题1: 是否需要重构？

**答案**: ❌ **不需要重构核心代码**

**原因**:
- PQ-NTOR核心协议代码（Kyber握手、洋葱加密）已经稳定且正确
- 现有3跳架构（Guard-Middle-Exit）本质上支持任意拓扑
- 只需要适配测试脚本和配置文件

**需要修改的范围**: ✅ **轻量级适配**
- 预计修改代码量: **~500-800行** (新增为主，修改为辅)
- 占现有代码比例: ~10-15% (现有C代码5175行)
- 不涉及核心协议逻辑

### 问题2: 能否先本地验证？

**答案**: ✅ **完全可行，且强烈推荐**

**优势**:
- x86环境调试工具丰富（GDB、Valgrind等）
- 开发迭代速度快
- 降低硬件风险
- Skyfield纯Python，跨平台无问题

**注意事项**:
- 性能数据仅供参考（需在飞腾派最终测试）
- Docker镜像架构需注意（x86 vs ARM）

---

## 1. 现有代码结构分析

### 1.1 代码统计

```
总代码量统计:
┌─────────────────────────────────────────────────────┐
│ 组件               │ 文件数 │ 代码行数 │ 功能状态   │
├─────────────────────────────────────────────────────┤
│ C核心代码           │   19   │  ~5175  │ ✅ 稳定    │
│ Python辅助脚本      │    8   │  ~1200  │ ✅ 可用    │
│ Bash测试脚本        │   12   │  ~1500  │ ⚠️ 需适配  │
│ 配置文件            │    5   │   ~200  │ ⚠️ 需扩展  │
├─────────────────────────────────────────────────────┤
│ 总计                │   44   │  ~8075  │ -          │
└─────────────────────────────────────────────────────┘
```

### 1.2 核心模块

**C代码核心模块** (`/c/src/`):

| 文件 | 行数 | 功能 | 是否需要改 |
|------|------|------|-----------|
| `pq_ntor.c/h` | ~500 | **PQ-NTOR握手协议** | ❌ 不改 |
| `kyber_kem.c/h` | ~300 | **Kyber KEM封装** | ❌ 不改 |
| `onion_crypto.c/h` | ~600 | **洋葱加密/解密** | ❌ 不改 |
| `cell.c/h` | ~800 | **Tor Cell处理** | ❌ 不改 |
| `relay_node.c/h` | ~1500 | **中继节点逻辑** | ⚠️ 微调 |
| `tor_client.c/h` | ~1200 | **客户端逻辑** | ⚠️ 微调 |
| `directory_server.c/h` | ~400 | **目录服务器** | ⚠️ 扩展 |
| `crypto_utils.c/h` | ~300 | **密码学工具** | ❌ 不改 |
| `test_server.c/h` | ~300 | **测试服务器** | ❌ 不改 |

**关键发现**:
- ✅ **协议核心代码无需改动** (pq_ntor, kyber, onion_crypto, cell)
- ⚠️ **仅需微调** (relay_node, tor_client - 主要是日志和配置)
- ⚠️ **需要扩展** (directory_server - 支持更多节点信息)

---

## 2. 需要修改的内容

### 2.1 必须修改的部分 (P0)

#### 修改1: Directory Server扩展 ⏱️ 预计1-2小时

**文件**: `c/src/directory_server.c`

**当前状态**:
```c
// 现有：固定3个relay信息
typedef struct {
    char ip[16];
    int port;
    uint8_t identity[32];
    char nickname[32];
} RelayInfo;

RelayInfo relays[3];  // Guard, Middle, Exit
```

**需要改为**:
```c
// 新增：支持最多16个节点（7个实际+备用）
#define MAX_RELAYS 16

typedef struct {
    char ip[16];
    int port;
    uint8_t identity[32];
    char nickname[32];
    char node_type[16];    // 新增：satellite/aircraft/ground
    int layer;             // 新增：0=space, 1=air, 2=ground
    float latitude;        // 新增：地理位置（用于日志）
    float longitude;
} RelayInfo;

RelayInfo relays[MAX_RELAYS];
int relay_count = 0;
```

**改动量**: ~50行新增，~20行修改

---

#### 修改2: 测试脚本适配 ⏱️ 预计3-4小时

**文件**: `sagin-experiments/run_sagin_experiments.sh`

**现有逻辑**:
```bash
# 固定启动3个relay
start_relay "guard" 9001
start_relay "middle" 9002
start_relay "exit" 9003
```

**需要改为**:
```bash
# 根据配置文件启动7个节点
NODES=("sat-1" "sat-2" "aircraft-1" "aircraft-2" "gs-beijing" "gs-london" "gs-newyork")
PORTS=(9001 9002 9003 9004 9005 9006 9007)

for i in "${!NODES[@]}"; do
    start_node "${NODES[$i]}" "${PORTS[$i]}"
done
```

**改动量**: ~150行新增，~50行修改

---

#### 修改3: 路由指定功能 ⏱️ 预计2-3小时

**文件**: `c/src/tor_client.c`

**需要新增**:
```c
// 新增：指定电路路径
int build_circuit_with_path(TorClient *client,
                            const char *hop1_name,
                            const char *hop2_name,
                            const char *hop3_name) {
    // 从directory查找对应节点
    RelayInfo *hop1 = find_relay_by_name(hop1_name);
    RelayInfo *hop2 = find_relay_by_name(hop2_name);
    RelayInfo *hop3 = find_relay_by_name(hop3_name);

    // 按顺序建立电路
    // ... (现有build_circuit逻辑可复用)
}

// 新增：从名称查找relay
RelayInfo* find_relay_by_name(const char *name) {
    for (int i = 0; i < relay_count; i++) {
        if (strcmp(relays[i].nickname, name) == 0) {
            return &relays[i];
        }
    }
    return NULL;
}
```

**改动量**: ~100行新增

---

#### 修改4: 测试数据记录增强 ⏱️ 预计1-2小时

**文件**: `sagin-experiments/run_sagin_experiments.sh`

**当前CSV格式**:
```csv
Config,Run,Time(s),Status
leo,1,4.523,success
```

**需要改为**:
```csv
timestamp,link_type,node1,node2,distance_km,delay_ms,protocol,test_id,circuit_time_s,status
2025-11-12T10:30:00Z,ISL,Sat-1,Sat-2,3245.6,10.8,PQ-NTOR,1,4.523,success
```

**改动量**: ~50行修改

---

### 2.2 可选修改的部分 (P1)

#### 可选1: 性能统计增强

**文件**: `c/src/tor_client.c`

**新增功能**:
- 分步计时（握手、每一跳的延迟）
- 内存占用统计
- 丢包率记录

**改动量**: ~150行新增

---

#### 可选2: 可视化日志

**文件**: 新建 `c/src/logger.c`

**功能**:
- 结构化日志输出（JSON格式）
- 实时性能监控
- 与Skyfield仿真器集成

**改动量**: ~200行新增

---

### 2.3 新增组件 (必须)

#### 新增1: Skyfield轨道仿真器

**文件**: 新建 `sagin-experiments/sagin_orbit_simulator.py`

**代码量**: ~500行 (已在工作列表中设计)

**功能**:
- 卫星/飞机位置计算
- 链路可见性判断
- 网络拓扑回调

**依赖**: Skyfield库（纯Python，无需修改C代码）

---

#### 新增2: Docker网络管理器

**文件**: 新建 `sagin-experiments/network_topology_manager.py`

**代码量**: ~300行 (已在工作列表中设计)

**功能**:
- 监听轨道仿真器输出
- 动态调整tc netem规则
- 链路启用/禁用

**依赖**: Docker、tc命令（系统工具）

---

#### 新增3: 7节点配置文件

**文件**: 新建 `sagin-experiments/sagin_topology_config.json`

**代码量**: ~100行 (JSON配置)

**内容**:
```json
{
  "satellites": {...},
  "aircraft": {...},
  "ground_stations": {...},
  "link_constraints": {...}
}
```

---

## 3. 代码改动量总结

### 3.1 按优先级分类

| 优先级 | 类型 | 文件数 | 代码量 | 工作量 |
|-------|------|-------|--------|--------|
| **P0 必须** | C代码修改 | 3 | ~150行 | 2-3小时 |
| **P0 必须** | 脚本适配 | 2 | ~200行 | 3-4小时 |
| **P0 必须** | Python新增 | 2 | ~800行 | 1天 |
| **P0 必须** | 配置文件 | 1 | ~100行 | 1小时 |
| **P1 可选** | C代码增强 | 2 | ~350行 | 4小时 |
| **总计 (P0)** | - | **8** | **~1250行** | **~2天** |
| **总计 (含P1)** | - | **10** | **~1600行** | **2.5天** |

### 3.2 按语言分类

```
改动统计:
┌─────────────────────────────────────────────────────┐
│ 语言     │ 新增行数 │ 修改行数 │ 合计   │ 占总量比例 │
├─────────────────────────────────────────────────────┤
│ C        │   250    │   120    │  370   │   ~7%     │
│ Python   │   800    │    50    │  850   │   新增     │
│ Bash     │   150    │   100    │  250   │  ~17%     │
│ JSON     │   100    │     0    │  100   │   新增     │
├─────────────────────────────────────────────────────┤
│ 总计     │  1300    │   270    │ 1570   │   -       │
└─────────────────────────────────────────────────────┘

核心协议代码改动率: 0%  ← 重点！
总体代码改动率: ~15% (相对现有8075行)
```

### 3.3 风险评估

| 改动部分 | 风险等级 | 说明 |
|---------|---------|------|
| **PQ-NTOR协议核心** | 🟢 无风险 | 完全不改 |
| **Kyber KEM** | 🟢 无风险 | 完全不改 |
| **洋葱加密** | 🟢 无风险 | 完全不改 |
| **Directory扩展** | 🟡 低风险 | 向后兼容，纯扩展 |
| **Client路由指定** | 🟡 低风险 | 新增功能，不影响现有 |
| **测试脚本** | 🟢 无风险 | 独立脚本 |
| **Skyfield仿真器** | 🟢 无风险 | 新增模块 |

**结论**: ✅ **改动风险极低，不影响核心功能**

---

## 4. 本地验证方案 (强烈推荐)

### 4.1 本地验证环境

**推荐配置**:
```
操作系统: Ubuntu 22.04 x86_64 (WSL2 或虚拟机)
CPU: 任意 (Intel/AMD)
内存: 8GB+
Docker: 20.10+
Python: 3.8+
```

**优势对比**:

| 维度 | 本地x86环境 | 飞腾派ARM环境 |
|-----|------------|--------------|
| **开发速度** | ⚡ 快 | 🐌 慢 |
| **调试工具** | ✅ GDB, Valgrind, perf | ⚠️ 有限 |
| **编译速度** | ⚡ <10秒 | 🐌 ~1分钟 |
| **崩溃恢复** | ⚡ 即时重启 | 🐌 可能需要重启板子 |
| **Skyfield兼容** | ✅ 完美 | ✅ 完美 |
| **Docker支持** | ✅ 原生 | ✅ 支持 |
| **性能数据准确性** | ⚠️ 仅供参考 | ✅ 最终数据 |

---

### 4.2 本地验证步骤

#### 阶段1: 基础功能验证 (Day 1-2)

```bash
# 在本地x86环境（WSL2或虚拟机）

# 1. 安装依赖
sudo apt update
sudo apt install build-essential python3-pip docker.io iproute2
pip3 install skyfield numpy scipy matplotlib

# 2. 克隆或同步代码
cd ~/projects
git clone <your-repo> pq-ntor-local
cd pq-ntor-local

# 3. 编译C代码
cd c
make clean && make all
# 预期耗时: 10-30秒

# 4. 测试基础3跳功能（确保现有功能没坏）
./test_network.sh
# 预期结果: ✓ 3-hop circuit works

# 5. 开发并测试Skyfield仿真器
cd ../sagin-experiments
vim sagin_orbit_simulator.py
# 实现基本功能

python3 sagin_orbit_simulator.py
# 预期结果: ✓ 能正确计算7个节点的位置
```

**验收标准**:
- ✅ 现有3跳测试全部通过（确保没有破坏现有功能）
- ✅ Skyfield能正确计算卫星/飞机位置
- ✅ 内存占用<500MB

---

#### 阶段2: 扩展功能开发 (Day 3-4)

```bash
# 1. 修改Directory Server支持7节点
vim c/src/directory_server.c
# 增加MAX_RELAYS、node_type等字段

# 2. 重新编译
cd c && make all

# 3. 测试7节点启动
cd ../sagin-experiments
vim run_sagin_experiments_v2.sh
# 适配脚本启动7个节点

bash run_sagin_experiments_v2.sh --test-startup
# 预期结果: ✓ 7个容器全部启动

# 4. 测试路径指定功能
# 修改tor_client.c，添加build_circuit_with_path()
cd ../c && vim src/tor_client.c
# 实现代码

make all

# 测试：Client → Sat-1 → Sat-2 → GS-NewYork
./client --path "Sat-1,Sat-2,GS-NewYork"
# 预期结果: ✓ 按指定路径建立电路
```

**验收标准**:
- ✅ 7个节点容器成功启动
- ✅ Directory服务器正确返回7个节点信息
- ✅ 客户端能指定任意3跳路径

---

#### 阶段3: 集成测试 (Day 5)

```bash
# 1. 集成轨道仿真器与网络管理器
python3 sagin_orbit_simulator.py &
python3 network_topology_manager.py &

# 等待10秒观察拓扑更新
sleep 10

# 2. 运行单次测试
bash run_single_test.sh --link ISL --nodes "Sat-1,Sat-2"
# 预期结果: ✓ 成功完成测试并记录数据

# 3. 运行小规模测试集（10次）
bash run_sagin_experiments_v2.sh --runs 10 --quick-test
# 预期结果: ✓ 生成10条CSV记录
```

**验收标准**:
- ✅ 轨道仿真器稳定运行>30分钟
- ✅ 拓扑更新正确应用到Docker网络
- ✅ 能成功完成端到端测试
- ✅ CSV数据格式正确

---

#### 阶段4: 本地性能基准 (Day 6, 可选)

```bash
# 运行完整测试集（100次）
bash run_sagin_experiments_v2.sh --runs 100

# 生成初步图表
python3 generate_figures.py

# 检查结果
ls -lh results/
# 预期输出:
# - sagin_test_results.csv (~100条记录)
# - figure1_circuit_time.pdf
# - figure2_link_comparison.pdf
```

**注意**:
⚠️ **本地性能数据仅供验证逻辑正确性**
- 绝对时延不准（x86 vs ARM性能差异）
- 相对趋势可参考（ISL > SGLink > AGLink）

---

### 4.3 移植到飞腾派

#### 移植前检查清单

- [ ] 本地所有测试通过
- [ ] 代码已提交到git（或打包）
- [ ] 飞腾派环境已准备
- [ ] 飞腾派已安装依赖（Skyfield、Docker等）

#### 移植步骤

```bash
# 方案A: 通过git同步（推荐）
# 在飞腾派上
cd /home/ccc/pq-ntor-experiment
git pull origin main
cd c && make clean && make all

# 方案B: 通过scp同步
# 在本地
tar -czf pq-ntor-local.tar.gz pq-ntor-local/
scp pq-ntor-local.tar.gz feitian-pi:~/

# 在飞腾派上
ssh feitian-pi
tar -xzf pq-ntor-local.tar.gz
cd pq-ntor-local/c && make all

# 验证编译
./directory --version
./relay --version
./client --version
```

#### 移植后验证

```bash
# 1. 快速冒烟测试（5分钟）
cd /home/ccc/pq-ntor-experiment/sagin-experiments
bash run_sagin_experiments_v2.sh --runs 1 --quick-test

# 预期结果: ✓ 单次测试成功

# 2. 小规模测试（30分钟）
bash run_sagin_experiments_v2.sh --runs 10

# 3. 对比本地结果
# 检查性能趋势是否一致（不看绝对值）
```

---

### 4.4 本地 vs 飞腾派对比

| 指标 | 本地x86预期 | 飞腾派ARM预期 | 对比 |
|-----|-----------|--------------|------|
| **编译时间** | 10秒 | 30-60秒 | 本地快6倍 |
| **电路建立时间** | 2-5秒 | 3-7秒 | 飞腾派慢~40% |
| **握手延迟** | 10-50ms | 15-70ms | 飞腾派慢~40% |
| **内存占用** | 400MB | 600MB | 飞腾派多50% |
| **CPU占用** | 5% | 10% | 飞腾派高2倍 |
| **性能趋势** | ISL>SGLink>AGLink | ISL>SGLink>AGLink | ✅ 一致 |

**关键结论**:
- ✅ 相对性能趋势一致（论文关注点）
- ⚠️ 绝对数值有差异（但不影响论文结论）
- ✅ 本地验证可以充分确保逻辑正确性

---

## 5. 开发时间规划

### 5.1 本地开发阶段 (5-6天)

```
Day 1-2: 环境搭建 + Directory扩展 + 基础测试
  ├─ 安装依赖和环境配置 (2h)
  ├─ 修改Directory Server (2h)
  ├─ 开发Skyfield仿真器 (6h)
  └─ 基础功能测试 (2h)

Day 3-4: 功能扩展 + 脚本适配
  ├─ 实现路径指定功能 (3h)
  ├─ 适配测试脚本 (4h)
  ├─ 开发网络管理器 (4h)
  └─ 7节点启动测试 (2h)

Day 5: 集成测试
  ├─ 端到端集成 (3h)
  ├─ 小规模测试 (3h)
  └─ 调试和修复 (2h)

Day 6 (可选): 性能基准
  ├─ 100次测试运行 (2h)
  ├─ 数据分析和图表 (3h)
  └─ 文档整理 (1h)
```

### 5.2 飞腾派部署阶段 (1-2天)

```
Day 7: 移植和验证
  ├─ 代码同步到飞腾派 (0.5h)
  ├─ 编译和冒烟测试 (1h)
  ├─ 小规模测试 (2h)
  └─ 调试环境问题 (2h)

Day 8: 全量测试 (Week 2开始)
  └─ 按工作列表执行Phase 2测试
```

---

## 6. 风险与缓解

### 6.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| **本地验证通过，飞腾派失败** | 低 | 中 | 预留调试时间；分阶段移植 |
| **架构差异导致性能问题** | 中 | 低 | 性能差异在预期内；关注趋势非绝对值 |
| **Docker网络配置差异** | 低 | 低 | 使用相同的docker-compose配置 |
| **代码修改引入bug** | 中 | 中 | 保留完整测试用例；git版本控制 |

### 6.2 时间风险

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| **本地开发超时** | 中 | 高 | 设置6天硬截止；砍掉可选功能 |
| **移植遇到问题** | 中 | 中 | 预留2天缓冲时间 |
| **环境配置复杂** | 低 | 低 | 使用Docker统一环境 |

---

## 7. 推荐方案总结

### 7.1 核心建议

✅ **推荐开发路径**:

```
1. 本地x86环境开发 (5-6天)
   ├─ 修改必要代码 (~1250行)
   ├─ 完整功能验证
   └─ 性能趋势验证

2. 飞腾派移植 (1-2天)
   ├─ 代码同步和编译
   ├─ 冒烟测试
   └─ 环境调试

3. 飞腾派全量测试 (Week 2)
   └─ 按工作列表执行
```

### 7.2 为什么这样做

**优势**:
1. **降低风险**: 本地先验证，避免在硬件上浪费时间
2. **提高效率**: x86调试工具丰富，迭代速度快
3. **保护硬件**: 避免频繁重启和调试损耗飞腾派
4. **并行开发**: 可以同时准备飞腾派环境

**劣势**:
1. 需要两套环境（但成本低）
2. 性能数据需要两次测试（但本地仅供验证）

**权衡**: ✅ **优势远大于劣势**

---

## 8. 检查清单

### 8.1 开始前准备

- [ ] 本地x86环境准备就绪（Ubuntu 22.04 + Docker）
- [ ] 现有PQ-NTOR代码能正常编译和运行
- [ ] Git仓库已设置（或准备好代码同步方案）
- [ ] 飞腾派可SSH访问
- [ ] 确认时间安排（至少连续1周本地开发）

### 8.2 本地开发完成标准

- [ ] 7节点容器全部正常启动
- [ ] Skyfield仿真器稳定运行>1小时
- [ ] 客户端能指定任意3跳路径
- [ ] 至少完成10次端到端测试
- [ ] CSV数据格式正确
- [ ] 代码已提交到git

### 8.3 移植完成标准

- [ ] 飞腾派上编译成功
- [ ] 冒烟测试通过（1次测试）
- [ ] 小规模测试通过（10次测试）
- [ ] 性能趋势与本地一致
- [ ] 准备好进入Week 2全量测试

---

## 9. 代码改动详细清单

### 必须改动的文件 (P0)

```
修改文件清单:
┌────────────────────────────────────────────────────────────┐
│ 文件路径                                │ 改动量  │ 工作量 │
├────────────────────────────────────────────────────────────┤
│ c/src/directory_server.c               │  ~70行  │  2h   │
│ c/src/tor_client.c                     │ ~100行  │  3h   │
│ c/src/relay_node.c                     │  ~30行  │  1h   │
│ sagin-experiments/run_sagin_exp_v2.sh  │ ~200行  │  4h   │
│ sagin-experiments/sagin_orbit_sim.py   │ ~500行  │  6h   │
│ sagin-experiments/network_topo_mgr.py  │ ~300行  │  4h   │
│ sagin-experiments/sagin_topo_conf.json │ ~100行  │  1h   │
│ docker-compose-sagin.yml               │  ~80行  │  1h   │
├────────────────────────────────────────────────────────────┤
│ 总计 (P0)                               │~1380行  │ ~22h  │
└────────────────────────────────────────────────────────────┘
```

### 可选改动的文件 (P1)

```
可选文件清单:
┌────────────────────────────────────────────────────────────┐
│ 文件路径                                │ 改动量  │ 工作量 │
├────────────────────────────────────────────────────────────┤
│ c/src/logger.c (新建)                  │ ~200行  │  3h   │
│ c/src/performance_stats.c (新建)       │ ~150行  │  2h   │
│ sagin-experiments/topology_visual.py   │ ~200行  │  3h   │
├────────────────────────────────────────────────────────────┤
│ 总计 (P1)                               │ ~550行  │  ~8h  │
└────────────────────────────────────────────────────────────┘
```

---

## 10. 最终答案

### 问题1: 是否需要重构？

**答案**: ❌ **不需要重构**

**详细说明**:
- PQ-NTOR核心协议代码（~3000行）**完全不动**
- 仅需轻量级适配（~1250行新增/修改，占总量15%）
- 改动主要是配置、测试脚本和新增模块
- **核心功能零风险**

### 问题2: 能否先本地验证？

**答案**: ✅ **完全可行，且强烈推荐**

**详细说明**:
- Skyfield纯Python，跨平台无问题
- Docker配置通用
- 本地开发效率高3-5倍
- 逻辑验证充分后再移植
- 仅性能绝对值有差异（但趋势一致）

---

## 11. 立即行动建议

### 今天可以做的事（Day 0）

```bash
# 1. 在本地（Windows WSL2 或 Linux虚拟机）

# 安装基础环境
sudo apt update
sudo apt install build-essential python3-pip docker.io
pip3 install skyfield numpy matplotlib

# 2. 同步代码到本地
# (如果代码在飞腾派上)
scp -r feitian-pi:/home/ccc/pq-ntor-experiment ~/pq-ntor-local

# 或者
git clone <repo> ~/pq-ntor-local

# 3. 验证现有功能
cd ~/pq-ntor-local/c
make clean && make all
./test_network.sh

# 预期输出: ✓ All tests passed

# 4. 测试Skyfield基本功能
python3 << EOF
from skyfield.api import load, EarthSatellite
ts = load.timescale()
print("Skyfield OK!")
EOF

# 预期输出: Skyfield OK!
```

**时间**: 1-2小时

---

**评估完成日期**: 2025-11-12
**评估结论**:
- ❌ 不需要重构核心代码
- ✅ 仅需轻量级适配（~1250行，2-3天）
- ✅ 强烈推荐本地验证后移植
- 🎯 预计总开发时间: 5-8天（本地5-6天 + 移植1-2天）

---

**准备就绪，建议先在本地开发！** 🚀
