# 三跳电路构建性能测试报告

## 📋 测试概述

**测试日期**: 2025-11-30
**测试平台**: 飞腾派 (Phytium Pi) - ARM64架构
**测试算法**: PQ-NTOR (Kyber-512)
**测试环境**: 单机localhost测试（7π分布式测试的前置验证）
**测试程序**: `benchmark_3hop_circuit`

---

## 🎯 测试目标

验证完整的Tor三跳电路构建流程，包括：
1. 从目录服务器获取节点列表
2. 与Guard节点建立第一跳连接（PQ-NTOR握手）
3. 通过Guard扩展到Middle节点（第二跳）
4. 通过Guard+Middle扩展到Exit节点（第三跳）

---

## 📊 核心性能数据

### 总体性能

| 指标 | 数值 |
|------|------|
| **平均时间** | **1252.57 µs (1.25 ms)** |
| 中位数 | 1181.80 µs (1.18 ms) |
| 最小值 | 1163.14 µs (1.16 ms) |
| 最大值 | 1911.23 µs (1.91 ms) |
| 标准差 | 220.04 µs |
| **成功率** | **100%** |
| 迭代次数 | 10 |

### 分阶段性能分解

| 阶段 | 平均时间 (µs) | 占比 | 说明 |
|------|--------------|------|------|
| **目录获取** | **767.80** | **61.3%** | HTTP请求获取节点列表 |
| 第1跳 (Guard) | 163.74 | 13.1% | PQ-NTOR握手（Client→Guard） |
| 第2跳 (Middle) | 156.36 | 12.5% | 扩展握手（通过Guard） |
| 第3跳 (Exit) | 155.91 | 12.4% | 扩展握手（通过Guard+Middle） |
| **总计** | **1243.81** | **99.3%** | 四个阶段之和 |

*注：总计与平均时间的微小差异来自测量精度*

---

## 📈 关键发现

### 1. 网络开销占主导地位

- **网络开销**（目录获取）：767.80 µs（61.3%）
- **加密开销**（3次握手）：475.01 µs（38.0%）

**结论**：在本地测试中，网络往返延迟（HTTP请求）比加密计算耗时更多。在真实分布式网络中，这个比例会更加显著。

### 2. 单次握手性能对比

| 测试类型 | 平均时间 | 说明 |
|---------|---------|------|
| 单次PQ-NTOR握手 | 181.64 µs | 之前的握手测试 |
| 三跳电路（仅握手部分） | 475.01 µs | 3 × ~158 µs |
| 三跳电路（含网络） | 1252.57 µs | 完整电路构建 |

**倍数关系**：
- 三跳握手总时间 ≈ 2.6× 单次握手
- 完整电路构建 ≈ 6.9× 单次握手

### 3. 三跳握手的一致性

三个握手阶段的时间非常接近：
- Hop 1: 163.74 µs
- Hop 2: 156.36 µs
- Hop 3: 155.91 µs

**标准差**: ~4 µs（相对标准差 < 3%）

**结论**：PQ-NTOR握手性能在多跳场景下保持稳定，没有明显的性能退化。

---

## 🔬 与文献对比

### Classic NTOR (X25519)

根据Tor官方文档，Classic NTOR单次握手：
- 客户端计算: ~20-30 µs (X86)
- 服务器计算: ~20-30 µs (X86)
- **总计**: ~40-60 µs

### PQ-NTOR (Kyber-512) - 本测试

- 单次握手: **181.64 µs** (ARM64)
- **开销**: 3-4.5× Classic NTOR

### 预期值

根据之前的12拓扑测试，飞腾派上：
- PQ-NTOR握手: ~180 µs ✅（与本测试一致）
- 三跳电路（无网络延迟）: 预期 ~540 µs
- 三跳电路（本测试，含目录）: **1252.57 µs** ✅

---

## 📉 性能瓶颈分析

### 当前瓶颈排序

1. **目录服务器HTTP请求** (61.3%)
   - 可优化：使用缓存、gRPC、本地副本

2. **第一跳握手** (13.1%)
   - PQ-NTOR加密计算
   - ARM处理器性能限制

3. **第二跳/第三跳握手** (各12.5%)
   - 洋葱路由加密层开销
   - 增量不大，说明洋葱加密效率高

### 优化建议

| 优化方向 | 预期收益 | 实现难度 |
|---------|---------|---------|
| 目录缓存 | 减少50-70%目录开销 | 低 |
| 使用Kyber768替代Kyber512 | 增加~20%握手时间 | 低 |
| 并行化处理 | 减少20-30%总时间 | 中 |
| 硬件加速 (NEON) | 减少30-40%握手时间 | 高 |

---

## 🎨 可视化图表

已生成以下发表级别图表（PNG + PDF）：

### 图1：阶段分解（饼图+柱状图）
**文件**: `figure_3hop_stage_breakdown.png/.pdf`

展示三跳电路各阶段的时间占比和绝对时间。

**关键洞察**：目录获取占据61.3%的时间，是主要瓶颈。

---

### 图2：握手 vs 电路对比
**文件**: `figure_handshake_vs_circuit.png/.pdf`

对比单次握手、完整电路、仅握手部分的性能。

**关键洞察**：完整电路是单次握手的6.9倍，但仅握手部分只有2.6倍，说明网络开销占主导。

---

### 图3：延迟分布箱线图
**文件**: `figure_latency_distribution.png/.pdf`

展示各阶段的延迟分布、中位数、四分位距。

**关键洞察**：握手阶段延迟分布集中，方差小；目录获取方差较大。

---

### 图4：网络 vs 加密开销
**文件**: `figure_overhead_analysis.png/.pdf`

对比网络开销（目录）和加密开销（3次握手）。

**关键洞察**：
- 网络开销: 61.3% (767.80 µs)
- 加密开销: 38.0% (475.01 µs)

---

### 图5：综合性能汇总表
**文件**: `figure_performance_summary.png/.pdf`

完整的性能数据表格，包括：
- 单次握手 vs 三跳电路对比
- 各阶段详细时间和占比
- 统计指标（均值、中位数、方差等）

---

## 🚀 下一步工作

### 1. 7π分布式测试（下一阶段）

完成单飞腾派验证后，部署到7台飞腾派：

| 节点 | IP | 角色 | 说明 |
|------|-------|------|------|
| Pi #1 | 192.168.5.110 | Client | 运行测试客户端 |
| Pi #2 | 192.168.5.111 | Directory | 目录服务器 |
| Pi #3 | 192.168.5.112 | Guard | 入口节点 |
| Pi #4 | 192.168.5.113 | Middle | 中间节点 |
| Pi #5 | 192.168.5.114 | Exit | 出口节点 |
| Pi #6 | 192.168.5.115 | Target | HTTP目标服务器 |
| Pi #7 | 192.168.5.116 | Monitor | 监控节点 |

**预期结果**：
- 真实网络延迟（LAN内 ~0.1-0.5 ms）
- 完整电路构建时间：预计 **2-5 ms**
- 可测试12种SAGIN拓扑（TC网络参数模拟）

### 2. 12拓扑对比测试

使用TC模拟不同网络环境：

| 拓扑 | 延迟 | 带宽 | 丢包率 | 场景 |
|------|------|------|--------|------|
| LEO卫星上行 | 20ms | 100Mbps | 0.1% | 地面→卫星 |
| LEO卫星下行 | 20ms | 100Mbps | 0.1% | 卫星→地面 |
| GEO卫星上行 | 250ms | 50Mbps | 0.5% | 地面→高轨卫星 |
| ... | ... | ... | ... | ... |

**目标**：生成类似之前12拓扑握手测试的完整性能数据。

### 3. 完整端到端流量测试

- 通过三跳电路发送真实HTTP请求
- 测量端到端延迟（包括数据传输）
- 验证洋葱加密的正确性

---

## ✅ 测试结论

### 单机验证成功

1. ✅ **编译通过**：所有组件在飞腾派上成功编译
2. ✅ **功能验证**：三跳电路构建100%成功
3. ✅ **性能合理**：握手性能与之前测试一致（~180 µs）
4. ✅ **数据完整**：获得完整的性能分解数据

### 关键性能指标

- **完整电路构建**: 1.25 ms（单机localhost）
- **PQ-NTOR握手**: 158-164 µs/hop（稳定）
- **网络开销占比**: 61.3%（主要瓶颈）
- **成功率**: 100%

### 系统就绪状态

**✅ 可以制作SD卡镜像，准备7π分布式部署**

---

## 📚 附录

### A. 测试环境详情

```
系统: Linux Phytium-Pi 5.10.209-phytium-embedded-v2.2
架构: aarch64 (ARM64)
编译器: gcc 9.4.0
liboqs: 自编译版本（支持Kyber-512/768/1024）
Python: 3.8+
```

### B. 测试命令

```bash
# 编译
cd ~/pq-ntor-experiment/c
make all

# 运行三跳测试
cd ~/pq-ntor-experiment/last_experiment/phytium_deployment
./benchmark_3hop_circuit 10 localhost 5000

# 生成可视化
cd ~/pq-ntor-experiment
python3 visualize_3hop.py
```

### C. 原始测试输出

```
=== PQ-NTOR 3-Hop Circuit Construction Benchmark ===
Directory: localhost:5000
Iterations: 10
Protocol: PQ-NTOR (Kyber-512)

Running benchmark...
  Progress: 10/10

Completed: 10/10 successful

=== RESULTS ===

Total Circuit Construction Time:
  Average:  1252.57 µs (1.25 ms)
  Median:   1181.80 µs (1.18 ms)
  Min:      1163.14 µs (1.16 ms)
  Max:      1911.23 µs (1.91 ms)
  StdDev:   220.04 µs

Breakdown by Stage:
  Directory Fetch:  767.80 µs (61.3%)
  Hop 1 (Guard):    163.74 µs (13.1%)
  Hop 2 (Middle):   156.36 µs (12.5%)
  Hop 3 (Exit):     155.91 µs (12.4%)

=== JSON OUTPUT ===
{
  "total_us": 1252.57,
  "total_ms": 1.25,
  "median_us": 1181.80,
  "min_us": 1163.14,
  "max_us": 1911.23,
  "stddev_us": 220.04,
  "directory_us": 767.80,
  "hop1_us": 163.74,
  "hop2_us": 156.36,
  "hop3_us": 155.91,
  "success_rate": 100.00
}
```

---

**版本**: v1.0
**作者**: PQ-NTOR实验团队
**日期**: 2025-11-30
**状态**: ✅ 单机验证完成，准备7π分布式测试
