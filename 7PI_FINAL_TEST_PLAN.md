# 7π分布式最终测试方案

## 🎯 测试目标

基于单飞腾派验证成功，扩展到7台飞腾派，进行**完整的SAGIN网络PQ-NTOR性能测试**，并与权威文献数据对比。

---

## 📊 与权威数据对比框架

### 对比维度

| 维度 | 文献数据 | 我们的测试 | 创新点 |
|------|---------|----------|--------|
| **平台** | X86 Intel | **ARM64 飞腾派** | 首次ARM64评测 |
| **场景** | 标准网络 | **SAGIN拓扑** | 特殊网络环境 |
| **测试** | 握手性能 | **握手+电路+端到端** | 完整系统 |
| **规模** | 单机仿真 | **7π分布式** | 真实部署 |

### 核心对比指标

#### 1. 握手性能对比

| 算法 | 文献值 (X86) | 推算值 (ARM) | 实测值 (飞腾派) | 对比 |
|------|-------------|-------------|----------------|------|
| **Classic NTOR** | 20-150 µs | 40-60 µs | *引用文献* | - |
| **PQ-NTOR** | 100-650 µs | 150-200 µs | **181.64 µs** | ✅优于预期 |
| **开销倍数** | 2-6× | 3-5× | **3.0-4.5×** | ✅合理 |

#### 2. 三跳电路对比

| 指标 | 文献值 | 实测值 (单机) | 实测值 (7π) | 说明 |
|------|-------|--------------|------------|------|
| 电路构建时间 | 15-20 ms/hop | 1.25 ms | **待测** | 7π含真实网络 |
| 目录获取 | - | 767.80 µs | **待测** | HTTP |
| 三跳总时间 | - | 1252.57 µs | **待测** | 完整流程 |

#### 3. SAGIN拓扑性能

**12拓扑分组对比**：

| 拓扑组 | 延迟范围 | 带宽 | 文献参考 | 测试目标 |
|--------|---------|------|---------|---------|
| **LEO卫星** | 20ms | 100Mbps | - | 测试中延迟影响 |
| **GEO卫星** | 250ms | 50Mbps | - | 测试高延迟影响 |
| **UAV** | 5-10ms | 50-100Mbps | - | 测试移动场景 |
| **D2D** | 1-5ms | 10-100Mbps | - | 测试低速链路 |

---

## 🏗️ 7π系统架构

### 节点配置

```
192.168.5.110 - Pi #1 - Client    (运行测试客户端)
192.168.5.111 - Pi #2 - Directory (目录服务器)
192.168.5.112 - Pi #3 - Guard     (入口节点)
192.168.5.113 - Pi #4 - Middle    (中间节点)
192.168.5.114 - Pi #5 - Exit      (出口节点)
192.168.5.115 - Pi #6 - Target    (HTTP目标服务器)
192.168.5.116 - Pi #7 - Monitor   (监控与数据收集)
```

### 网络拓扑

```
┌─────────┐
│ Client  │ (Pi #1)
│ .110    │
└────┬────┘
     │ 获取节点列表
     ▼
┌─────────┐
│Directory│ (Pi #2)
│ .111    │
└─────────┘

     ┌─── Hop 1 ───┐
     │              │
┌────▼────┐    ┌────────┐    ┌────────┐
│ Guard   │───▶│ Middle │───▶│  Exit  │
│ .112    │    │ .113   │    │ .114   │
└─────────┘    └─────────┘    └────┬───┘
                                    │
                               ┌────▼────┐
                               │ Target  │
                               │ .115    │
                               └─────────┘

┌─────────┐
│ Monitor │ (Pi #7)
│ .116    │ (收集所有节点性能数据)
└─────────┘
```

---

## 🧪 测试方案

### 阶段1：基础功能验证（30分钟）

**目标**: 验证7π系统基本功能

**测试项**:
1. ✅ 所有节点网络连通性
2. ✅ Directory服务器正常工作
3. ✅ 3个Relay节点注册成功
4. ✅ 单次三跳电路构建成功
5. ✅ 端到端HTTP请求成功

**成功标准**:
- 所有节点ping通
- Directory返回完整节点列表
- 电路构建成功率 > 95%

---

### 阶段2：基准性能测试（1小时）

**目标**: 测量无TC配置的基准性能

#### 测试2.1: 握手性能

```bash
# 在Pi #3上运行
cd ~/pq-ntor-experiment/c
./benchmark_pq_ntor 1000 > baseline_handshake.log
```

**预期结果**:
- 平均握手时间: ~180 µs
- 与单机测试一致

#### 测试2.2: 三跳电路（LAN环境）

```bash
# 在Pi #1上运行
cd ~/pq-ntor-experiment/last_experiment/phytium_deployment
./benchmark_3hop_circuit 100 192.168.5.111 5000 > baseline_3hop.log
```

**预期结果**:
- 电路构建时间: 2-5 ms (含真实网络延迟)
- 目录获取: 0.5-1 ms
- 每跳握手: ~180 µs

#### 测试2.3: 端到端HTTP

```bash
# 测试完整数据传输
./test_http_through_circuit.sh > baseline_http.log
```

---

### 阶段3：12拓扑SAGIN测试（4小时）

**目标**: 模拟12种SAGIN网络环境，测试PQ-NTOR性能

#### 拓扑配置自动化

```bash
cd ~/pq-ntor-experiment/scripts
./configure_tc_all_nodes.sh <topology_id>
```

#### 测试矩阵

| 拓扑ID | 场景 | 延迟 | 带宽 | 丢包率 | 测试次数 |
|--------|------|------|------|--------|---------|
| 1 | LEO上行 | 20ms | 100Mbps | 0.1% | 100 |
| 2 | LEO下行 | 20ms | 100Mbps | 0.1% | 100 |
| 3 | GEO上行 | 250ms | 50Mbps | 0.5% | 100 |
| 4 | GEO下行 | 250ms | 50Mbps | 0.5% | 100 |
| 5 | UAV高速 | 5ms | 100Mbps | 0.2% | 100 |
| 6 | UAV低速 | 10ms | 50Mbps | 0.5% | 100 |
| 7 | D2D近距 | 1ms | 100Mbps | 0.1% | 100 |
| 8 | D2D远距 | 5ms | 10Mbps | 1.0% | 100 |
| 9 | 混合1 | 变化 | 变化 | 0.3% | 100 |
| 10 | 混合2 | 变化 | 变化 | 0.5% | 100 |
| 11 | 极端高延 | 500ms | 10Mbps | 2.0% | 100 |
| 12 | 极端低带 | 50ms | 1Mbps | 1.0% | 100 |

#### 自动化测试脚本

```python
# test_12topo_7pi.py
for topo_id in range(1, 13):
    # 配置TC
    configure_topology(topo_id)

    # 运行测试
    results = run_circuit_test(iterations=100)

    # 保存结果
    save_results(topo_id, results)

    # 清理TC
    cleanup_tc()
```

---

### 阶段4：压力测试（2小时）

**目标**: 测试系统稳定性和极限性能

#### 测试4.1: 高并发

```bash
# 同时建立100条电路
./test_concurrent_circuits.sh 100
```

#### 测试4.2: 长时间运行

```bash
# 持续运行2小时
./test_continuous_operation.sh 7200
```

#### 测试4.3: 故障恢复

```bash
# 模拟节点故障
./test_node_failure_recovery.sh
```

---

## 📈 数据收集与分析

### 收集的数据

**每次测试记录**:
```json
{
  "topology_id": 1,
  "test_id": "test_001",
  "timestamp": "2025-11-30T15:00:00",
  "network_params": {
    "delay_ms": 20,
    "bandwidth_mbps": 100,
    "loss_percent": 0.1
  },
  "performance": {
    "directory_fetch_us": 1234.56,
    "hop1_us": 181.23,
    "hop2_us": 182.45,
    "hop3_us": 179.89,
    "total_circuit_us": 2500.12,
    "http_request_ms": 150.34
  },
  "success": true
}
```

### 统计分析

**对每个拓扑计算**:
- 平均值 (µs)
- 中位数 (µs)
- 最小/最大值 (µs)
- 标准差 (µs)
- 成功率 (%)
- 99分位延迟 (µs)

---

## 📊 结果可视化

### 生成的图表

#### 图1: 12拓扑性能对比

```
横轴: 12种拓扑
纵轴: 电路构建时间 (ms)
对比: 握手时间 vs 网络延迟 vs 总时间
```

#### 图2: 延迟分解图

```
堆叠柱状图:
- 目录获取时间
- Hop1握手时间
- Hop2握手时间
- Hop3握手时间
- 网络传输时间
```

#### 图3: 与文献对比

```
分组柱状图:
- 文献值 (X86)
- 推算值 (ARM)
- 实测值 (7π)
对比项: Classic vs PQ-NTOR
```

#### 图4: SAGIN拓扑热图

```
热图:
横轴: 网络延迟
纵轴: 带宽
颜色: 电路构建时间
```

#### 图5: 性能影响因素分析

```
散点图 + 回归线:
- 延迟 vs 电路时间
- 带宽 vs 吞吐量
- 丢包率 vs 成功率
```

---

## 🎯 与文献对比的关键论点

### 论点1: ARM64性能优势

**文献**:
- X86: PQ-NTOR ~100-650 µs
- ARM Cortex-M4: ~70-80 ms

**我们**:
- 飞腾派ARM64: **181.64 µs**

**结论**: ARM64在PQC性能上接近X86，远超低端ARM ✅

### 论点2: SAGIN环境适用性

**文献**: 标准网络环境测试

**我们**: 12种SAGIN拓扑全覆盖

**结论**: PQ-NTOR在SAGIN网络中可行 ✅

### 论点3: 实际部署验证

**文献**: 仿真或单机测试

**我们**: 7π真实分布式部署

**结论**: 工程可行性验证 ✅

---

## ⏱️ 时间规划

| 阶段 | 时间 | 输出 |
|------|------|------|
| **镜像制作** | 2小时 | SD卡镜像 |
| **7π部署** | 2小时 | 系统就绪 |
| **基础验证** | 30分钟 | 功能确认 |
| **基准测试** | 1小时 | 基准数据 |
| **12拓扑测试** | 4小时 | 完整数据 |
| **压力测试** | 2小时 | 稳定性数据 |
| **数据分析** | 2小时 | 图表+报告 |
| **总计** | **13.5小时** | **2天完成** |

---

## ✅ 成功标准

### 系统层面

- [ ] 7台Pi全部正常工作
- [ ] 网络互联无障碍
- [ ] TC配置正确生效
- [ ] 所有程序编译成功

### 功能层面

- [ ] 三跳电路成功率 > 95%
- [ ] 12拓扑全部测试完成
- [ ] 数据收集完整无缺失
- [ ] 故障恢复机制有效

### 性能层面

- [ ] PQ-NTOR握手 < 200 µs
- [ ] 电路构建时间合理（随拓扑变化）
- [ ] 端到端性能可接受
- [ ] 与文献数据可对比

### 论文层面

- [ ] 数据支持核心论点
- [ ] 对比具有说服力
- [ ] 可视化图表专业
- [ ] 创新点清晰明确

---

## 🚀 下一步行动

### 立即执行

1. **完成单Pi镜像准备**
   ```bash
   ssh user@192.168.5.110
   # 清理系统
   # 关机制作镜像
   ```

2. **烧录6张SD卡**
   ```bash
   sudo dd if=phytium-pi-base.img of=/dev/sdX bs=4M
   ```

3. **配置7台Pi**
   ```bash
   # 每台Pi执行
   sudo ./setup_node.sh <1-7>
   ```

4. **开始测试**
   ```bash
   ./run_7pi_full_test.sh
   ```

---

**版本**: v1.0
**日期**: 2025-11-30
**状态**: 方案设计完成，等待7π硬件就绪
**预计完成**: 2天内
